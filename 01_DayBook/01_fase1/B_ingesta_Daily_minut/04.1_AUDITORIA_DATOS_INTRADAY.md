# 📊 AUDITORÍA COMPLETA DE DATOS INTRADÍA - POLYGON API

**Fecha**: 2025-10-21
**Universo**: 3,107 tickers (XNAS/XNYS, market cap < $2B)
**Período**: 2004-01-01 → 2025-10-21 (3 ventanas)
**Estado**: FALLO CATASTRÓFICO (93.9% de datos faltantes)

---

## 🚀 CÓMO REPRODUCIR ESTA AUDITORÍA (COMANDOS EXACTOS)

### **OPCIÓN 1: Ejecución Rápida (Recomendada)**

Si ya tienes los scripts de auditoría, ejecuta directamente:

```bash
# Paso 1: Auditar completitud de datos
python tools/audit_intraday_completeness.py \
  --universe processed/universe/cs_xnas_xnys_under2b_2025-10-21.csv \
  --datadir raw/polygon/ohlcv_intraday_1m \
  --windows 2004-01-01:2010-12-31,2011-01-01:2016-12-31,2017-01-01:2025-10-21 \
  --outdir audit_reports/intraday_1m_2025-10-21

# Paso 2: Analizar tickers 100% completos
python tools/analyze_complete_tickers.py \
  --coverage-json audit_reports/intraday_1m_2025-10-21/window_coverage.json \
  --metadata-json audit_reports/intraday_1m_2025-10-21/ticker_metadata.json \
  --datadir raw/polygon/ohlcv_intraday_1m \
  --outdir audit_reports/complete_tickers_analysis
```

**Duración**: ~20-30 segundos total

**Resultados**:
- `audit_reports/intraday_1m_2025-10-21/` → Reportes de completitud
- `audit_reports/complete_tickers_analysis/` → Análisis de tickers 100%

---

### **OPCIÓN 2: Verificación Manual (Sin scripts)**

Si no tienes los scripts o quieres verificar manualmente:

```bash
# 1. Contar archivos descargados
find raw/polygon/ohlcv_intraday_1m -type f -name "minute.parquet" | wc -l

# 2. Contar carpetas de tickers
ls -d raw/polygon/ohlcv_intraday_1m/*/ 2>/dev/null | wc -l

# 3. Verificar universo esperado
wc -l processed/universe/cs_xnas_xnys_under2b_2025-10-21.csv

# 4. Ver ejemplo de datos de un ticker
ls -lR raw/polygon/ohlcv_intraday_1m/AAPL/ 2>/dev/null || echo "AAPL no descargado"

# 5. Leer archivo parquet de ejemplo (con Python)
python -c "
import polars as pl
from pathlib import Path
# Buscar primer archivo parquet
p = next(Path('raw/polygon/ohlcv_intraday_1m').rglob('minute.parquet'), None)
if p:
    df = pl.read_parquet(p)
    print(f'Archivo: {p}')
    print(f'Rows: {df.height}')
    print(f'Columnas: {df.columns}')
    print(df.head())
else:
    print('No se encontraron archivos parquet')
"
```

---

## 📂 ARCHIVOS Y SCRIPTS PARA REPRODUCIR ESTE ESTUDIO

### **Scripts de Auditoría Creados**

#### 1. **`tools/audit_intraday_completeness.py`**
Script principal para auditar la completitud de datos descargados.

**Ubicación**: `D:\04_TRADING_SMALLCAPS\tools\audit_intraday_completeness.py`

**Qué hace**:
- Compara tickers descargados vs universo esperado
- Calcula cobertura temporal por ventana
- Detecta archivos corruptos y vacíos
- Genera reportes detallados de completitud
- Identifica gaps en los datos

**Uso**:
```bash
python tools/audit_intraday_completeness.py \
  --universe processed/universe/cs_xnas_xnys_under2b_2025-10-21.csv \
  --datadir raw/polygon/ohlcv_intraday_1m \
  --windows 2004-01-01:2010-12-31,2011-01-01:2016-12-31,2017-01-01:2025-10-21 \
  --outdir audit_reports/intraday_1m_2025-10-21
```

**Salidas generadas**:
- `missing_tickers.txt` - Lista de tickers sin datos
- `downloaded_tickers.txt` - Lista de tickers con datos
- `completeness_summary.csv` - Resumen completo por ticker
- `window_coverage.json` - Cobertura detallada por ventana
- `ticker_metadata.json` - Metadatos completos
- `download_priority.csv` - Prioridades de descarga

---

#### 2. **`tools/analyze_complete_tickers.py`**
Script para análisis profundo de tickers con 100% de cobertura.

**Ubicación**: `D:\04_TRADING_SMALLCAPS\tools\analyze_complete_tickers.py`

**Qué hace**:
- Identifica tickers con cobertura 100% en cada ventana
- Análisis de calidad de datos (gaps, duplicados, continuidad)
- Estadísticas de trading (volumen, trades, minutos/día)
- Comparación de tickers completos vs parciales

**Uso**:
```bash
python tools/analyze_complete_tickers.py \
  --coverage-json audit_reports/intraday_1m_2025-10-21/window_coverage.json \
  --metadata-json audit_reports/intraday_1m_2025-10-21/ticker_metadata.json \
  --datadir raw/polygon/ohlcv_intraday_1m \
  --outdir audit_reports/complete_tickers_analysis
```

**Salidas generadas**:
- `complete_ALL_windows.txt` - Tickers completos en todas las ventanas
- `complete_TWO_windows.txt` - Tickers completos en 2 ventanas
- `complete_100pct_[ventana].txt` - Tickers completos por ventana
- `complete_tickers_summary.csv` - Resumen con métricas de calidad
- `quality_analysis.json` - Análisis detallado de calidad
- `completeness_breakdown.txt` - Desglose completo por ticker

---

### **Proceso Completo para Reproducir el Estudio**

#### **Paso 1: Ejecutar auditoría de completitud**

```bash
cd D:\04_TRADING_SMALLCAPS

python tools/audit_intraday_completeness.py \
  --universe processed/universe/cs_xnas_xnys_under2b_2025-10-21.csv \
  --datadir raw/polygon/ohlcv_intraday_1m \
  --windows 2004-01-01:2010-12-31,2011-01-01:2016-12-31,2017-01-01:2025-10-21 \
  --outdir audit_reports/intraday_1m_2025-10-21
```

**Duración aproximada**: 10-20 segundos

---

#### **Paso 2: Analizar tickers 100% completos**

```bash
python tools/analyze_complete_tickers.py \
  --coverage-json audit_reports/intraday_1m_2025-10-21/window_coverage.json \
  --metadata-json audit_reports/intraday_1m_2025-10-21/ticker_metadata.json \
  --datadir raw/polygon/ohlcv_intraday_1m \
  --outdir audit_reports/complete_tickers_analysis
```

**Duración aproximada**: 5-10 segundos

---

#### **Paso 3: Revisar reportes generados**

**Ubicaciones**:
```
audit_reports/
├── intraday_1m_2025-10-21/
│   ├── completeness_summary.csv          ← Resumen general
│   ├── window_coverage.json              ← Cobertura por ventana
│   ├── missing_tickers.txt               ← 2,917 tickers faltantes
│   ├── downloaded_tickers.txt            ← 190 tickers descargados
│   ├── download_priority.csv             ← Prioridades
│   └── ticker_metadata.json              ← Metadatos detallados
│
└── complete_tickers_analysis/
    ├── complete_tickers_summary.csv      ← Métricas de calidad
    ├── complete_ALL_windows.txt          ← 1 ticker (HIFS)
    ├── complete_TWO_windows.txt          ← 4 tickers
    ├── complete_100pct_*.txt             ← Por ventana
    ├── quality_analysis.json             ← Análisis detallado
    └── completeness_breakdown.txt        ← Desglose completo
```

---

## 🔴 RESULTADOS DE LA AUDITORÍA

### **RESUMEN GLOBAL**

```
╔══════════════════════════════════════════════════════════════╗
║                    ESTADO GLOBAL                             ║
╠══════════════════════════════════════════════════════════════╣
║ Universo esperado:           3,107 tickers                   ║
║ Tickers descargados:           190 tickers (6.1%) ✓         ║
║ Tickers FALTANTES:           2,917 tickers (93.9%) ❌        ║
╠══════════════════════════════════════════════════════════════╣
║ Datos descargados:         5,077,348 rows                    ║
║ Archivos parquet:              7,550 archivos                ║
║ Archivos corruptos:                4 tickers ⚠️              ║
╚══════════════════════════════════════════════════════════════╝
```

**VEREDICTO**: 🚨 **FALLO CATASTRÓFICO** - Solo 6.1% de datos descargados

---

### **COBERTURA POR VENTANA TEMPORAL**

#### **Ventana 1: 2004-01-01 → 2010-12-31** (84 meses esperados)
```
De los 190 tickers descargados:
  ✓ Cobertura 100%:      29 tickers (15.3%)
  ⚠️ Cobertura parcial:  124 tickers (65.3%)
  ❌ Sin datos:          37 tickers (19.5%)
```

#### **Ventana 2: 2011-01-01 → 2016-12-31** (72 meses esperados)
```
De los 190 tickers descargados:
  ✓ Cobertura 100%:      12 tickers (6.3%)
  ⚠️ Cobertura parcial:   22 tickers (11.6%)
  ❌ Sin datos:         156 tickers (82.1%) ← CRÍTICO
```

#### **Ventana 3: 2017-01-01 → 2025-10-21** (106 meses esperados)
```
De los 190 tickers descargados:
  ✓ Cobertura 100%:       2 tickers (1.1%) ← CATASTRÓFICO
  ⚠️ Cobertura parcial:   15 tickers (7.9%)
  ❌ Sin datos:         173 tickers (91.1%) ← CRÍTICO
```

**CONCLUSIÓN**: La descarga reciente (ventana 3) fue un **FALLO TOTAL**.

---

### **ARCHIVOS CORRUPTOS**

4 tickers con archivos parquet corruptos:

| Ticker | Rows | Archivos | Rango temporal | Estado |
|--------|------|----------|----------------|--------|
| **IPI** | 47,148 | 27 (1 corrupto) | 2004-2008 | ⚠️ Error lectura parquet |
| **LIND** | 19,116 | 10 (1 corrupto) | 2015-2016 | ⚠️ Error lectura parquet |
| **NCI** | 43,674 | 10 (1 corrupto) | 2004 | ⚠️ Error lectura parquet |
| **PETS** | 46,777 | 17 (1 corrupto) | 2004-2005 | ⚠️ Error lectura parquet |

---

## 🏆 ANÁLISIS DE TICKERS 100% COMPLETOS

### **DISTRIBUCIÓN DE COMPLETITUD**

```
╔════════════════════════════════════════════════════════════════════╗
║         TICKERS CON COBERTURA 100% (37 tickers totales)           ║
╠════════════════════════════════════════════════════════════════════╣
║ ✓ Completos en TODAS las ventanas (3):           1 ticker         ║
║ ⚠️ Completos en DOS ventanas:                     4 tickers        ║
║ ⚠️ Completos en UNA ventana:                     32 tickers        ║
╠════════════════════════════════════════════════════════════════════╣
║ Total rows:                                  862,816               ║
║ Promedio rows/ticker:                         23,319               ║
║ Promedio días únicos/ticker:                  1,734               ║
║ Promedio minutos trading/día:                  12.7 ⚠️             ║
╚════════════════════════════════════════════════════════════════════╝
```

⚠️ **ALERTA**: Promedio 12.7 minutos/día es **MUY BAJO**
(Día completo de trading = 390 minutos, 9:30-16:00)
→ Estos son tickers **poco líquidos** con actividad sparse

---

### **🥇 EL ÚNICO CAMPEÓN: HIFS**

**HIFS** es el **ÚNICO ticker** con 100% de cobertura en las **3 ventanas**:

```
╔══════════════════════════════════════════════════════════════╗
║                         HIFS                                 ║
╠══════════════════════════════════════════════════════════════╣
║ Ventanas completas:    TODAS (2004-2010, 2011-2016, 2017-2025) ║
║ Total rows:            43,815                                ║
║ Días únicos:           4,426 días (12.1 años de trading)    ║
║ Rango temporal:        2004-01-05 → 2025-10-21              ║
║ Total trades:          668,085 trades                        ║
║ Volumen total:         19,412,844                            ║
║ Promedio mins/día:     9.9 minutos ⚠️                         ║
║ Gaps detectados:       41 gaps (>7 días) ⚠️                   ║
╚══════════════════════════════════════════════════════════════╝

⚠️  PROBLEMAS:
  • Solo 9.9 minutos/día → Ticker poco líquido
  • 41 gaps grandes → Períodos sin trading

✅  FORTALEZAS:
  • Único con cobertura completa 2004-2025
  • 668,085 trades totales → Actividad consistente a largo plazo
```

---

### **🥈 TOP 4 TICKERS: 2 VENTANAS COMPLETAS**

#### **1. UBFO** ⭐⭐⭐⭐⭐ (El más consistente)
```
Ventanas:     2004-2010, 2011-2016
Rows:         58,588 (2do más alto)
Días:         3,143
Trades:       146,217
Mins/día:     18.6 (mejor que promedio)
Gaps:         0 ✅ (PERFECTO - sin gaps)
Volumen:      38,656,181
Precio rango: $10.50 - $35.20
```
**Veredicto**: ⭐⭐⭐⭐⭐ El mejor ticker en términos de consistencia

---

#### **2. PDEX** ⭐⭐⭐⭐
```
Ventanas:     2004-2010, 2011-2016
Rows:         44,105
Días:         3,131
Trades:       150,042 (más que UBFO)
Mins/día:     14.1
Gaps:         1 (casi perfecto)
Volumen:      44,557,815
```
**Veredicto**: Excelente, muy similar a UBFO

---

#### **3. NATH** ⭐⭐⭐⭐⭐ (El de más datos)
```
Ventanas:     2004-2010, 2017-2025 (skip 2011-2016) 🤔
Rows:         70,083 ← MÁS ALTO DE TODOS
Días:         3,941 (10.8 años)
Trades:       487,949 ← 2do MÁS ALTO
Mins/día:     17.8
Gaps:         1 (casi perfecto)
Volumen:      36,185,951
```
**Veredicto**: ⭐⭐⭐⭐⭐ Más volumen de datos, excelente calidad
**Pregunta abierta**: ¿Por qué tiene ventanas 1 y 3 pero no la 2?

---

#### **4. GCBC** ⭐⭐
```
Ventanas:     2004-2010, 2011-2016
Rows:         8,590 (bajo)
Días:         2,068
Trades:       18,991
Mins/día:     4.2 ⚠️ (muy bajo)
Gaps:         39 ⚠️ (muchos gaps)
Volumen:      11,420,512
```
**Veredicto**: Cobertura 100% pero calidad baja

---

### **📈 TOP 10 TICKERS POR VOLUMEN DE DATOS**

| Rank | Ticker | Windows | Rows | Días | Mins/día | Trades | Gaps | Calidad |
|------|--------|---------|------|------|----------|--------|------|---------|
| 1 | **NATH** | 2 | 70,083 | 3,941 | 17.8 | 487,949 | 1 | ⭐⭐⭐⭐⭐ |
| 2 | **UBFO** | 2 | 58,588 | 3,143 | 18.6 | 146,217 | 0 | ⭐⭐⭐⭐⭐ |
| 3 | **UMH** | 1 | 50,000 | 1,746 | 28.6 | 101,894 | 0 | ⭐⭐⭐⭐ |
| 4 | **LAKE** | 1 | 45,824 | 1,753 | 26.1 | 113,749 | 0 | ⭐⭐⭐⭐ |
| 5 | **PDEX** | 2 | 44,105 | 3,131 | 14.1 | 150,042 | 1 | ⭐⭐⭐⭐ |
| 6 | **HIFS** | 3 | 43,815 | 4,426 | 9.9 | 668,085 | 41 | ⭐⭐⭐⭐ |
| 7 | **CTO** | 1 | 42,701 | 1,509 | 28.3 | 127,974 | 0 | ⭐⭐⭐⭐ |
| 8 | **HTB** | 1 | 36,197 | 1,760 | 20.6 | 77,749 | 0 | ⭐⭐⭐⭐ |
| 9 | **VLGEA** | 1 | 34,632 | 1,615 | 21.4 | 68,238 | 2 | ⭐⭐⭐ |
| 10 | **WLFC** | 1 | 34,180 | 1,700 | 20.1 | 82,903 | 1 | ⭐⭐⭐⭐ |

---

### **📉 TICKERS CON MÁS PROBLEMAS**

#### **PBHC** - El peor de todos ⭐
```
Rows:         1,581 (mínimo absoluto)
Días:         656 (menos de 2 años de 7 esperados)
Mins/día:     2.4 ⚠️⚠️⚠️ (EXTREMADAMENTE BAJO)
Gaps:         81 ⚠️⚠️⚠️ (MÁS GAPS DE TODOS)
Trades:       2,682
Volumen:      899,813
```
**Problema**: Aunque clasificado como "100% cobertura" en ventana 2004-2010, los datos son **extremadamente sparse** e inútiles para análisis serio.

---

#### **DJCO** - 78 gaps ⭐
```
Rows:         2,413
Días:         701 (menos de 2 años)
Mins/día:     3.4 ⚠️⚠️
Gaps:         78 ⚠️⚠️⚠️
```
**Problema**: Datos extremadamente fragmentados

---

#### **FCAP** - 66 gaps ⭐⭐
```
Rows:         5,595
Días:         1,751
Mins/día:     3.2 ⚠️⚠️
Gaps:         66 ⚠️⚠️
```

---

### **🔍 ANÁLISIS DE LIQUIDEZ**

**Distribución de minutos promedio por día**:

```
Día completo de trading: ~390 minutos (9:30-16:00 EST)
Promedio de estos 37 tickers: 12.7 minutos (3.3% del día)

Distribución:
  < 5 minutos/día:    6 tickers (16.2%) ⚠️⚠️⚠️ Muy baja liquidez
  5-10 minutos/día:   9 tickers (24.3%) ⚠️⚠️  Baja liquidez
  10-20 minutos/día: 15 tickers (40.5%) ⚠️   Liquidez moderada
  20-30 minutos/día:  7 tickers (18.9%) ✓    Liquidez aceptable
  > 30 minutos/día:   0 tickers (0%)
```

**Conclusión**: Todos estos tickers son **small caps poco líquidos** con trading muy sparse. Esto es **normal** para empresas <$2B market cap, pero debe considerarse en cualquier análisis cuantitativo.

---

### **⚠️ ANÁLISIS DE GAPS**

**22 de 37 tickers** (59.5%) tienen gaps grandes (>7 días sin trading):

**Top 10 tickers con más gaps**:
1. PBHC: 81 gaps
2. DJCO: 78 gaps
3. FCAP: 66 gaps
4. HIFS: 41 gaps (¡incluso el campeón tiene gaps!)
5. GCBC: 39 gaps
6. AUBN: 23 gaps
7. NWFL: 22 gaps
8. TAIT: 20 gaps
9. ISRL: 12 gaps
10. RAND: 9 gaps

**15 tickers SIN gaps** (40.5%) ✅:
- UBFO, EML, FLXS, HFWA, HTB, JBI, LAKE, MLP, MTEX, NRIM, SAR, STRT, UMH, ACNB, CTO

---

### **✅ CALIDAD DE DATOS**

**Duplicados detectados**: **0** ✅
→ Ningún ticker tiene filas duplicadas (campo `minute`)

**Integridad de archivos**: **97.3%** ✅
→ Solo 4 de 912 carpetas tienen archivos corruptos

**Consistencia de estructura**: **100%** ✅
→ Todos los archivos siguen estructura `ticker/year=/month=/minute.parquet`

---

## 💎 RECOMENDACIONES DE USO

### **Tickers PREMIUM (5 estrellas) - Usar con confianza máxima**
```
1. UBFO  - 0 gaps, 2 ventanas, consistencia perfecta
2. NATH  - Más datos, alta calidad, 2 ventanas, solo 1 gap
3. PDEX  - Casi perfecto, 2 ventanas, solo 1 gap
4. LAKE  - Sin gaps, buenos datos, densidad alta
5. UMH   - Sin gaps, alta densidad (28.6 mins/día)
```

### **Tickers BUENOS (4 estrellas) - Usar con precaución leve**
```
- HIFS   - El campeón (3 ventanas) pero con 41 gaps
- CTO    - Sin gaps, buena densidad (28.3 mins/día)
- HTB    - Sin gaps, buena consistencia
- EML    - Sin gaps, datos sólidos
- HFWA   - Sin gaps
- FLXS   - Sin gaps
- WLFC   - 1 gap mínimo
- VLGEA  - 2 gaps
- STRT   - Sin gaps
```

### **Tickers REGULARES (3 estrellas o menos) - Usar solo si necesario**
```
- GCBC   - 39 gaps, baja densidad (4.2 mins/día)
- DJCO   - 78 gaps, muy fragmentado
- PBHC   - 81 gaps, extremadamente sparse
- FCAP   - 66 gaps
- AUBN   - 23 gaps
```

---

## 🔴 PROBLEMAS CRÍTICOS EN EL CÓDIGO DE DESCARGA

### **Problema #1: PARÁMETRO `--max-workers` IGNORADO**

**Archivo**: `ingest_ohlcv_intraday_minute.py:179`

```python
ap.add_argument("--max-workers", type=int, default=1,
                help="(IGNORADO) Paralelismo lo maneja el launcher.")
```

**Pero el launcher SÍ lo pasa** (`launch_intraday_windows.py:191`):
```python
"--max-workers", str(args.per_shard_workers),  # ← COMPLETAMENTE IGNORADO
```

**Impacto**: Usuario cree controlar paralelismo, pero el parámetro **no hace nada**.

---

### **Problema #2: EXIT TEMPRANO SIN RELANZAMIENTO**

**Archivo**: `ingest_ohlcv_intraday_minute.py:214-216`

```python
if args.max_tickers_per_process and processed >= args.max_tickers_per_process:
    log(f"Alcanzado --max-tickers-per-process={args.max_tickers_per_process}. Saliendo...")
    break  # ← SALE SIN COMPLETAR EL SHARD
```

**Evidencia real**:
- Shard 00: 259 tickers asignados → **13 procesados** (5%)
- Default: `--max-tickers-per-process=30`
- Launcher **NO pasa** este parámetro → usa default
- **Resultado**: 246 tickers perdidos por shard

**Impacto**: Tickers no procesados **se pierden para siempre**.

---

### **Problema #3: LOGGING ENGAÑOSO**

**Archivo**: `ingest_ohlcv_intraday_minute.py:221-222`

```python
ok = sum("ERROR" not in r for r in results)
err = len(results) - ok
```

**Problema**: Tickers con **0 rows** se marcan como "OK":
```
[2025-10-21 13:52:46] IZEA: 0 rows (1 pages) [1m]  ← Marcado como OK ✅
```

**No distingue**:
- ✅ Descarga legítima sin datos (ticker no existía en ese período)
- ❌ Ticker no existe en Polygon
- ❌ Rate limit silencioso
- ❌ Error de API no reportado

---

### **Problema #4: RESUMPTION LOGIC ROTA**

**Archivo**: `launch_intraday_windows.py:60-64`

```python
def existing_tickers(outdir: Path) -> set[str]:
    """Resume simple: si existe carpeta del ticker, lo consideramos 'ya iniciado'."""
    return {p.name for p in outdir.iterdir() if p.is_dir()}
```

**Problemas**:
1. **NO verifica ventanas**: Si AAPL tiene datos de 2020, skip TODAS las ventanas
2. **NO verifica completitud**: Carpeta vacía = "completado"
3. **NO verifica errores**: Ticker con errores = "completado"

**Impacto**: Con `--resume`, **NUNCA** se completan datos faltantes.

**Evidencia**: 82-91% de tickers sin datos en ventanas 2 y 3.

---

### **Problema #5: CURSOR PARSING SILENCIOSO**

**Archivo**: `ingest_ohlcv_intraday_minute.py:45-54`

```python
def parse_next_cursor(next_url: Optional[str]) -> Optional[str]:
    try:
        # ... parsing ...
        return cur[0] if cur else None
    except Exception:
        return None  # ← SILENCIOSO: paginación SE DETIENE
```

**Impacto**: Si falla parsear cursor → descarga **incompleta** sin error reportado.

---

### **Problema #6: RATE LIMIT SALTADO EN ÚLTIMA PÁGINA**

**Archivo**: `ingest_ohlcv_intraday_minute.py:162-165`

```python
if not cursor:
    break  # ← SALE INMEDIATAMENTE
if rate_limit_s and rate_limit_s > 0:
    time.sleep(rate_limit_s)  # ← NUNCA SE EJECUTA
```

**Impacto**: Última página **NO espera** rate limit → triggerea 429 en siguiente ticker.

---

### **Problema #7: ERRORES TLS/SSL EN WINDOWS**

**Evidencia de logs** (`2004-01-01_2010-12-31_worker_00.log`):
```
GET error HTTPSConnectionPool: Max retries exceeded (SSLError)
GET error Could not find a suitable TLS CA certificate bundle
GET error Unable to allocate output buffer
```

**Frecuencia**: Cientos de errores
**Impacto**: Workers crashean después de 8 reintentos fallidos

---

### **Problema #8: LOGGING SIN LOCKS - RACE CONDITIONS**

**Archivo**: `ingest_ohlcv_intraday_minute.py:224-226`

```python
log_file = outdir / "minute_download.log"
with open(log_file, "a", encoding="utf-8") as f:  # ← APPEND sin lock
    f.write("\n".join(results) + "\n")
```

**Problema**: 36 procesos escribiendo simultáneamente al mismo archivo sin locks.

**Consecuencia**: Líneas mezcladas, datos corruptos, pérdida de logs.

---

## 🎯 CONCLUSIONES Y HALLAZGOS CLAVE

### ✅ **Hallazgos Positivos**

1. **1 ticker (HIFS)** tiene datos completos 2004-2025 ✅
2. **4 tickers adicionales** tienen 2 ventanas completas ✅
3. **0 duplicados** detectados en ningún ticker ✅
4. **15 tickers sin gaps** → excelente calidad ✅
5. **Estructura de archivos consistente** → fácil de procesar ✅

---

### ⚠️ **Problemas Detectados**

1. **93.9% de datos faltantes** → descarga casi completamente fallida ❌
2. **Todos los tickers son poco líquidos** (12.7 mins/día promedio vs 390) ⚠️
3. **59% tienen gaps grandes** en sus datos ⚠️
4. **Solo 2 tickers completos** en ventana reciente (2017-2025) ❌
5. **Múltiples bugs en código** de descarga que causaron el fallo ❌

---

### 🚨 **Implicación Crítica**

La **"cobertura 100%"** significa:
- ✅ Tiene **AL MENOS 1 minuto** de datos en cada mes esperado
- ❌ **NO** significa trading diario completo
- ❌ **NO** significa alta liquidez

Para small caps ilíquidos (<$2B), esto es **normal** pero debe considerarse:
- Backtesting requerirá consideraciones especiales de liquidez
- Modelos cuantitativos necesitarán ajustes por sparse data
- Análisis de volatilidad puede estar sesgado por gaps

---

### 📊 **Estadísticas Finales**

```
╔══════════════════════════════════════════════════════════════╗
║                  RESUMEN FINAL                               ║
╠══════════════════════════════════════════════════════════════╣
║ Universo:                    3,107 tickers                   ║
║ Descargados (cualquier dato):  190 tickers (6.1%)           ║
║ Faltantes:                    2,917 tickers (93.9%)          ║
║                                                              ║
║ Completos en 3 ventanas:          1 ticker (HIFS)           ║
║ Completos en 2 ventanas:          4 tickers                 ║
║ Completos en 1 ventana:          32 tickers                 ║
║                                                              ║
║ Total rows descargadas:       5,077,348                      ║
║ Archivos parquet:                 7,550                      ║
║ Tickers con archivos corruptos:      4                      ║
║                                                              ║
║ Calidad promedio:             ⭐⭐⭐ (3/5 estrellas)          ║
║ Estado del sistema:           🚨 FALLO CRÍTICO               ║
╚══════════════════════════════════════════════════════════════╝
```

---

## 🚀 ACCIONES RECOMENDADAS

### **URGENTE (antes de relanzar descarga)**

1. ✅ **Fijar TLS/SSL en Windows**
   - Instalar certificados correctos
   - Configurar `SSL_CERT_FILE` si necesario

2. ✅ **Pasar `--max-tickers-per-process=0`** en launcher
   - O implementar relanzamiento automático de procesos

3. ✅ **Fijar resumption logic**
   - Verificar ventanas específicas
   - Validar completitud de datos
   - No solo verificar existencia de carpeta

4. ✅ **Fijar rate limit**
   - Aplicar sleep **antes** de break

---

### **IMPORTANTE (mejorar calidad)**

5. ⚠️ **Separar logs por worker**
   - Evitar race conditions
   - Logs del tipo `worker_00.log`, `worker_01.log`

6. ⚠️ **Distinguir 0 rows legítimo vs error**
   - Verificar status code de API
   - Reportar diferencia en logs

7. ⚠️ **Cursor parsing con logging**
   - No silenciar errores
   - Reportar cuando falla parsing

8. ⚠️ **Validación post-descarga**
   - Verificar archivos no vacíos
   - Validar integridad de parquet

---

### **OPCIONAL (optimización)**

9. 📊 **Deduplicación por timestamp**
   - Usar `t` (epoch) en vez de `minute` (string)

10. 📊 **Checkpoints más frecuentes**
    - Cada 10 tickers en vez de 25

11. 📊 **Métricas de health**
    - Monitor de progreso en tiempo real
    - Dashboard de workers activos

---

## 📁 ESTRUCTURA DE REPORTES GENERADOS

```
D:\04_TRADING_SMALLCAPS\
├── audit_reports/
│   ├── intraday_1m_2025-10-21/
│   │   ├── completeness_summary.csv          ← Resumen por ticker
│   │   ├── window_coverage.json              ← Cobertura detallada
│   │   ├── missing_tickers.txt               ← 2,917 faltantes
│   │   ├── downloaded_tickers.txt            ← 190 descargados
│   │   ├── download_priority.csv             ← Prioridades
│   │   └── ticker_metadata.json              ← Metadatos
│   │
│   └── complete_tickers_analysis/
│       ├── complete_tickers_summary.csv      ← Métricas calidad
│       ├── complete_ALL_windows.txt          ← 1: HIFS
│       ├── complete_TWO_windows.txt          ← 4: UBFO, PDEX, NATH, GCBC
│       ├── complete_100pct_2004-01-01_2010-12-31.txt   ← 29 tickers
│       ├── complete_100pct_2011-01-01_2016-12-31.txt   ← 12 tickers
│       ├── complete_100pct_2017-01-01_2025-10-21.txt   ← 2 tickers
│       ├── quality_analysis.json             ← Análisis detallado
│       └── completeness_breakdown.txt        ← Desglose completo
│
├── tools/
│   ├── audit_intraday_completeness.py        ← Script auditoría
│   └── analyze_complete_tickers.py           ← Script análisis
│
└── AUDITORIA_DATOS_INTRADAY.md              ← Este documento
```

---

## 📖 REFERENCIAS DE CÓDIGO

### **Scripts de descarga originales (con bugs)**
- `scripts/fase_1_Bloque_B/ingest_ohlcv_intraday_minute.py`
- `scripts/fase_1_Bloque_B/tools/launch_intraday_windows.py`

### **Logs de ejecución**
- `runs/intraday_1m_windows_2025-10-21/logs/`
- `raw/polygon/ohlcv_intraday_1m/minute_download.log`

### **Datos descargados**
- `raw/polygon/ohlcv_intraday_1m/[TICKER]/year=[YYYY]/month=[MM]/minute.parquet`

---

## 🔗 ENLACES ÚTILES

- **Polygon API Docs**: https://polygon.io/docs/stocks/get_v2_aggs_ticker__stocksticker__range__multiplier___timespan___from___to
- **Polars Docs**: https://pola-rs.github.io/polars/
- **Parquet Format**: https://parquet.apache.org/

---

**Documento generado**: 2025-10-21
**Versión**: 1.0
**Autor**: Auditoría automatizada de datos intradía
