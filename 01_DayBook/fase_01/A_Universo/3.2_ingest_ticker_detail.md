# 3.2 Ingesta Ticker Details - Implementaci√≥n Real

**Fecha**: 2025-10-24  
**Estado**: ‚úÖ EJECUTADO (como parte de `enrich_hybrid_universe.py`)  
**Relaci√≥n**: Este documento muestra el script de referencia conceptual. La implementaci√≥n real se ejecut√≥ de forma diferente.  

---

## üìã Script de Referencia (Conceptual)

El siguiente script es una **referencia** de c√≥mo descargar ticker details usando ThreadPoolExecutor:

```python
#!/usr/bin/env python
# ingest_ticker_details.py
import os, sys, time, argparse, datetime as dt
from pathlib import Path
import requests, polars as pl
from concurrent.futures import ThreadPoolExecutor, as_completed

BASE_URL = "https://api.polygon.io"
TIMEOUT = 20
MAX_WORKERS = 32

def log(msg): print(f"[{dt.datetime.now():%F %T}] {msg}", flush=True)

def get(api_key, url):
    for k in range(6):
        try:
            r = requests.get(url, timeout=TIMEOUT, headers={"Authorization": f"Bearer {api_key}"})
            if r.status_code == 429:
                time.sleep(int(r.headers.get("Retry-After", "2")))
                continue
            r.raise_for_status()
            return r.json().get("results", {})
        except Exception as e:
            time.sleep(1.5 * (k + 1))
    return {}

def fetch_one(api_key, t):
    url = f"{BASE_URL}/v3/reference/tickers/{t}"
    d = get(api_key, url) or {}
    d["ticker"] = t
    d["as_of_date"] = dt.date.today().isoformat()
    return d

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--snapdir", required=True, help="Dir del snapshot del paso 1 (ej: raw/polygon/reference/tickers_snapshot/snapshot_date=2025-10-19)")
    ap.add_argument("--outdir", required=True, help="Salida: raw/polygon/reference/ticker_details")
    ap.add_argument("--only-exchanges", default="NASDAQ,NYSE,ARCA", help="Filtro de exchanges (coma). Vac√≠o = todos")
    ap.add_argument("--max-workers", type=int, default=MAX_WORKERS)
    args = ap.parse_args()

    api_key = os.getenv("POLYGON_API_KEY")
    if not api_key: sys.exit("Falta POLYGON_API_KEY")

    snap = Path(args.snapdir)
    if not snap.exists(): sys.exit("Snapshot no encontrado")

    df = pl.read_parquet(snap / "tickers.parquet")
    if args.only_exchanges:
        allow = set([x.strip().upper() for x in args.only_exchanges.split(",") if x.strip()])
        if "primary_exchange" in df.columns:
            df = df.filter(pl.col("primary_exchange").is_in(list(allow)))

    tickers = df["ticker"].drop_nulls().unique().to_list()
    log(f"Tickers a detallar: {len(tickers):,}")

    outdir = Path(args.outdir) / f"as_of_date={dt.date.today().isoformat()}"
    outdir.mkdir(parents=True, exist_ok=True)

    rows = []
    with ThreadPoolExecutor(max_workers=args.max_workers) as ex:
        futs = {ex.submit(fetch_one, api_key, t): t for t in tickers}
        for i, fut in enumerate(as_completed(futs), 1):
            rows.append(fut.result())
            if i % 1000 == 0: log(f"{i:,} detalles descargados")

    pl.from_dicts(rows).write_parquet(outdir / "details.parquet")
    log(f"Escrito: {outdir/'details.parquet'}")

if __name__ == "__main__":
    main()
```

**Ejemplo de uso (NO ejecutado):**

```bash
python ingest_ticker_details.py \
  --snapdir raw/polygon/reference/tickers_snapshot/snapshot_date=2025-10-19 \
  --outdir raw/polygon/reference/ticker_details \
  --only-exchanges NASDAQ,NYSE,ARCA
```

---

## üîß Implementaci√≥n Real Ejecutada

### Script utilizado: `enrich_hybrid_universe.py`

En lugar del script conceptual anterior, la descarga de ticker details se ejecut√≥ como parte del proceso de enriquecimiento del universo h√≠brido.

**Script real**: [`scripts/fase_A_universo/enrich_hybrid_universe.py`](../../../scripts/fase_A_universo/enrich_hybrid_universe.py)

**Diferencias con el script de referencia:**

| Aspecto | Script Referencia | Implementaci√≥n Real |
|---------|------------------|---------------------|
| **M√©todo** | ThreadPoolExecutor (32 workers paralelos) | Descarga ya realizada previamente |
| **Rate limiting** | Impl√≠cito en retry logic | 0.15s entre requests |
| **Filtro** | NASDAQ, NYSE, ARCA | XNAS, XNYS (solo CS - Common Stock) |
| **Scope** | Todos los tickers del snapshot | Solo 10,599 tickers CS filtrados |
| **Output** | `as_of_date=YYYY-MM-DD/details.parquet` | `ticker_details_2025-10-24.parquet` |

### Proceso de descarga realizado

La descarga de ticker details se realiz√≥ en un paso previo durante el proceso de filtrado y creaci√≥n del universo h√≠brido:

```python
# Parte del proceso en create_hybrid_universe.py (paso previo)
for ticker in tickers_cs_xnas_xnys:  # 10,599 tickers
    details = download_ticker_details(ticker, api_key)
    time.sleep(0.15)  # Rate limiting conservador
    # ... procesar y guardar
```

**Tiempo estimado**: ~26 minutos (10,599 tickers √ó 0.15s)

### Resultados de la descarga

**Archivo generado**: `raw/polygon/reference/ticker_details/ticker_details_2025-10-24.parquet`

**Estad√≠sticas:**
- **Total tickers procesados**: 10,592 / 10,599 (99.93%)
- **Con datos v√°lidos**: 5,234 tickers (49.4%)
- **Con error `not_found`**: 5,358 tickers (50.6%)

**Descubrimiento cr√≠tico**: Solo los tickers **ACTIVOS** tienen datos completos de ticker details

### Detalles descargados por ticker (28 columnas)

#### Identificaci√≥n
- `ticker` - S√≠mbolo
- `name` - Nombre de la empresa
- `type` - Tipo (CS, ETF, etc.)
- `active` - Estado activo/inactivo
- `ticker_root`, `ticker_suffix`

#### Informaci√≥n de mercado
- `market` - Mercado (stocks, crypto, etc.)
- `locale` - Regi√≥n (us, global)
- `primary_exchange` - Exchange (XNAS, XNYS)
- `currency_name` - Moneda

#### Capitalizaci√≥n y acciones
- **`market_cap`** - ‚ö†Ô∏è **SOLO para activos** (4,884 tickers)
- `share_class_shares_outstanding` - Acciones en circulaci√≥n
- `weighted_shares_outstanding` - Acciones ponderadas
- `round_lot` - Lote m√≠nimo

#### Informaci√≥n corporativa
- `cik` - SEC CIK number
- `sic_code`, `sic_description` - C√≥digo de industria
- `total_employees` - N√∫mero de empleados
- `phone_number`, `address`, `homepage_url` - Contacto
- `description` - Descripci√≥n del negocio

#### Fechas
- `list_date` - Fecha de listado
- `fetch_date` - Fecha de descarga

#### Identificadores
- `composite_figi`, `share_class_figi` - FIGI identifiers
- `branding` - Logo, colores, etc.

#### Errores
- `error` - Si hubo error en la descarga (`not_found` para inactivos)

---

## üîç Problema Cr√≠tico Descubierto

### Tickers inactivos NO tienen market_cap

**Observaci√≥n**: Al analizar los resultados, descubrimos que:

- ‚úÖ **4,884 activos**: Tienen `market_cap` y todos los campos corporativos
- ‚ùå **5,708 inactivos**: Campo `error: "not_found"`, todos los campos en `null`

**Ejemplo de ticker INACTIVO (AAPC)**:
```json
{
  "ticker": "AAPC",
  "error": "not_found",
  "name": null,
  "market_cap": null,
  "description": null,
  "sic_code": null,
  // ... todos los campos en null
}
```

**Causa**: Polygon API `/v3/reference/tickers/{ticker}` NO retorna datos para tickers delisted. Solo retorna datos para tickers actualmente activos.

**Documentaci√≥n del problema**: Ver [`4.2_inactivos_sin_data.md`](4.2_inactivos_sin_data.md)

---

## üí° Soluci√≥n Implementada: Dual Enrichment Strategy

Debido a la limitaci√≥n anterior, implementamos una **estrategia dual de enriquecimiento**:

### Para ACTIVOS:
- **Fuente**: `ticker_details` (API endpoint individual)
- **Datos obtenidos**: market_cap, description, sic_code, total_employees, etc.
- **Uso**: Filtrar por market_cap < $2B

### Para INACTIVOS:
- **Fuente**: `snapshot original` (tickers_all.parquet)
- **Datos obtenidos**: name, cik, delisted_utc, composite_figi
- **Uso**: Feature engineering (days_to_delisting, is_terminal_pump)

**Script de enriquecimiento**: [`scripts/fase_A_universo/enrich_hybrid_universe.py`](../../../scripts/fase_A_universo/enrich_hybrid_universe.py)

---

## üìä Estad√≠sticas de Completitud

### Campos con datos en ACTIVOS (100% de 3,092)
- `market_cap` - 3,092 (100%)
- `weighted_shares_outstanding` - 3,092 (100%)
- `description` - 3,092 (100%)
- `list_date` - 3,083 (99.7%)
- `homepage_url` - 2,967 (96.0%)
- `share_class_shares_outstanding` - 2,915 (94.3%)
- `total_employees` - 2,738 (88.6%)
- `sic_code` - 2,469 (79.9%)

### Campos con datos en INACTIVOS (de snapshot, no de ticker_details)
- `delisted_utc` - 5,393 / 5,594 (96.4%) ‚≠ê **CR√çTICO para ML**
- `cik` - 5,339 / 5,594 (95.4%)
- `composite_figi` - 2,403 / 5,594 (43.0%)
- `name` - 5,594 / 5,594 (100%)

---

## ‚úÖ Verificaci√≥n de Resultados

**Archivo final enriquecido**: `processed/universe/cs_xnas_xnys_hybrid_enriched_2025-10-24.parquet`

**Verificaciones:**
```
‚úÖ Total tickers: 8,686
‚úÖ Activos: 3,092 (100% con market_cap)
‚úÖ Inactivos: 5,594 (96.4% con delisted_utc)
‚úÖ Sin survivorship bias
‚úÖ 23 columnas totales
‚úÖ Tama√±o: 0.91 MB
```

**C√≥digo de verificaci√≥n**: Ver [`notebook1.ipynb`](notebook1.ipynb) - Secci√≥n "An√°lisis de Ticker Details"

---

## üîó Referencias

- **Script conceptual**: `ingest_ticker_details.py` (este documento - NO ejecutado)
- **Script real**: [`enrich_hybrid_universe.py`](../../../scripts/fase_A_universo/enrich_hybrid_universe.py) (‚úÖ ejecutado)
- **Datos descargados**: `raw/polygon/reference/ticker_details/ticker_details_2025-10-24.parquet`
- **Datos enriquecidos**: `processed/universe/cs_xnas_xnys_hybrid_enriched_2025-10-24.parquet`
- **Problema inactivos**: [`4.2_inactivos_sin_data.md`](4.2_inactivos_sin_data.md)
- **Pipeline completo**: [`3.1_ingest_reference_universe_v2.md`](3.1_ingest_reference_universe_v2.md)

---

## üöÄ Siguiente Paso

Con el universo enriquecido de **8,686 tickers** listo:

1. ‚úÖ **Fase A - Universo**: COMPLETADA
2. ‚è≠Ô∏è **Fase B - Ingesta Daily/Minute**: Descargar datos hist√≥ricos para estos 8,686 tickers
3. ‚è≠Ô∏è **Fase C - Ingesta Ticks Event Days**: Descargar ticks de alta frecuencia para d√≠as con eventos

**Status**: ‚úÖ Listo para Fase B