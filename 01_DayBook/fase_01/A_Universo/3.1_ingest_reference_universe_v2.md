# 3.1 Ingesta Reference Universe v2 - Implementaci√≥n Real

**Fecha**: 2025-10-24  
**Estado**: ‚úÖ EJECUTADO  
**Relaci√≥n**: Este documento complementa y actualiza `3.1_ingest_reference_universe.md`  

---

## üîó Relaci√≥n con Documentaci√≥n de Referencia

El documento [`3.1_ingest_reference_universe_v1.md`](3.1_ingest_reference_universe_v1.md) es una **documentaci√≥n de referencia** que describe el proceso anterior de la ingesta del universo de tickers desde Polygon API.

**Este documento (`3.1_ingest_reference_universe_v2.md`)** documenta la **implementaci√≥n real** que ejecutamos, con las siguientes diferencias clave:

| Aspecto | Implementaci√≥n Real (3.1_v2) |
|---------|------------------------------|
| **Script** | `download_complete_snapshot.py` + `create_hybrid_universe.py` |
| **Enfoque** | Descarga completa + estrategia h√≠brida |
| **Survivorship Bias** | Resuelto con estrategia h√≠brida |
| **Market Cap** | Descubierto que NO existe para inactivos |
| **Resultado** | Universo h√≠brido sin sesgo (8,686 tickers) |

---

## üìä Pipeline Completo de Creaci√≥n del Universo

### **Paso 1: Descarga Snapshot Completo**

**Script**: [`scripts/fase_A_universo/download_complete_snapshot.py`](../../../scripts/fase_A_universo/download_complete_snapshot.py)

**Innovaci√≥n T√©cnica**: Dos llamadas API separadas para evitar problemas de esquema
```python
# Activos: 13 columnas (sin delisted_utc)
df_active = download_tickers(active=True)

# Inactivos: 14 columnas (con delisted_utc)
df_inactive = download_tickers(active=False)

# Concatenaci√≥n diagonal para manejar esquemas diferentes
df_all = pl.concat([df_active, df_inactive], how="diagonal")
```

**Resultado**:
- **Total**: 34,380 tickers
- **Activos**: 11,853 tickers
- **Inactivos**: 22,527 tickers
- **Ubicaci√≥n**: `raw/polygon/reference/tickers_snapshot/snapshot_date=2025-10-24/`

**Archivos Generados**:
- `tickers_all.parquet` (34,380 tickers)
- `tickers_active.parquet` (11,853 activos)
- `tickers_inactive.parquet` (22,527 inactivos)

---

### **Paso 2: Filtrado por Common Stock (CS) en NASDAQ/NYSE**

**Motivaci√≥n**: El snapshot incluye ETFs, warrants, fondos, etc. Solo queremos acciones comunes (CS).

**Filtros Aplicados**:
1. `type = "CS"` (Common Stock)
2. `primary_exchange IN ("XNAS", "XNYS")` (NASDAQ o NYSE)

**Resultado**:
- **Total CS en XNAS/XNYS**: 10,599 tickers
  - **Activos**: 5,005 tickers
  - **Inactivos**: 5,594 tickers

**Distribuci√≥n**:
- **NASDAQ (XNAS)**: 6,639 tickers
- **NYSE (XNYS)**: 3,960 tickers

---

### **Paso 3: Descarga de Ticker Details (Market Cap)**

**Objetivo**: Obtener `market_cap` para filtrar small caps (< $2B)

**Endpoint**: `GET /v3/reference/tickers/{ticker}`

**Resultado**:
- **Total descargados**: 10,592 ticker details
- **‚ö†Ô∏è PROBLEMA CR√çTICO DESCUBIERTO**: Solo 4,884 tickers tienen `market_cap`
  - ‚úÖ **Todos los activos** (4,884) tienen `market_cap`
  - ‚ùå **Ning√∫n inactivo** (5,594) tiene `market_cap`

**Implicaci√≥n**: No podemos filtrar inactivos por market cap < $2B porque Polygon no proporciona este dato para tickers delisted.

---

### **Paso 4: Soluci√≥n - Universo H√≠brido (Sin Survivorship Bias)**

**Script**: [`scripts/fase_A_universo/create_hybrid_universe.py`](../../../scripts/fase_A_universo/create_hybrid_universe.py)

**Problema**: Si solo incluimos activos < $2B, introducimos **survivorship bias** al excluir todas las empresas que fueron delisted.

**Soluci√≥n - Estrategia H√≠brida**:

1. **Activos**: Filtrar por `market_cap < $2B`
   - Resultado: **3,092 tickers activos**

2. **Inactivos**: Incluir **TODOS** sin filtro de market cap
   - Resultado: **5,594 tickers inactivos**

**Fundamento Te√≥rico** (L√≥pez de Prado):
- Las empresas inactivas fueron small caps antes de ser delisted
- NASDAQ requiere mantener market cap > $35M-$50M para mantenerse listado
- Si fueron delisted, es razonable asumir que eran small caps
- Incluir todas las inactivas elimina el survivorship bias

**Universo Final**:
```
Total: 8,686 tickers
‚îú‚îÄ‚îÄ Activos (market_cap < $2B): 3,092 tickers
‚îÇ   ‚îú‚îÄ‚îÄ NASDAQ: 1,895
‚îÇ   ‚îî‚îÄ‚îÄ NYSE: 1,197
‚îî‚îÄ‚îÄ Inactivos (TODOS): 5,594 tickers
    ‚îú‚îÄ‚îÄ NASDAQ: 3,519
    ‚îî‚îÄ‚îÄ NYSE: 2,075
```

**Archivo Final**: [`processed/universe/cs_xnas_xnys_hybrid_2025-10-24.parquet`](../../../processed/universe/cs_xnas_xnys_hybrid_2025-10-24.parquet)

---


### **3.1_ingest_reference_universe_v2.md (Este Documento - Implementaci√≥n Real)**
- Scripts reales: `download_complete_snapshot.py` + `create_hybrid_universe.py`
- Descarga completa (activos + inactivos) con manejo de esquemas diferentes
- Descubre y resuelve problema de market_cap faltante
- Implementa estrategia h√≠brida para evitar survivorship bias
- Resultado: **8,686 tickers sin sesgo**, listo para backtesting riguroso

---

## üìÅ Archivos Clave

### Scripts
1. [`scripts/fase_A_universo/download_complete_snapshot.py`](../../../scripts/fase_A_universo/download_complete_snapshot.py)
   - Descarga snapshot completo con manejo de esquemas diferentes

2. [`scripts/fase_A_universo/create_hybrid_universe.py`](../../../scripts/fase_A_universo/create_hybrid_universe.py)
   - Crea universo h√≠brido sin survivorship bias

### Datos Raw
- `raw/polygon/reference/tickers_snapshot/snapshot_date=2025-10-24/`
  - `tickers_all.parquet` (34,380 tickers)
  - `tickers_active.parquet` (11,853)
  - `tickers_inactive.parquet` (22,527)

- `raw/polygon/reference/ticker_details/ticker_details_2025-10-24.parquet`
  - 10,592 ticker details
  - Solo 4,884 con market_cap (todos activos)

### Universo Final
- [`processed/universe/cs_xnas_xnys_hybrid_2025-10-24.parquet`](../../../processed/universe/cs_xnas_xnys_hybrid_2025-10-24.parquet)
  - **8,686 tickers** sin survivorship bias
  - 3,092 activos < $2B + 5,594 inactivos ALL

### Documentaci√≥n
- [`4.1_problemas_&_decisiones.md`](4.1_problemas_&_decisiones.md)
  - Detalla el problema de market_cap y la soluci√≥n h√≠brida

---

## ‚úÖ Verificaci√≥n

**C√≥digo de verificaci√≥n** disponible en: [`01_DayBook/fase_01/A_Universo/notebook1.ipynb`](notebook1.ipynb)

**Estad√≠sticas Verificadas**:
```python
Total tickers: 8,686
‚îú‚îÄ‚îÄ Activos: 3,092 (35.6%)
‚îî‚îÄ‚îÄ Inactivos: 5,594 (64.4%)

Por Exchange:
‚îú‚îÄ‚îÄ NASDAQ (XNAS): 5,414 (62.3%)
‚îî‚îÄ‚îÄ NYSE (XNYS): 3,272 (37.7%)

Market Cap (solo activos):
‚îú‚îÄ‚îÄ Con market_cap: 3,092 (100% de activos)
‚îú‚îÄ‚îÄ Sin market_cap: 5,594 (100% de inactivos)
‚îî‚îÄ‚îÄ Total con market_cap < $2B: 3,092
```

---

## üöÄ Siguiente Fase

Con el universo h√≠brido de **8,686 tickers** sin survivorship bias:

1. ‚úÖ **Fase A - Universo**: COMPLETADA
2. ‚è≠Ô∏è **Fase B - Ingesta Daily/Minute**: Descargar datos hist√≥ricos para estos 8,686 tickers
3. ‚è≠Ô∏è **Fase C - Ingesta Ticks Event Days**: Descargar ticks de alta frecuencia para d√≠as con eventos

---

**√öltima Actualizaci√≥n**: 2025-10-24
**Status**: ‚úÖ Pipeline completo ejecutado y verificado
