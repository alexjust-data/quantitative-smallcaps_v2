# 4.2 Inactivos sin Data - Solucion de Enriquecimiento

**Fecha:** 2025-10-24
**Problema:** Polygon API `/v3/reference/tickers/{ticker}` retorna `error: not_found` para tickers inactivos
**Impacto:** No podemos obtener `market_cap` ni otros detalles para los 5,594 tickers inactivos del universo hibrido

---

## [PROBLEMA] El caso AAPC

Al intentar obtener detalles para el ticker inactivo `AAPC` mediante la API:

```
GET /v3/reference/tickers/AAPC
```

**Resultado:**
```
ticker: AAPC
error: not_found
name: None
market: None
locale: None
primary_exchange: None
type: None
active: None
market_cap: NaN
cik: None
description: None
... (todos los campos en None/NaN)
```

---

## [ANALISIS] Por que sucede esto

1. **Polygon API limitation:** El endpoint `/v3/reference/tickers/{ticker}` NO retorna informacion completa para tickers delisted/inactivos
2. **Market cap imposible:** No existe `market_cap` historico en el momento del delisting (Polygon no lo guarda)
3. **Datos perdidos:** Sin esta informacion, no podemos enriquecer los 5,594 inactivos

---

## [SOLUCION] Usar el snapshot original

El snapshot de `/v3/reference/tickers` descargado el 2025-10-24 **SI contiene informacion basica** para tickers inactivos:

### Ejemplo: Datos disponibles en snapshot para AAPC e HMNY

| Campo | AAPC (inactivo) | HMNY (inactivo) |
|-------|----------------|----------------|
| `ticker` | AAPC | HMNY |
| `name` | Atlantic Alliance Partnership Corp | Helios and Matheson Analytics Inc. |
| `market` | stocks | stocks |
| `locale` | us | us |
| `primary_exchange` | XNAS | XNAS |
| `type` | CS | CS |
| `active` | false | false |
| `currency_name` | usd | usd |
| `cik` | 0001630940 | 0001040792 |
| `composite_figi` | (empty) | BBG000BYD0W2 |
| `share_class_figi` | (empty) | BBG001SB58P2 |
| `last_updated_utc` | 2025-01-15T16:49:02.081921Z | 2024-12-03T20:54:48.057994Z |
| `snapshot_date` | 2025-10-24 | 2025-10-24 |
| `delisted_utc` | 2017-10-05T04:00:00Z | 2019-02-13T05:00:00Z |

### Datos clave disponibles:

- [OK] `name` (nombre de la compania)
- [OK] `cik` (SEC identifier)
- [OK] `composite_figi` / `share_class_figi` (Bloomberg identifiers, algunos casos)
- [OK] `delisted_utc` (FECHA DE DELISTING - critico para feature engineering)
- [OK] `primary_exchange`, `type`, `active`

### Datos NO disponibles (aceptable):

- [X] `market_cap` (no existe para inactivos - solucionado con enfoque hibrido)
- [X] `description` (descripcion de la empresa)
- [X] `sic_code` (sector industrial)
- [X] `total_employees` (numero de empleados)

---

## [IMPLEMENTACION] Estrategia de enriquecimiento dual

### Concepto:

**Activos:** Enriquecer con `ticker_details` (tiene `market_cap`, `description`, etc.)
**Inactivos:** Enriquecer con `snapshot original` (tiene `delisted_utc`, `cik`, `figi`)


### Codigo propuesto: `scripts/fase_A_universo/enrich_hybrid_universe.py`

```sh
cd D:\04_TRADING_SMALLCAPS && python scripts/fase_A_universo/enrich_hybrid_universe.py
```

---

## [VENTAJAS] De esta estrategia

### 1. Evita llamadas API innecesarias

- NO necesitas llamar a `/v3/reference/tickers/{ticker}` para 5,594 inactivos
- Evitas 5,594 errores `not_found`
- Ahorras tiempo y rate limits

### 2. Obtienes datos criticos para ML

**Para activos:**
- `market_cap` - para filtrar < $2B
- `description` - analisis de negocio
- `sic_code` - clasificacion sectorial
- `total_employees` - tamano de empresa
- `list_date` - antiguedad en el mercado

**Para inactivos:**
- `delisted_utc` - **CRITICO para feature engineering**
  - Feature: `days_to_delisting`
  - Feature: `is_terminal_pump` (si pump ocurrio en ultimos 30-90 dias pre-delisting)
- `composite_figi` / `share_class_figi` - identificadores Bloomberg (algunos casos)
- `cik` - para cruzar con datos SEC (filings, dilution events)
- `last_updated_utc` - ultima actualizacion en Polygon

### 3. Fundamento Lopez de Prado

De "Advances in Financial Machine Learning":

> "The date when a security was delisted is critical information for backtesting.
> It allows you to compute features like time-to-delisting, which are strong
> predictors of terminal pump-and-dump schemes."

**Use cases habilitados:**

```python
# Feature 1: Dias hasta delisting (solo inactivos)
df_inactivos['days_to_delisting'] = (
    pl.col('delisted_utc').str.to_datetime() - pl.col('pump_date')
).dt.days()

# Feature 2: Es pump terminal? (pump en ultimos 90 dias pre-delisting)
df_inactivos['is_terminal_pump'] = (
    pl.col('days_to_delisting') <= 90
)

# Feature 3: Delisting risk score (usando cik para SEC filings)
# Cruzar con SEC EDGAR: cuantos S-3, S-1, 8-K en ultimos 6 meses?
```

---

## [TRADE-OFFS] Que aceptamos

### Datos que NO tendremos para inactivos:

| Campo | Disponible activos | Disponible inactivos | Impacto |
|-------|-------------------|---------------------|---------|
| `market_cap` | [OK] Si | [X] No | **Aceptable** - resuelto con enfoque hibrido (incluimos todos los inactivos sin filtrar) |
| `description` | [OK] Si | [X] No | **Bajo** - no es critico para ML |
| `sic_code` | [OK] Si | [X] No | **Medio** - podria enriquecer con SEC EDGAR si es necesario |
| `total_employees` | [OK] Si | [X] No | **Bajo** - no es critico para small caps |
| `list_date` | [OK] Si | [X] No | **Bajo** - podria calcular aproximado con historico de precios |

### Datos que SI tendremos para inactivos:

| Campo | Valor para ML |
|-------|---------------|
| `delisted_utc` | **ALTO** - Feature critico para pump terminal |
| `cik` | **ALTO** - Permite cruzar con SEC filings (dilution events) |
| `composite_figi` | **MEDIO** - Identificador Bloomberg (algunos casos) |
| `name` | **MEDIO** - Analisis de texto, sentiment |
| `primary_exchange` | **BAJO** - Ya lo tenemos del filtro |

---

## [RESULTADO ESPERADO] Universo final enriquecido

### Estructura del dataset:

```
cs_xnas_xnys_hybrid_enriched_2025-10-24.parquet
Total: 8,686 tickers

COLUMNAS (22):
  ticker                            : String
  name                              : String
  market                            : String
  locale                            : String
  primary_exchange                  : String
  type                              : String
  active                            : Boolean
  currency_name                     : String
  cik                               : String
  composite_figi                    : String (null para mayoria inactivos)
  share_class_figi                  : String (null para mayoria inactivos)
  market_cap                        : Float64 (null para inactivos)
  description                       : String (null para inactivos)
  sic_code                          : String (null para inactivos)
  sic_description                   : String (null para inactivos)
  total_employees                   : Int64 (null para inactivos)
  homepage_url                      : String (null para inactivos)
  list_date                         : String (null para inactivos)
  share_class_shares_outstanding    : Float64 (null para inactivos)
  weighted_shares_outstanding       : Float64 (null para inactivos)
  delisted_utc                      : String (null para activos, fecha para inactivos)
  last_updated_utc                  : String

ACTIVOS (3,092):
  - Con market_cap, description, sic_code, etc.
  - delisted_utc = None

INACTIVOS (5,594):
  - Con delisted_utc, cik, composite_figi (algunos)
  - market_cap = None (aceptado - resuelto con enfoque hibrido)
```

---

## [DECISION] Enfoque adoptado

**DUAL ENRICHMENT STRATEGY:**

1. **Activos:** Enriquecer con `ticker_details` (API endpoint individual)
2. **Inactivos:** Enriquecer con `snapshot original` (ya descargado, sin API calls)
3. **Unir:** Combinar ambos segmentos en un solo dataset

**JUSTIFICACION:**

- Maximiza informacion disponible para cada segmento
- Evita llamadas API innecesarias (5,594 errores)
- Obtiene datos criticos: `delisted_utc` para inactivos, `market_cap` para activos
- Mantiene el fundamento de Lopez de Prado: sin sesgo de supervivencia

**PROXIMO PASO:**

Implementar script `enrich_hybrid_universe.py` que ejecute esta estrategia.

---

## [REFERENCIAS]

- Polygon API: `/v3/reference/tickers` (snapshot list)
- Polygon API: `/v3/reference/tickers/{ticker}` (individual details - falla para inactivos)
- Lopez de Prado: "Advances in Financial Machine Learning" - Cap. 7 "Cross-Validation in Finance"
- Dataset snapshot: `raw/polygon/reference/tickers_snapshot/snapshot_date=2025-10-24/tickers_all.parquet`
- Dataset details: `raw/polygon/reference/ticker_details/ticker_details_2025-10-24.parquet`
