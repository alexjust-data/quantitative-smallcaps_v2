# 8.13 Auditor√≠a de L√≠mites de Descarga por API

**Fecha**: 2025-10-23
**Objetivo**: Determinar cu√°nto podemos descargar en UNA sola llamada API de cada vendor

---

## Resumen Ejecutivo

| Vendor | Datos por Llamada | Equivalente D√≠as | Rate Limit | Plan |
|--------|------------------|-----------------|------------|------|
| **Alpha Vantage** | 1 mes completo | ~20 d√≠as trading | 5/min, 100/d√≠a | FREE ‚úÖ |
| **Twelve Data** | 5,000 puntos | ~3.5 d√≠as trading | 8/min | FREE ‚úÖ |
| **Polygon** | 50,000 puntos | ~35 d√≠as trading | Unlimited | PAID üí∞ |
| **FMP** | ??? (no doc clara) | Unknown | Unknown | 403 Forbidden ‚ùå |

---

## 1. Alpha Vantage

### Documentaci√≥n Oficial
**URL:** https://www.alphavantage.co/documentation/#intraday

### L√≠mites por Llamada

#### Par√°metro `outputsize=full`
- **Reciente:** 30 d√≠as trailing de data intraday
- **Hist√≥rico (con month):** 1 mes completo espec√≠fico

#### Par√°metro `month=YYYY-MM`
- Permite query de **cualquier mes hist√≥rico** desde Enero 2000
- Formato: `month=2025-05`
- Retorna: **Todo el mes completo** (20-23 d√≠as de trading)

### Ejemplo de Llamada

```bash
# Descargar Mayo 2025 completo (1 API call)
https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=WOLF&interval=1min&month=2025-05&outputsize=full&apikey=YOUR_KEY
```

**Resultado esperado:**
- Mayo 2025: 21 d√≠as de trading √ó 390 minutos/d√≠a = ~8,190 minutos
- ‚úÖ TODO en 1 API call

### C√°lculo para Nuestro Dataset

**Dataset:** 11,054 ticker-days

**Si queremos descargar todo:**
```
11,054 ticker-days √∑ 20 d√≠as/mes = 553 ticker-months
553 ticker-months = 553 API calls

Con rate limit 100 calls/d√≠a:
553 calls √∑ 100 calls/d√≠a = 5.53 d√≠as ‚âà 6 d√≠as
```

**‚úÖ Factible:** Podemos descargar todo el dataset en 6 d√≠as.

### Optimizaci√≥n: Mes Completo vs D√≠a Individual

```python
# MALO: 1 API call por d√≠a
for date in ["2025-05-01", "2025-05-02", ..., "2025-05-21"]:
    fetch_alphavantage_1min(symbol="WOLF", date=date)
# Total: 21 API calls

# BUENO: 1 API call por mes
fetch_alphavantage_1min(symbol="WOLF", month="2025-05")
# Total: 1 API call ‚Üí Luego filtrar localmente
```

**Ahorro:** 95% menos API calls

---

## 2. Twelve Data

### Documentaci√≥n Oficial
**URL:** https://twelvedata.com/docs#time-series

### L√≠mites por Llamada

#### Par√°metro `outputsize`
- **Rango:** 1 a 5,000 puntos
- **M√°ximo:** 5,000 data points por llamada

#### C√°lculo de D√≠as

```
5,000 minutos √∑ 390 minutos/d√≠a trading = 12.82 d√≠as

Pero necesitas especificar start_date y end_date, as√≠ que:
5,000 minutos √∑ 1,440 minutos/d√≠a calendario = 3.47 d√≠as
```

**Realista:** ~3-4 d√≠as trading por llamada

### Ejemplo de Llamada

```bash
# Descargar 3 d√≠as (1 API call)
https://api.twelvedata.com/time_series?symbol=WOLF&interval=1min&start_date=2025-05-13 00:00:00&end_date=2025-05-15 23:59:59&outputsize=5000&apikey=YOUR_KEY
```

### C√°lculo para Nuestro Dataset

**Dataset:** 11,054 ticker-days

```
11,054 ticker-days √∑ 3.5 d√≠as/call = 3,158 API calls

Con rate limit 8 calls/min:
3,158 calls √∑ 8 calls/min = 394.75 minutos = 6.58 horas
```

**‚úÖ Factible:** Podemos descargar todo en ~7 horas.

### Optimizaci√≥n: Batch por Semana

```python
# MALO: 1 API call por d√≠a
for date in all_dates:
    fetch(date)  # 11,054 calls

# BUENO: 1 API call por ~3 d√≠as
for week_start in week_starts:
    fetch(start_date=week_start, end_date=week_start + 3days)
# Total: ~3,700 calls vs 11,054 calls
```

**Ahorro:** 67% menos API calls

---

## 3. Polygon

### Documentaci√≥n Oficial
**URL:** https://polygon.io/docs/stocks/get_v2_aggs_ticker__stocksticker__range__multiplier___timespan___from___to

### L√≠mites por Llamada

#### Par√°metro `limit`
- **M√°ximo:** 50,000 aggregates
- **Default:** 5,000 aggregates

#### C√°lculo de D√≠as

```
50,000 minutos √∑ 390 minutos/d√≠a trading = 128 d√≠as

Realista: ~35 d√≠as trading (considerando pre/post market)
```

**‚úÖ MUY GENEROSO:** Puedes descargar m√°s de 1 mes por llamada

### Ejemplo de Llamada

```bash
# Descargar 35 d√≠as (1 API call)
https://api.polygon.io/v2/aggs/ticker/WOLF/range/1/minute/2025-05-01/2025-06-05?adjusted=true&sort=asc&limit=50000&apikey=YOUR_KEY
```

### C√°lculo para Nuestro Dataset

**Dataset:** 11,054 ticker-days

```
11,054 ticker-days √∑ 35 d√≠as/call = 316 API calls

Con rate limit: UNLIMITED (paid plan)
316 calls √ó ~2 segundos/call = 632 segundos = 10.5 minutos
```

**‚úÖ‚úÖ EXCELENTE:** Podemos descargar TODO en 10 minutos.

### Ventaja Polygon

- No tiene rate limit (paid plan)
- Permite 50,000 puntos (10x m√°s que Twelve Data)
- Puedes paralelizar llamadas

---

## 4. FMP (Financial Modeling Prep)

### Documentaci√≥n Oficial
**URL:** https://site.financialmodelingprep.com/developer/docs

### Estado Actual

‚ùå **403 Forbidden** en plan free

**Documentaci√≥n:** No especifica l√≠mites claros para intraday data.

### Posible L√≠mite (estimado)

Basado en otros endpoints FMP:
- Probablemente ~5,000 puntos por llamada (similar a Twelve Data)
- Requiere plan paid para intraday

**Recomendaci√≥n:** ‚ùå Excluir de batch downloads hasta resolver 403.

---

## 5. Comparaci√≥n y Estrategia √ìptima

### Tabla Comparativa

| Vendor | Puntos/Call | D√≠as/Call | Calls Totales | Tiempo Total | Costo API |
|--------|-------------|-----------|---------------|--------------|-----------|
| **Polygon** | 50,000 | 35 | 316 | **10 min** | Paid (unlimited) |
| **Alpha Vantage** | ~8,000 | 20 | 553 | **6 d√≠as** | Free (100/d√≠a) |
| **Twelve Data** | 5,000 | 3.5 | 3,158 | **7 horas** | Free (8/min) |

### Estrategia Recomendada

#### Opci√≥n 1: Solo Polygon (M√°s R√°pido)

**Ventajas:**
- ‚úÖ 10 minutos para todo el dataset
- ‚úÖ No rate limits
- ‚úÖ Unlimited calls

**Desventajas:**
- üí∞ Ya lo pagas (no es adicional)
- Solo 1 vendor (no triangulaci√≥n)

#### Opci√≥n 2: Alpha Vantage + Twelve Data (Multi-vendor Free)

**Ventajas:**
- ‚úÖ Gratis
- ‚úÖ 2 vendors para triangulaci√≥n
- ‚úÖ Alpha Vantage: ~6 d√≠as
- ‚úÖ Twelve Data: ~7 horas

**Desventajas:**
- M√°s lento que Polygon
- Requiere batch scheduling

#### Opci√≥n 3: Tres Vendors (M√°xima Certificaci√≥n)

**Polygon + Alpha Vantage + Twelve Data**

**Tiempo:**
- Polygon: 10 minutos
- Alpha Vantage: 6 d√≠as (paralelo con Polygon)
- Twelve Data: 7 horas (paralelo con Polygon)

**Resultado:** Despu√©s de 6 d√≠as tienes 3 vendors completos.

---

## 6. Scripts de Batch Download Optimizados

### Alpha Vantage (Por Mes)

```python
#!/usr/bin/env python3
"""
Batch download Alpha Vantage by month (optimal)
"""

import time
from datetime import datetime, timedelta

# Generar lista de meses √∫nicos en nuestro dataset
months = set()
for ticker_day in ticker_days:  # 11,054 ticker-days
    date = datetime.strptime(ticker_day["date"], "%Y-%m-%d")
    month = date.strftime("%Y-%m")
    months.add((ticker_day["ticker"], month))

print(f"Unique ticker-months: {len(months)}")  # ~553

# Descargar por mes (no por d√≠a)
for ticker, month in months:
    # 1 API call obtiene ~20 d√≠as
    response = fetch_alphavantage_month(ticker, month)
    save_raw(response, f"raw_data/{ticker}_{month}_alphavantage_raw.json")

    # Respetar rate limit: 100 calls/d√≠a
    time.sleep(864)  # 86,400 seconds/d√≠a √∑ 100 calls = 864s/call

# Tiempo total: ~553 calls √ó 864s = ~477,000s = 5.5 d√≠as
```

**Optimizaci√≥n:**
- En lugar de 11,054 llamadas (1 por d√≠a)
- Solo 553 llamadas (1 por mes)
- **95% ahorro**

---

### Twelve Data (Por Semana)

```python
#!/usr/bin/env python3
"""
Batch download Twelve Data by week (optimal)
"""

import time

# Agrupar ticker-days en chunks de 3 d√≠as
chunks = []
current_chunk = []

for ticker, date in sorted(ticker_days):
    current_chunk.append((ticker, date))
    if len(current_chunk) >= 3:  # ~3 d√≠as = 5,000 puntos
        chunks.append(current_chunk)
        current_chunk = []

print(f"Total chunks: {len(chunks)}")  # ~3,700

# Descargar por chunk
for i, chunk in enumerate(chunks):
    ticker = chunk[0][0]
    start_date = chunk[0][1]
    end_date = chunk[-1][1]

    response = fetch_twelvedata_range(ticker, start_date, end_date)
    save_raw(response, f"raw_data/{ticker}_{start_date}_{end_date}_twelvedata_raw.json")

    # Respetar rate limit: 8 calls/min
    if (i + 1) % 8 == 0:
        time.sleep(60)  # Esperar 1 minuto cada 8 calls

# Tiempo total: ~3,700 calls √∑ 8 calls/min = 462 min = 7.7 horas
```

---

### Polygon (Sin L√≠mites)

```python
#!/usr/bin/env python3
"""
Batch download Polygon (no rate limits)
"""

# Agrupar por ticker y rangos de 35 d√≠as
ticker_ranges = []
for ticker in unique_tickers:
    dates = get_dates_for_ticker(ticker)
    # Agrupar en rangos de 35 d√≠as
    for i in range(0, len(dates), 35):
        start = dates[i]
        end = dates[min(i+34, len(dates)-1)]
        ticker_ranges.append((ticker, start, end))

print(f"Total ranges: {len(ticker_ranges)}")  # ~316

# Descargar sin esperas (no rate limit)
for ticker, start, end in ticker_ranges:
    response = fetch_polygon_range(ticker, start, end)
    save_raw(response, f"raw_data/{ticker}_{start}_{end}_polygon_raw.json")

# Tiempo total: ~316 calls √ó 2s/call = 632s = 10.5 minutos
```

---

## 7. Implementaci√≥n Pr√°ctica

### Paso 1: Generar Manifest de Descarga

```python
# generate_download_manifest.py

import json
from collections import defaultdict

# Analizar nuestro dataset
ticker_days = load_all_ticker_days()  # 11,054 entries

# Alpha Vantage: Agrupar por mes
av_manifest = defaultdict(set)
for ticker, date in ticker_days:
    month = date[:7]  # "2025-05"
    av_manifest[ticker].add(month)

# Twelve Data: Agrupar en chunks de 3 d√≠as
td_manifest = []
# ... similar logic

# Polygon: Agrupar en chunks de 35 d√≠as
polygon_manifest = []
# ... similar logic

# Guardar manifests
json.dump(av_manifest, open("manifests/alphavantage.json", "w"))
json.dump(td_manifest, open("manifests/twelvedata.json", "w"))
json.dump(polygon_manifest, open("manifests/polygon.json", "w"))
```

### Paso 2: Ejecutar Batch Downloads

```powershell
# Alpha Vantage (background, 6 d√≠as)
python batch_download_alphavantage.py --manifest manifests/alphavantage.json &

# Twelve Data (7 horas)
python batch_download_twelvedata.py --manifest manifests/twelvedata.json

# Polygon (10 minutos)
python batch_download_polygon.py --manifest manifests/polygon.json
```

### Paso 3: Normalizar Todos

```powershell
# Procesar todos los raw files
python batch_normalize_all.py --raw-dir raw_data --output-dir normalized
```

---

## 8. Conclusi√≥n y Recomendaciones

### Capacidad de Descarga Confirmada

| Vendor | Datos/Call | Plan | Factibilidad |
|--------|-----------|------|-------------|
| **Alpha Vantage** | 1 mes | FREE | ‚úÖ 6 d√≠as |
| **Twelve Data** | 3.5 d√≠as | FREE | ‚úÖ 7 horas |
| **Polygon** | 35 d√≠as | PAID | ‚úÖ 10 minutos |

### Estrategia Recomendada

**Para certificaci√≥n cient√≠fica multi-vendor:**

1. **Semana 1:** Descargar con Polygon (10 min) + Alpha Vantage (inicio, background)
2. **D√≠a 2:** Descargar con Twelve Data (7 horas)
3. **D√≠a 7:** Completar Alpha Vantage
4. **D√≠a 8:** Normalizar todos (offline, ~1 hora)
5. **D√≠a 9:** Validaciones multi-vendor infinitas (0 API calls)

**Resultado:**
- 3 vendors completos
- 11,054 ticker-days certificados
- Base de datos normalizada permanente
- 0 API calls en validaciones futuras

### Links de Verificaci√≥n

1. **Alpha Vantage:** https://www.alphavantage.co/documentation/#intraday
   - Ver secci√≥n "month parameter"
   - Confirmar outputsize=full

2. **Twelve Data:** https://twelvedata.com/docs#time-series
   - Ver par√°metro outputsize (max 5000)

3. **Polygon:** https://polygon.io/docs/stocks/get_v2_aggs_ticker__stocksticker__range__multiplier___timespan___from___to
   - Ver par√°metro limit (max 50000)

4. **FMP:** https://site.financialmodelingprep.com/developer/docs
   - ‚ö†Ô∏è Documentaci√≥n incompleta para intraday
