# 9.0 - External Data Certification Specification

**Date:** 2025-10-23
**Purpose:** Scientific validation of Polygon data against independent external vendors
**Status:** SPECIFICATION (to be implemented)

---

## 1. Executive Summary

This document specifies a **rigorous, multi-level external data certification framework** that validates our Polygon raw data against multiple independent vendors using strict statistical criteria.

### 1.1 Why This Certification?

The internal certification (7.5-7.7) validates **pipeline integrity** (trades→bars→labels→weights).
This external certification validates **source data quality** by comparing Polygon against:
- Alpha Vantage (independent market data provider)
- Yahoo Finance (widely-used reference)
- IEX Cloud (exchange-sourced data)

### 1.2 What Gets Certified?

| Data Level | Our Source | External Vendors | Comparison Type |
|------------|------------|------------------|-----------------|
| **Trades (ticks)** | `raw/polygon/trades/` | N/A (unavailable free) | Aggregate to minute → compare |
| **Minute Bars** | `raw/polygon/ohlcv_intraday_1m/` | Alpha Vantage, Twelve Data | OHLCV bar-by-bar |
| **Daily Bars (unadj)** | Aggregated from minute | Alpha Vantage, Yahoo Finance | OHLCV daily |
| **Daily Bars (adj)** | Computed with CA factors | Alpha Vantage, Yahoo Finance | Adjusted OHLCV |
| **Splits/Dividends** | `raw/edgar/` or Polygon | Alpha Vantage, Yahoo Finance | Factor consistency |

---

## 2. Certification Levels

### Level 1: Minute Bar Validation (PRIMARY)
**Target:** Validate `ohlcv_intraday_1m` vs Alpha Vantage + Twelve Data
**Why Primary:** Most granular free data available from independent vendors

**Criteria (STRICT):**
| Metric | Threshold | Status |
|--------|-----------|--------|
| **Match Rate** | ≥ 98% | Hard fail if < 98% |
| **Price Deviation (p95)** | ≤ 0.10% | Hard fail if > 0.10% |
| **Price Deviation (mean)** | ≤ 0.05% | Warning if > 0.05% |
| **Volume Deviation (p95)** | ≤ 4% | Hard fail if > 4% |
| **Volume Deviation (mean)** | ≤ 2% | Warning if > 2% |
| **Breaks with \|Δ\|>1%** | ≤ 0.5% of bars | Hard fail if > 0.5% |

### Level 2: Daily Bar Validation (SECONDARY)
**Target:** Validate our aggregated daily bars vs vendor daily bars
**Why Secondary:** Cross-validation that our minute→daily aggregation is correct

**Criteria (VERY STRICT):**
| Metric | Threshold | Status |
|--------|-----------|--------|
| **OHLC Deviation (p95)** | ≤ 0.10% | Hard fail if > 0.10% |
| **OHLC Deviation (mean)** | ≤ 0.05% | Warning if > 0.05% |
| **Volume Deviation (p95)** | ≤ 3% | Hard fail if > 3% |
| **Volume Deviation (mean)** | ≤ 2% | Warning if > 2% |
| **Days with \|Δ\|>0.5%** | ≤ 1% | Hard fail if > 1% |

### Level 3: Corporate Actions Consistency (CRITICAL)
**Target:** Validate that our splits/dividends factors reproduce adjusted closes
**Why Critical:** Ensures no lookahead bias in adjusted prices

**Criteria (EXTREMELY STRICT):**
| Metric | Threshold | Status |
|--------|-----------|--------|
| **Adjusted Close Error (mean)** | ≤ 0.05% | Hard fail if > 0.05% |
| **Adjusted Close Error (p95)** | ≤ 0.10% | Hard fail if > 0.10% |
| **Split Factor Mismatch** | 0 splits | Hard fail if any mismatch |
| **Dividend Factor Error** | ≤ 0.5 bp | Hard fail if > 0.5 bp |

### Level 4: Multi-Vendor Triangulation (ADVANCED)
**Target:** Use 3+ vendors to compute consensus and detect outliers
**Why Advanced:** Identifies systematic biases in any single vendor

**Method:**
1. Compute **median** OHLCV across all vendors per bar
2. Compute **MAD** (Median Absolute Deviation) as robust std dev
3. Flag any vendor with consistent deviation > 3×MAD
4. Flag our data if it consistently deviates from consensus

**Criteria:**
| Metric | Threshold | Status |
|--------|-----------|--------|
| **Our data deviation from consensus** | ≤ 2×MAD | Warning if > 2×MAD |
| **Our data as outlier** | < 5% of bars | Hard fail if ≥ 5% |

---

## 3. Data Sources and API Strategy

### 3.1 Alpha Vantage (PRIMARY EXTERNAL)
**Tier:** FREE (5 calls/min, 100/day remaining)
**Strategy:** 1 call = 1 month of minute data (~20 trading days)

**Endpoints:**
- **Minute:** `TIME_SERIES_INTRADAY&interval=1min&month=YYYY-MM` → ~8000 bars/call
- **Daily (unadj):** `TIME_SERIES_DAILY&outputsize=full` → all history
- **Daily (adj):** `TIME_SERIES_DAILY_ADJUSTED` → with splits/dividends
- **Splits:** Embedded in `TIME_SERIES_DAILY_ADJUSTED`
- **Dividends:** Embedded in `TIME_SERIES_DAILY_ADJUSTED`

**Download Strategy (5 calls):**
- 5 symbols × 1 month each = 100 ticker-days validation
- Save RAW JSON → normalize offline → validate infinitely

### 3.2 Yahoo Finance (SECONDARY EXTERNAL)
**Tier:** FREE (unlimited via yfinance)
**Strategy:** Direct download, no API limits

**Endpoints:**
- **Daily (unadj):** `yf.download(adjusted=False)`
- **Daily (adj):** `yf.download(adjusted=True)`
- **Splits:** `yf.Ticker().splits`
- **Dividends:** `yf.Ticker().dividends`

**Use Case:**
- Second opinion for daily bars
- Independent CA factor verification
- Broad validation (can download 100s of symbols)

### 3.3 Twelve Data (TERTIARY EXTERNAL)
**Tier:** FREE (6/8 calls remaining)
**Strategy:** Spot checks only

**Use Case:**
- Third opinion for minute bars
- Break tie if AV and our data disagree

---

## 4. Validation Workflow

### Phase 1: Download and Normalize (0 API calls after first run)
```
1. Download RAW from vendors (5 AV calls, unlimited Yahoo)
2. Save RAW JSON/CSV to raw_data/
3. Normalize to standard schema:
   - Timestamp: UTC datetime
   - Columns: t, open, high, low, close, volume
   - RTH: Optional (09:30-16:00 ET)
4. Save to normalized/ directory
```

### Phase 2: Multi-Level Comparison
```
For each (symbol, date) sample:
  L1: Minute bars validation
    - Load our minute bars
    - Load AV minute bars
    - Load Twelve Data minute bars
    - Compare OHLCV with strict tolerances
    - Record match rate, deviations, breaks

  L2: Daily bars validation
    - Aggregate our minute → daily
    - Load AV daily (unadj)
    - Load Yahoo daily (unadj)
    - Compare OHLCV

  L3: Corporate actions consistency
    - Load AV adjusted daily
    - Load Yahoo adjusted daily
    - Reconstruct our adjusted using CA factors
    - Compare adjusted closes
    - Validate split/dividend factors match

  L4: Triangulation (if 3+ vendors available)
    - Compute consensus (median per bar)
    - Compute MAD
    - Check if our data is outlier
```

### Phase 3: Statistical Analysis
```
Aggregate across all samples:
  - Mean/median/p95 deviations
  - Match rates by vendor
  - Break analysis (causes of discrepancies)
  - Outlier detection (our data vs consensus)
  - CA factor validation results
```

### Phase 4: GO/NO-GO Decision
```
Apply decision tree:
  IF L1 match_rate < 98% → NO-GO
  IF L1 price_p95 > 0.10% → NO-GO
  IF L2 OHLC_p95 > 0.10% → NO-GO
  IF L3 adj_close_mean > 0.05% → NO-GO
  IF L4 outlier_rate > 5% → WARNING
  ELSE → GO
```

---

## 5. Sample Selection Strategy

### 5.1 Priority Tickers (Must Include - From Our Data)
| Symbol | Rationale | Availability |
|--------|-----------|--------------|
| **WOLF** | Main test case, proven 98.76% match rate | ✅ Validated |
| **AMC** | Meme stock, high volatility, retail focus | ✅ Available |
| **BTBT** | Bitcoin mining, crypto correlation | ✅ Available |
| **GRI** | Small cap, lower volume | ✅ Available |
| **BAER** | Small cap, representative of universe | ✅ Available |
| **NATH** | Small cap, info-rich criteria | ✅ Available |
| **MATH** | Small cap, diverse sector | ✅ Available |

**Note:** All tickers selected from our actual data inventory (3,110 symbols available)

### 5.2 Sampling Criteria
- **Volume diversity:** Low (< $1M/day), Medium ($1-10M), High (> $10M)
- **Volatility diversity:** Low (< 5% daily), Medium (5-15%), High (> 15%)
- **Market cap:** Small cap (primary focus) + large cap (reference)
- **Temporal:** Recent dates (2025) + historical (2024, 2023)
- **Exchange:** NASDAQ, NYSE, AMEX mix

### 5.3 Sample Size
- **Minimum:** 10 ticker-days (quick validation)
- **Recommended:** 50 ticker-days (thorough validation)
- **Comprehensive:** 100+ ticker-days (publication-quality)

**With 5 AV calls:** Each call = 20 days × 1 symbol = 100 ticker-days total

---

## 6. Expected Results

### 6.1 Minute Bars (L1)
**Expected:** 95-99% match rate with AV
**Reasoning:** Minor differences due to:
- Data feed latency (~ms differences)
- Rounding in aggregation
- After-hours vs RTH filtering differences

**RED FLAGS if:**
- Match rate < 95%
- Systematic price bias (mean deviation > 0.05%)
- Volume consistently off by > 5%

### 6.2 Daily Bars (L2)
**Expected:** 98-99.5% match for unadjusted OHLCV
**Reasoning:** Daily aggregation more stable, less variance

**RED FLAGS if:**
- Any OHLC deviation > 0.5%
- Volume deviation > 5%
- Opens/closes don't match (indicates data quality issue)

### 6.3 Corporate Actions (L3)
**Expected:** 99.9% accuracy on adjusted closes
**Reasoning:** CA factors are deterministic, math is exact

**RED FLAGS if:**
- Any adjusted close error > 0.10%
- Missing splits or dividends
- Wrong split ratios

### 6.4 Triangulation (L4)
**Expected:** Our data within 1.5×MAD of consensus 95% of time
**Reasoning:** Consensus should converge, outliers rare

**RED FLAGS if:**
- Consistently outside 2×MAD
- Identified as outlier > 5% of bars

---

## 7. Implementation Plan

### 7.1 Scripts to Create

1. **`external_cert_download.py`**
   - Download from AV, Yahoo, Twelve Data
   - Save RAW responses
   - Output: `raw_data/{vendor}/{symbol}_{date}_raw.json`

2. **`external_cert_normalize.py`**
   - Parse vendor-specific JSON/CSV
   - Standardize schema (t, OHLCV)
   - Handle timezones (UTC), RTH filtering
   - Output: `normalized/{vendor}/{symbol}_{date}_minute.parquet`

3. **`external_cert_validate_L1_minute.py`**
   - Load our minute bars
   - Load vendor minute bars
   - Compare with strict tolerances
   - Output: `validation/L1_minute/{symbol}_{date}_result.json`

4. **`external_cert_validate_L2_daily.py`**
   - Aggregate our minute → daily
   - Load vendor daily (unadj)
   - Compare OHLCV
   - Output: `validation/L2_daily/{symbol}_{date}_result.json`

5. **`external_cert_validate_L3_ca.py`**
   - Load vendor adjusted daily
   - Reconstruct our adjusted from CA factors
   - Validate factor consistency
   - Output: `validation/L3_ca/{symbol}_result.json`

6. **`external_cert_triangulate_L4.py`**
   - Compute consensus across vendors
   - Calculate MAD
   - Detect outliers
   - Output: `validation/L4_triangulation/{symbol}_{date}_result.json`

7. **`external_cert_report.py`**
   - Aggregate all validation results
   - Compute summary statistics
   - Apply GO/NO-GO decision tree
   - Output: `EXTERNAL_CERTIFICATION_REPORT.md`

### 7.2 Directory Structure

```
01_DayBook/fase_02/F_auditoria_data/external_cert/
├── raw_data/                  # Raw vendor responses
│   ├── alphavantage/
│   ├── yahoo/
│   └── twelvedata/
├── normalized/                # Normalized minute/daily bars
│   ├── alphavantage/
│   ├── yahoo/
│   └── twelvedata/
├── validation/                # Validation results
│   ├── L1_minute/
│   ├── L2_daily/
│   ├── L3_ca/
│   └── L4_triangulation/
├── scripts/
│   ├── external_cert_download.py
│   ├── external_cert_normalize.py
│   ├── external_cert_validate_L1_minute.py
│   ├── external_cert_validate_L2_daily.py
│   ├── external_cert_validate_L3_ca.py
│   ├── external_cert_triangulate_L4.py
│   └── external_cert_report.py
├── config/
│   └── samples.yaml           # Sample selection config
└── EXTERNAL_CERTIFICATION_REPORT.md  # Final report
```

---

## 8. Success Criteria (GO/NO-GO)

### 8.1 Hard Requirements (Must Pass)

| Check | Requirement | Consequence if Fail |
|-------|-------------|---------------------|
| **L1 Match Rate** | ≥ 98% | NO-GO - Data quality issue |
| **L1 Price p95** | ≤ 0.10% | NO-GO - Systematic bias |
| **L1 Volume p95** | ≤ 4% | NO-GO - Volume calculation error |
| **L2 OHLC p95** | ≤ 0.10% | NO-GO - Aggregation error |
| **L3 Adj Close mean** | ≤ 0.05% | NO-GO - CA factors wrong |
| **L3 Split Factors** | 100% match | NO-GO - Missing/wrong splits |

### 8.2 Soft Requirements (Warnings)

| Check | Requirement | Consequence if Fail |
|-------|-------------|---------------------|
| **L1 Price mean** | ≤ 0.05% | WARNING - Review systematic bias |
| **L1 Volume mean** | ≤ 2% | WARNING - Check volume calculation |
| **L2 OHLC mean** | ≤ 0.05% | WARNING - Minor aggregation issue |
| **L4 Outlier rate** | < 5% | WARNING - Check vendor consensus |

### 8.3 Final Decision Tree

```
IF any hard requirement fails:
    status = NO-GO
    action = "Fix data quality issue before production"
ELIF 2+ soft requirements fail:
    status = GO with WARNINGS
    action = "Review warnings, may proceed with caution"
ELSE:
    status = GO
    action = "Data certified for production"
```

---

## 9. Timeline and Resources

### 9.1 Implementation Timeline
| Phase | Duration | Tasks |
|-------|----------|-------|
| **Phase 1** | 2 hours | Create download/normalize scripts |
| **Phase 2** | 3 hours | Create L1-L4 validation scripts |
| **Phase 3** | 1 hour | Execute validation (5 AV calls + Yahoo) |
| **Phase 4** | 1 hour | Generate final report |
| **Total** | ~7 hours | End-to-end implementation + validation |

### 9.2 API Budget
| Vendor | Calls Needed | Calls Available | Status |
|--------|--------------|-----------------|--------|
| Alpha Vantage | 5 | 5 | ✅ Sufficient |
| Yahoo Finance | Unlimited | Unlimited | ✅ Sufficient |
| Twelve Data | 3 (spot checks) | 6 | ✅ Sufficient |

### 9.3 Compute Resources
- **Disk:** ~5GB for raw + normalized data
- **RAM:** ~4GB for validation processing
- **CPU:** Multi-core for parallel validation
- **Time:** ~30 mins for full validation run

---

## 10. Deliverables

### 10.1 Technical Deliverables
1. ✅ 7 validation scripts (download, normalize, L1-L4, report)
2. ✅ Normalized vendor data (offline validation capability)
3. ✅ Validation results (JSON per sample)
4. ✅ Statistical summary (aggregated metrics)
5. ✅ GO/NO-GO decision with justification

### 10.2 Documentation Deliverables
1. ✅ `9.0_EXTERNAL_DATA_CERTIFICATION_SPEC.md` (this document)
2. ✅ `9.1_EXTERNAL_CERTIFICATION_REPORT.md` (final results)
3. ✅ `README_EXTERNAL_CERT.md` (usage instructions)
4. ✅ Sample selection rationale (config/samples.yaml)

---

## 11. Next Steps

1. **Create download/normalize scripts** (Phase 1)
2. **Execute 5 strategic AV downloads** (1 month each)
3. **Download Yahoo data** (unlimited, broad validation)
4. **Run L1-L4 validations**
5. **Generate final certification report**
6. **Make GO/NO-GO decision**

---

**Status:** 📋 SPECIFICATION COMPLETE
**Next:** 🔧 IMPLEMENTATION
**Goal:** 🎯 Achieve GO certification with 99%+ confidence
