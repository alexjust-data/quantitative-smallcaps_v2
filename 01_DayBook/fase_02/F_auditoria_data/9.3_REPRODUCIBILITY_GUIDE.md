# 9.3 - External Data Certification - Reproducibility Guide

**Purpose:** Complete step-by-step guide to reproduce the entire external data certification
**Audience:** Independent auditors, researchers, or team members
**Time Required:** ~2-3 hours (including downloads)

---

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Environment Setup](#environment-setup)
3. [Data Inventory Audit](#data-inventory-audit)
4. [Level 1: Minute Bar Validation](#level-1-minute-bar-validation)
5. [Level 2-4: Complete Validation](#level-2-4-complete-validation)
6. [Results Verification](#results-verification)
7. [Expected Results](#expected-results)
8. [Troubleshooting](#troubleshooting)

---

## Prerequisites

### Required Software
- **Python:** 3.10+ (tested with 3.13)
- **Git:** For cloning the repository
- **pip:** Python package manager

### Required Packages
```bash
pip install polars pandas numpy requests pyyaml yfinance python-dotenv
```

### API Keys Required
You need FREE API keys from:
1. **Alpha Vantage:** https://www.alphavantage.co/support/#api-key (FREE - 5 calls/min, 100/day)
2. **Twelve Data:** https://twelvedata.com/ (FREE - 8 calls/min)
3. **Yahoo Finance:** No API key needed (via yfinance library)

### Hardware Requirements
- **Disk:** ~10GB free space (for raw data + our data)
- **RAM:** 4GB minimum (8GB recommended)
- **CPU:** Multi-core recommended for faster processing

---

## Environment Setup

### Step 1: Clone Repository

```bash
# Clone the repository
git clone https://github.com/alexjust-data/quantitative-smallcaps_v2.git
cd quantitative-smallcaps_v2
```

### Step 2: Create Environment File

Create a `.env` file in the project root:

```bash
# In project root: D:\04_TRADING_SMALLCAPS\.env
ALPHAVANTAGE_API_KEY=your_alpha_vantage_key_here
TWELVEDATA_API_KEY=your_twelve_data_key_here
POLYGON_API_KEY=your_polygon_key_here
```

**Note:** Replace with your actual API keys

### Step 3: Install Dependencies

```bash
# Create virtual environment (optional but recommended)
python -m venv venv
source venv/bin/activate  # Linux/Mac
# or
.\venv\Scripts\activate   # Windows

# Install requirements
pip install polars pandas numpy requests pyyaml yfinance python-dotenv
```

### Step 4: Verify Data Availability

Check that you have access to the raw Polygon data:

```bash
# Check minute data
ls raw/polygon/ohlcv_intraday_1m/

# Should show ~3,110 ticker directories
# Example: WOLF, AMC, BTBT, GRI, BAER, etc.
```

If data is not available, you need to run the data download pipeline first (fase_01).

---

## Data Inventory Audit

Before external validation, audit what data we have:

### Step 1: Run Data Inventory Script

```bash
cd 01_DayBook/fase_02/F_auditoria_data/independent_audit_multi_wrds/independent_audit_multi

python audit_fase01_data.py \
    --raw-root "D:\04_TRADING_SMALLCAPS\raw\polygon" \
    --output audit_fase01_report.json
```

**Expected Output:**
```
[SCANNING] trades/
  -> 1906 symbols, 22108 files

[SCANNING] ohlcv_intraday_1m/
  -> 3107 symbols, 300605 files

[SCANNING] ohlcv_daily/
  -> 3106 symbols, 30533 files
```

**Verification:**
- Check that `audit_fase01_report.json` was created
- Verify ~3,100 symbols available
- Confirm minute bars exist for priority tickers (WOLF, AMC, BTBT, GRI, BAER)

---

## Level 1: Minute Bar Validation

This is the **PRIMARY validation** - comparing our minute bars against Alpha Vantage.

### Step 1: Download External Vendor Data

```bash
cd 01_DayBook/fase_02/F_auditoria_data/external_cert/scripts

# Download from all vendors (Alpha Vantage, Yahoo, Twelve Data)
python external_cert_download.py \
    --config ../config/samples.yaml \
    --vendors alphavantage yahoo twelvedata
```

**What this does:**
- Downloads 5 months of minute data from Alpha Vantage (1 call per month)
- Downloads daily data + corporate actions from Yahoo Finance (unlimited)
- Downloads spot check minute data from Twelve Data (5 calls)

**API Calls Used:**
- Alpha Vantage: 5 calls (out of 100/day limit)
- Twelve Data: 5 calls (out of 8/min limit)
- Yahoo Finance: Unlimited (no limit)

**Expected Output:**
```
======================================================================
EXTERNAL CERTIFICATION - DATA DOWNLOAD
======================================================================

[INFO] 5 priority tickers to download

======================================================================
SYMBOL: WOLF
======================================================================
[OK] WOLF 2025-05 - 825 minute bars downloaded

======================================================================
SYMBOL: AMC
======================================================================
[OK] AMC 2025-05 - 782 minute bars downloaded
...

======================================================================
DOWNLOAD SUMMARY
======================================================================

ALPHAVANTAGE:
  Success: 5
  Errors:  0
  Success Rate: 100.0%

YAHOO:
  Success: 5
  Errors:  0
  Success Rate: 100.0%

TWELVEDATA:
  Success: 5
  Errors:  0
  Success Rate: 100.0%
```

**Verification:**
```bash
# Check raw data was downloaded
ls ../raw_data/alphavantage/
# Should show: WOLF_2025-05_alphavantage_raw.json, AMC_2025-05_alphavantage_raw.json, etc.

ls ../raw_data/yahoo/
# Should show: AMC_2025-05-13_2025-05-15_yahoo_unadj.csv, etc.

ls ../raw_data/twelvedata/
# Should show: WOLF_2025-05-13_twelvedata_raw.json, etc.
```

### Step 2: Run L1 Minute Bar Comparison

```bash
cd 01_DayBook/fase_02/F_auditoria_data/independent_audit_multi_wrds/independent_audit_multi

python strategic_comparison_minute.py \
    --our-minute-root "D:\04_TRADING_SMALLCAPS\raw\polygon\ohlcv_intraday_1m" \
    --samples "WOLF,2025-05-13" "AMC,2025-05-13" "BTBT,2025-05-13" "GRI,2025-05-13" "BAER,2025-05-13" \
    --vendors alphavantage \
    --output-dir ../../F_auditoria_data/external_cert/validation/L1_minute
```

**What this does:**
- Loads our minute bars for each ticker
- Loads Alpha Vantage minute bars
- Compares OHLCV bar-by-bar with strict tolerances
- Calculates match rate and deviation statistics

**Expected Output:**
```
======================================================================
SAMPLE: WOLF @ 2025-05-13
======================================================================
[LOADED] WOLF 2025-05-13 - 725 bars from our data
[DOWNLOADED] alphavantage - 825 bars

[RESULT] alphavantage Comparison:
  Rows compared: 725
  Match rate: 98.76%
  Breaks: 9
  Avg price diff: 0.093%
  Avg volume diff: 0.502%

======================================================================
SAMPLE: AMC @ 2025-05-13
======================================================================
[RESULT] alphavantage Comparison:
  Match rate: 98.69%
  ...

======================================================================
SUMMARY
======================================================================
Total samples: 5
Successful comparisons: 5
Average match rate: 99.01%
```

**Verification:**
```bash
# Check validation results were created
ls ../../F_auditoria_data/external_cert/validation/L1_minute/

# Should show:
# WOLF_2025-05-13_comparison.json
# AMC_2025-05-13_comparison.json
# BTBT_2025-05-13_comparison.json
# GRI_2025-05-13_comparison.json
# BAER_2025-05-13_comparison.json
# comparison_summary.json
```

### Step 3: Review L1 Results

```bash
# View summary
cat ../../F_auditoria_data/external_cert/validation/L1_minute/comparison_summary.json
```

**Expected Values:**
- `average_match_rate`: ~0.99 (99%)
- `successful_comparisons`: 5
- All tickers should show `status: "success"`

**Pass Criteria:**
- ✅ Average match rate ≥ 98%
- ✅ Price deviation ≤ 0.10%
- ✅ Volume deviation ≤ 4%

---

## Level 2-4: Complete Validation

Run the comprehensive validation for all remaining levels:

### Step 1: Execute All Levels

```bash
cd 01_DayBook/fase_02/F_auditoria_data/external_cert/scripts

python validate_all_levels.py
```

**What this does:**
- **L2:** Compares our minute→daily aggregation vs Yahoo Finance daily bars
- **L3:** Documents corporate actions (splits, dividends) from Yahoo Finance
- **L4:** Performs multi-vendor triangulation and outlier detection

**Expected Output:**
```
======================================================================
COMPREHENSIVE EXTERNAL CERTIFICATION
Levels 2, 3, 4
======================================================================

======================================================================
LEVEL 2: DAILY BARS VALIDATION
======================================================================

[L2] Validating AMC @ 2025-05-13
  Our daily: O=2.76 H=2.82 L=2.73 C=2.75 V=7424257
  OHLC diff: O=0.000% H=0.000% L=0.000% C=0.000%
  Volume diff: 0.000%
  Status: PASS

[L2] Validating BTBT @ 2025-05-13
  ...

======================================================================
L2 SUMMARY
======================================================================
Tickers validated: 4
Passed: 4/4
Avg OHLC diff: 0.025%
Avg Volume diff: 0.350%

L2 Overall: PASS

======================================================================
LEVEL 3: CORPORATE ACTIONS VALIDATION
======================================================================

[L3] AMC - 1 splits found
  {'Stock Splits': {Timestamp('2023-08-24'): 0.1}}

[L3] AMC - 25 dividends found

[L3] GRI - 4 splits found
  ...

======================================================================
L3 SUMMARY
======================================================================
Corporate actions documented: 3
L3 Status: PASS (CA data available for validation)

======================================================================
LEVEL 4: MULTI-VENDOR TRIANGULATION
======================================================================

[L4] Computing consensus across 3 vendors...
  Vendors: Polygon (ours), Alpha Vantage, Twelve Data

[L4] Analysis:
  - Polygon (our primary): 99.01% match vs Alpha Vantage
  - No systematic bias detected
  - Outlier rate: <1% (well below 5% threshold)

======================================================================
L4 SUMMARY
======================================================================
Multi-vendor triangulation: PASS
Our data: NOT an outlier
Consensus achieved with 3+ independent sources

======================================================================
FINAL CERTIFICATION SUMMARY
======================================================================
L1 (Minute Bars): PASS (99.01% match rate)
L2 (Daily Bars): PASS
L3 (Corporate Actions): PASS
L4 (Triangulation): PASS

======================================================================
FINAL DECISION: GO
======================================================================

Results saved to: ../validation/full_certification_results.json
```

### Step 2: Review Complete Results

```bash
# View full certification results
cat ../validation/full_certification_results.json
```

**Expected Structure:**
```json
{
  "timestamp": "2025-10-23T...",
  "L1": {
    "status": "PASS",
    "match_rate": 0.9901
  },
  "L2": {
    "status": "PASS",
    "avg_ohlc_diff": 0.025,
    "avg_vol_diff": 0.350
  },
  "L3": {
    "status": "PASS",
    "results": [...]
  },
  "L4": {
    "status": "PASS",
    "outlier_rate": 0.01
  },
  "final_decision": "GO"
}
```

---

## Results Verification

### Verification Checklist

- [ ] **L1 Results:**
  - `comparison_summary.json` exists
  - Average match rate ≥ 98%
  - All 5 tickers have comparison JSON files

- [ ] **L2 Results:**
  - Daily aggregations computed
  - OHLC deviations ≤ 0.10%

- [ ] **L3 Results:**
  - Corporate actions documented (AMC: 1 split + 25 divs, GRI: 4 splits)
  - CSV files exist in `raw_data/yahoo/`

- [ ] **L4 Results:**
  - Outlier rate < 5%
  - Multi-vendor consensus achieved

- [ ] **Final Decision:**
  - `final_decision: "GO"` in `full_certification_results.json`

### File Structure Verification

```
external_cert/
├── raw_data/
│   ├── alphavantage/
│   │   ├── WOLF_2025-05_alphavantage_raw.json
│   │   ├── AMC_2025-05_alphavantage_raw.json
│   │   └── ... (5 files)
│   ├── yahoo/
│   │   ├── AMC_2025-05-13_2025-05-15_yahoo_unadj.csv
│   │   ├── AMC_yahoo_splits.csv
│   │   ├── AMC_yahoo_dividends.csv
│   │   └── ... (multiple files)
│   └── twelvedata/
│       ├── WOLF_2025-05-13_twelvedata_raw.json
│       └── ... (5 files)
├── validation/
│   ├── L1_minute/
│   │   ├── WOLF_2025-05-13_comparison.json
│   │   ├── AMC_2025-05-13_comparison.json
│   │   ├── ... (5 files)
│   │   └── comparison_summary.json
│   └── full_certification_results.json
└── scripts/
    ├── external_cert_download.py
    ├── strategic_comparison_minute.py
    └── validate_all_levels.py
```

---

## Expected Results

### Level 1: Minute Bars

| Ticker | Expected Match Rate | Expected Price Diff | Expected Volume Diff |
|--------|---------------------|---------------------|----------------------|
| WOLF | 98.5-99.0% | < 0.1% | < 1% |
| AMC | 98.5-99.0% | < 0.1% | < 1% |
| BTBT | 99.0-99.5% | < 0.05% | < 0.5% |
| GRI | 98.5-99.0% | < 0.1% | < 0.1% |
| BAER | 99.0-99.5% | < 0.02% | < 1% |

**Average:** 99.0-99.2% match rate

### Level 2: Daily Bars

Expected OHLC deviations: < 0.10%
Expected volume deviations: < 3%

### Level 3: Corporate Actions

**AMC:**
- 1 reverse split (1:10) on 2023-08-24
- 25 historical dividends

**GRI:**
- 4 reverse splits (multiple rounds)

### Level 4: Triangulation

- Outlier rate: < 1%
- Consensus: All vendors within 1% deviation
- Status: PASS

---

## Troubleshooting

### Issue: API Rate Limit Exceeded

**Error:** `Note: Thank you for using Alpha Vantage! Our standard API call frequency is 5 calls per minute...`

**Solution:**
- Wait 1 minute and retry
- Use `--delay 12` flag in download script (12 seconds = 5 calls/min)

### Issue: Missing API Key

**Error:** `ALPHAVANTAGE_API_KEY not set`

**Solution:**
1. Check `.env` file exists in project root
2. Verify API key is correctly formatted
3. Restart terminal to reload environment variables

### Issue: Ticker Data Not Found

**Error:** `[WARN] No minute data found for NVDA 2025-05-13`

**Solution:**
- This is expected - we only have small-cap tickers
- Use tickers from our inventory: WOLF, AMC, BTBT, GRI, BAER
- Check available tickers: `ls raw/polygon/ohlcv_intraday_1m/`

### Issue: Unicode Encoding Error (Windows)

**Error:** `UnicodeEncodeError: 'charmap' codec can't encode character`

**Solution:**
- This is cosmetic (emoji in output)
- Script still runs successfully
- Can be ignored or redirected: `2>&1 | iconv -f utf-8 -t ascii//TRANSLIT`

### Issue: Python Package Not Found

**Error:** `ModuleNotFoundError: No module named 'polars'`

**Solution:**
```bash
pip install polars pandas numpy requests pyyaml yfinance python-dotenv
```

---

## Time Estimates

| Phase | Time |
|-------|------|
| Environment setup | 10 minutes |
| Data inventory audit | 5 minutes |
| Download vendor data | 5-10 minutes (depends on API rate limits) |
| L1 validation (5 tickers) | 5 minutes |
| L2-L4 validation | 2 minutes |
| Review results | 5 minutes |
| **Total** | **~30-40 minutes** |

**Note:** If you already have vendor data downloaded, time reduces to ~15 minutes.

---

## Success Criteria

Your certification is successful if:

✅ **L1:** Average match rate ≥ 98%
✅ **L1:** Price deviation ≤ 0.10%
✅ **L1:** Volume deviation ≤ 4%
✅ **L2:** Daily aggregations validated
✅ **L3:** Corporate actions documented
✅ **L4:** Outlier rate < 5%
✅ **Final Decision:** "GO"

---

## Contact & Support

If you encounter issues reproducing these results:

1. **Check Documentation:**
   - `8.7.2_EXTERNAL_DATA_CERTIFICATION_SPEC.md` - Full specification
   - `9.1_EXTERNAL_CERTIFICATION_FINAL_REPORT.md` - Original results
   - `9.2_COMPLETE_4LEVEL_CERTIFICATION.md` - Complete results

2. **GitHub Issues:**
   - Create an issue at: https://github.com/alexjust-data/quantitative-smallcaps_v2/issues
   - Include error messages and environment details

3. **Data Requirements:**
   - Ensure you have access to `raw/polygon/ohlcv_intraday_1m/`
   - Minimum 5 tickers required: WOLF, AMC, BTBT, GRI, BAER

---

## References

- **Original Specification:** [8.7.2_EXTERNAL_DATA_CERTIFICATION_SPEC.md](8.7.2_EXTERNAL_DATA_CERTIFICATION_SPEC.md)
- **Final Results:** [9.2_COMPLETE_4LEVEL_CERTIFICATION.md](9.2_COMPLETE_4LEVEL_CERTIFICATION.md)
- **Alpha Vantage API Docs:** https://www.alphavantage.co/documentation/
- **Yahoo Finance (yfinance):** https://pypi.org/project/yfinance/
- **Twelve Data API Docs:** https://twelvedata.com/docs

---

**Last Updated:** 2025-10-23
**Version:** 1.0
**Status:** Production-Ready
