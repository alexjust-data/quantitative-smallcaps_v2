# 8.5 Gu√≠a Completa: Auditor√≠a Multi-Vendor

**Sistema:** `independent_audit_multi/`
**Ubicaci√≥n:** `D:\04_TRADING_SMALLCAPS\01_DayBook\fase_02\F_auditoria_data\independent_audit_multi\independent_audit_multi`
**Prop√≥sito:** Validaci√≥n cruzada contra m√∫ltiples proveedores externos (Polygon + IEX + Finnhub + CSV custom)

---

## üéØ Por Qu√© Multi-Vendor es Certificaci√≥n Cient√≠fica

### **Ventajas de Comparar Contra M√∫ltiples Fuentes**

| Aspecto | Single Vendor | Multi-Vendor |
|---------|---------------|--------------|
| **Riesgo de correlaci√≥n** | Alto (si vendor tiene error, no lo detectas) | Bajo (3+ vendors independientes) |
| **Robustez estad√≠stica** | Media (95% match rate) | Alta (‚â•95% en 3+ vendors) |
| **Auditabilidad** | B√°sica | Institucional (hedge fund level) |
| **Detecci√≥n de anomal√≠as** | Solo si muy obvias | Triangulaci√≥n precisa |
| **Costo de confianza** | Gratis-bajo | Gratis-bajo (free tiers) |

### **Ejemplo de Triangulaci√≥n**

```
Tus datos vs Polygon:   match_rate = 0.984 (98.4%)
Tus datos vs IEX:       match_rate = 0.978 (97.8%)
Tus datos vs Finnhub:   match_rate = 0.982 (98.2%)

Conclusi√≥n:
- Consistencia alta en los 3 vendors ‚Üí DATOS CERTIFICADOS ‚úÖ
- Si solo Polygon tuviera 98% y los dem√°s <90% ‚Üí Investigar pipeline
- Si todos tienen <90% ‚Üí Problema en tus datos
```

---

## üìÅ Estructura del Sistema Multi-Vendor

```
independent_audit_multi/
‚îú‚îÄ‚îÄ verify_against_references.py   # Script principal multi-vendor
‚îú‚îÄ‚îÄ make_report_md.py               # Generador de reportes
‚îú‚îÄ‚îÄ requirements.txt                # Dependencias
‚îú‚îÄ‚îÄ README.md                       # Documentaci√≥n t√©cnica
‚îú‚îÄ‚îÄ vendors/
‚îÇ   ‚îú‚îÄ‚îÄ polygon_client.py           # Polygon.io API
‚îÇ   ‚îú‚îÄ‚îÄ iex_client.py               # IEX Cloud API
‚îÇ   ‚îú‚îÄ‚îÄ finnhub_client.py           # Finnhub API
‚îÇ   ‚îî‚îÄ‚îÄ csv_client.py               # CSV local (TAQ/SIP/custom)
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ compare_minute.py           # Comparador OHLCV
‚îî‚îÄ‚îÄ reports/
    ‚îú‚îÄ‚îÄ *.json                      # Resultados JSON
    ‚îî‚îÄ‚îÄ *.md                        # Reportes markdown
```

---

## üîß Vendors Soportados

### **1. Polygon.io**

**Qu√© ofrece:**
- Datos hist√≥ricos de minuto para acciones US
- Free tier: 5 calls/minuto, √∫ltimos 2 a√±os
- Datos ajustados por splits/dividends

**Configuraci√≥n:**
```bash
# Obtener API key en https://polygon.io/
export POLYGON_API_KEY="tu_key_aqui"
```

**Uso:**
```bash
--vendors polygon
```

---

### **2. IEX Cloud**

**Qu√© ofrece:**
- Datos de 1 minuto de IEX Exchange
- Free tier: √∫ltimos 12 meses
- Datos de calidad institucional

**Configuraci√≥n:**
```bash
# Obtener token en https://iexcloud.io/
export IEX_API_TOKEN="tu_token_aqui"
```

**Uso:**
```bash
--vendors iex
```

**Nota:** IEX devuelve datos en Eastern Time (ET), el script los convierte autom√°ticamente a UTC.

---

### **3. Finnhub**

**Qu√© ofrece:**
- Datos de 1 minuto global (US + internacional)
- Free tier: 60 API calls/minuto
- Cobertura amplia

**Configuraci√≥n:**
```bash
# Obtener API key en https://finnhub.io/
export FINNHUB_API_KEY="tu_key_aqui"
```

**Uso:**
```bash
--vendors finnhub
```

---

### **4. CSV Custom (TAQ/SIP/WRDS)**

**Qu√© ofrece:**
- Soporte para datos propios en formato CSV
- √ötil si tienes acceso a:
  - TAQ (Trade and Quote)
  - SIP (Securities Information Processor)
  - WRDS (Wharton Research Data Services)
  - Otros datos institucionales

**Estructura requerida:**
```
csv_root/
‚îú‚îÄ‚îÄ WOLF/
‚îÇ   ‚îî‚îÄ‚îÄ date=2025-05-13/
‚îÇ       ‚îî‚îÄ‚îÄ minute.csv
‚îú‚îÄ‚îÄ SINT/
‚îÇ   ‚îî‚îÄ‚îÄ date=2024-04-17/
‚îÇ       ‚îî‚îÄ‚îÄ minute.csv
```

**Formato CSV:**
```csv
t,open,high,low,close,volume
2025-05-13T13:30:00Z,12.45,12.67,12.42,12.65,16125
2025-05-13T13:31:00Z,12.66,12.78,12.64,12.75,18234
...
```

**Configuraci√≥n:**
```bash
--vendors csv --csv-root "D:/references/taq_minute"
```

---

## üöÄ Gu√≠a de Uso Paso a Paso

### **Paso 1: Instalaci√≥n**

```bash
cd D:/04_TRADING_SMALLCAPS/01_DayBook/fase_02/F_auditoria_data/independent_audit_multi/independent_audit_multi

# Crear entorno virtual
python -m venv .venv
.venv\Scripts\activate  # Windows
# source .venv/bin/activate  # Linux/Mac

# Instalar dependencias
pip install -r requirements.txt
```

**Dependencias:**
```
polars>=1.6.0
pyarrow
pandas
requests
numpy
pytz
```

---

### **Paso 2: Configurar API Keys**

```powershell
# PowerShell (Windows)
$env:POLYGON_API_KEY="tu_polygon_key"
$env:IEX_API_TOKEN="tu_iex_token"
$env:FINNHUB_API_KEY="tu_finnhub_key"
```

```bash
# Bash (Linux/Mac)
export POLYGON_API_KEY="tu_polygon_key"
export IEX_API_TOKEN="tu_iex_token"
export FINNHUB_API_KEY="tu_finnhub_key"
```

---

### **Paso 3: Ejecutar Auditor√≠a Multi-Vendor**

#### **Ejemplo 1: Comparaci√≥n Doble (Polygon + IEX)**

```bash
python verify_against_references.py \
  --symbols WOLF,SINT,SGD \
  --dates 2025-05-13 \
  --vendors polygon,iex \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/audit_polygon_iex.json
```

**Output esperado:**
```
Wrote report: reports/audit_polygon_iex.json
Overall: {'polygon': 0.9842, 'iex': 0.9781}
```

---

#### **Ejemplo 2: Comparaci√≥n Triple (Polygon + IEX + Finnhub)**

```bash
python verify_against_references.py \
  --symbols WOLF \
  --dates 2025-05-13,2025-05-14,2025-05-15 \
  --vendors polygon,iex,finnhub \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --price-tol 0.001 \
  --vol-tol 0.03 \
  --out reports/audit_triple_wolf.json
```

**Tolerancias ajustadas:**
- `--price-tol 0.001` = 0.1% (m√°s estricto que default 0.2%)
- `--vol-tol 0.03` = 3% (m√°s estricto que default 5%)

---

#### **Ejemplo 3: Comparaci√≥n con CSV Custom (TAQ/SIP)**

Si tienes datos TAQ/SIP propios agregados a minuto:

```bash
python verify_against_references.py \
  --symbols AMC,AAPL \
  --dates 2024-05-17 \
  --vendors polygon,csv \
  --csv-root "D:/references/taq_minute" \
  --our-minute-root "D:/04_TRADING_SMALLCAPS/processed/minute" \
  --out reports/audit_vs_taq.json
```

---

#### **Ejemplo 4: Auditor√≠a Pre-Producci√≥n Completa**

```bash
# Top 10 tickers, √∫ltimos 5 d√≠as, 3 vendors
python verify_against_references.py \
  --symbols WOLF,SINT,SGD,STSS,PRFX,TDOC,SI,MAXN,LIMN,KSS \
  --dates 2025-10-17,2025-10-18,2025-10-21,2025-10-22,2025-10-23 \
  --vendors polygon,iex,finnhub \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --price-tol 0.002 \
  --vol-tol 0.05 \
  --out reports/pre_production_multi.json
```

---

### **Paso 4: Generar Reporte Markdown**

```bash
python make_report_md.py \
  --input reports/audit_polygon_iex.json \
  --output reports/MULTI_VENDOR_AUDIT_REPORT.md \
  --title "Multi-Vendor Audit: Polygon + IEX + Finnhub"
```

**Output:** `reports/MULTI_VENDOR_AUDIT_REPORT.md`

---

## üìä Estructura del Output JSON

```json
{
  "vendors": ["polygon", "iex", "finnhub"],
  "symbols": ["WOLF", "SINT", "SGD"],
  "dates": ["2025-05-13"],
  "price_tol": 0.002,
  "vol_tol": 0.05,
  "items": [
    {
      "symbol": "WOLF",
      "date": "2025-05-13",
      "vendors": {
        "polygon": {
          "rows_compared": 390,
          "match_rate": 0.9872,
          "stats": {
            "rows": 390,
            "passed": 385,
            "mean_d_price": 0.0008,
            "mean_d_vol": 0.0234,
            "p95_d_price": 0.0015,
            "p95_d_vol": 0.0456
          },
          "breaks": [
            {
              "t_min": "2025-05-13T13:45:00Z",
              "open_ref": 12.45,
              "open_ours": 12.48,
              "d_price_max": 0.0241,
              "d_vol": 0.0823
            }
          ]
        },
        "iex": {
          "rows_compared": 385,
          "match_rate": 0.9781,
          "stats": {...},
          "breaks": [...]
        },
        "finnhub": {
          "rows_compared": 388,
          "match_rate": 0.9820,
          "stats": {...},
          "breaks": [...]
        }
      }
    }
  ],
  "overall_match_rate": {
    "polygon": 0.9872,
    "iex": 0.9781,
    "finnhub": 0.9820
  }
}
```

---

## üìà Interpretaci√≥n de Resultados Multi-Vendor

### **Escenario 1: Todos los Vendors ‚â• 95% (GO)**

```
polygon:  98.4%
iex:      97.8%
finnhub:  98.2%
```

‚úÖ **Interpretaci√≥n:**
- Datos validados por 3 fuentes independientes
- Diferencias menores (<2%) normales por filtros vendor
- Pipeline certificado para producci√≥n

‚úÖ **Acci√≥n:**
- Documentar resultados en audit trail
- Incluir en compliance report
- Continuar con deployment

---

### **Escenario 2: 1 Vendor Bajo, Otros Altos (WARNING)**

```
polygon:  98.4%
iex:      88.2%  ‚Üê BAJO
finnhub:  97.9%
```

‚ö†Ô∏è **Interpretaci√≥n:**
- Posible problema con vendor IEX (API issues, coverage limitada)
- Tus datos probablemente correctos (2/3 vendors validan)
- Revisar si IEX tiene datos para esos tickers/fechas

‚ö†Ô∏è **Acci√≥n:**
1. Revisar `breaks` espec√≠ficos de IEX en JSON
2. Verificar cobertura de IEX para tus s√≠mbolos
3. Re-run solo con IEX en otra fecha para confirmar
4. Si persiste, descartar IEX y confiar en Polygon + Finnhub

---

### **Escenario 3: Todos los Vendors Bajos (NO-GO)**

```
polygon:  85.2%  ‚Üê BAJO
iex:      82.7%  ‚Üê BAJO
finnhub:  83.4%  ‚Üê BAJO
```

‚ùå **Interpretaci√≥n:**
- Problema sist√©mico en tus datos o pipeline
- No es coincidencia que 3 vendors independientes fallen
- Cr√≠tico: NO usar en producci√≥n

‚ùå **Acci√≥n:**
1. **Auditar pipeline completo:**
   - Verificar timestamp conversion (ns ‚Üí Œºs ‚Üí UTC)
   - Revisar agregaci√≥n DIB ‚Üí minute
   - Validar que no hay data corruption (run A01-A08)

2. **Revisar breaks detalladamente:**
```bash
cat reports/audit.json | jq '.items[].vendors.polygon.breaks | .[] | select(.d_price_max > 0.05)'
```

3. **Comparar contra TradingView manualmente:**
   - Usar `verify_bar_tradingview.py` para muestras
   - Verificar visualmente algunos eventos

4. **Re-ejecutar certification suite:**
```bash
cd scripts/fase_E_DataAnalysis/smallcaps_data_cert_suite
python run_all_checks.py
```

---

### **Escenario 4: Resultados Mixtos (INVESTIGAR)**

```
polygon:  97.2%
iex:      92.5%  ‚Üê MEDIO
finnhub:  96.8%
```

‚ö†Ô∏è **Interpretaci√≥n:**
- IEX en zona gris (90-95%)
- Polygon + Finnhub validan, pero IEX sugiere investigar
- Puede ser normal por diferencias de coverage/filtros

‚ö†Ô∏è **Acci√≥n:**
1. Calcular **promedio ponderado:**
```
avg = (97.2 + 92.5 + 96.8) / 3 = 95.5% ‚Üí ACEPTABLE
```

2. Revisar `breaks` de IEX:
   - ¬øSon en horarios espec√≠ficos? (pre-market, close)
   - ¬øSon tickers espec√≠ficos? (low volume stocks)
   - ¬øSon fechas espec√≠ficas? (holidays, halts)

3. Si breaks son sistem√°ticos ‚Üí investigar
4. Si breaks son aleatorios ‚Üí aceptable (vendor filtering)

---

## üîç An√°lisis Avanzado de Breaks

### **Extraer Breaks por Vendor**

```bash
# Breaks de Polygon
cat reports/audit.json | jq '.items[].vendors.polygon.breaks | .[]'

# Breaks de IEX con precio > 5% off
cat reports/audit.json | jq '.items[].vendors.iex.breaks | .[] | select(.d_price_max > 0.05)'

# Breaks comunes a todos los vendors
cat reports/audit.json | jq '
  .items[] |
  select(
    (.vendors.polygon.breaks | length > 0) and
    (.vendors.iex.breaks | length > 0) and
    (.vendors.finnhub.breaks | length > 0)
  )
'
```

### **Visualizar Breaks en Python**

```python
import json, pandas as pd

# Cargar resultados
with open('reports/audit.json') as f:
    data = json.load(f)

# Extraer breaks por vendor
breaks_polygon = []
breaks_iex = []
breaks_finnhub = []

for item in data['items']:
    symbol = item['symbol']
    date = item['date']

    for b in item['vendors']['polygon'].get('breaks', []):
        breaks_polygon.append({**b, 'symbol': symbol, 'date': date})

    for b in item['vendors']['iex'].get('breaks', []):
        breaks_iex.append({**b, 'symbol': symbol, 'date': date})

    for b in item['vendors']['finnhub'].get('breaks', []):
        breaks_finnhub.append({**b, 'symbol': symbol, 'date': date})

# Convertir a DataFrames
df_polygon = pd.DataFrame(breaks_polygon)
df_iex = pd.DataFrame(breaks_iex)
df_finnhub = pd.DataFrame(breaks_finnhub)

# An√°lisis
print("Breaks por vendor:")
print(f"Polygon:  {len(df_polygon)}")
print(f"IEX:      {len(df_iex)}")
print(f"Finnhub:  {len(df_finnhub)}")

# Breaks comunes (mismo timestamp)
if not df_polygon.empty and not df_iex.empty:
    common = pd.merge(df_polygon, df_iex, on=['symbol', 'date', 't_min'])
    print(f"\nBreaks comunes Polygon-IEX: {len(common)}")
```

---

## üß™ Casos de Uso Avanzados

### **Caso 1: Certificaci√≥n Pre-Hedge Fund**

Antes de presentar datos a inversores institucionales:

```bash
# Auditor√≠a completa: 50 tickers, 30 d√≠as, 3 vendors
python verify_against_references.py \
  --symbols $(cat top50_tickers.txt | tr '\n' ',') \
  --dates $(seq -s, $(date -d '30 days ago' +%Y-%m-%d) $(date +%Y-%m-%d)) \
  --vendors polygon,iex,finnhub \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --price-tol 0.001 \
  --vol-tol 0.02 \
  --out reports/institutional_audit.json

# Generar reporte formal
python make_report_md.py \
  --input reports/institutional_audit.json \
  --output reports/INSTITUTIONAL_AUDIT_REPORT.md \
  --title "Institutional Grade Audit: 50 Tickers (30 days, 3 vendors)"
```

---

### **Caso 2: Detecci√≥n de Anomal√≠as de Vendor**

Comparar m√∫ltiples vendors para identificar cu√°l tiene problemas:

```bash
# Mismo dataset, 3 vendors
python verify_against_references.py \
  --symbols AMC \
  --dates 2024-05-17 \
  --vendors polygon,iex,finnhub \
  --our-minute-root "D:/04_TRADING_SMALLCAPS/processed/minute" \
  --out reports/vendor_comparison.json

# Analizar resultados
cat reports/vendor_comparison.json | jq '.overall_match_rate'
# Output: {"polygon": 0.98, "iex": 0.85, "finnhub": 0.97}
# Conclusi√≥n: IEX tiene problemas para AMC en esa fecha
```

---

### **Caso 3: Validaci√≥n contra TAQ/SIP (Gold Standard)**

Si tienes acceso a datos institucionales:

```bash
# Comparar contra TAQ (Trades and Quotes)
python verify_against_references.py \
  --symbols WOLF,SINT \
  --dates 2025-05-13 \
  --vendors polygon,csv \
  --csv-root "D:/wrds/taq_minute" \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --price-tol 0.0005 \
  --vol-tol 0.01 \
  --out reports/audit_vs_taq.json

# Si match_rate ‚â• 99% contra TAQ ‚Üí Gold Standard Certified
```

---

## üéØ Recomendaciones de Uso

### **Auditor√≠a Diaria (Automatizada)**

```bash
#!/bin/bash
# daily_audit.sh

DATE=$(date -d "yesterday" +%Y-%m-%d)
TICKERS="WOLF,SINT,SGD,STSS,PRFX"

python verify_against_references.py \
  --symbols $TICKERS \
  --dates $DATE \
  --vendors polygon,iex \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/daily_audit_$DATE.json

python make_report_md.py \
  --input reports/daily_audit_$DATE.json \
  --output reports/daily_audit_$DATE.md \
  --title "Daily Audit $DATE"

# Send email if match_rate < 0.95
MATCH_RATE=$(cat reports/daily_audit_$DATE.json | jq '.overall_match_rate.polygon')
if (( $(echo "$MATCH_RATE < 0.95" | bc -l) )); then
  mail -s "‚ö†Ô∏è Audit Alert: Match rate $MATCH_RATE" admin@company.com < reports/daily_audit_$DATE.md
fi
```

---

### **Auditor√≠a Semanal (Profunda)**

```bash
# Cada lunes: auditar √∫ltima semana completa
WEEK_START=$(date -d "last monday -7 days" +%Y-%m-%d)
WEEK_END=$(date -d "last friday" +%Y-%m-%d)

python verify_against_references.py \
  --symbols $(cat all_active_tickers.txt | tr '\n' ',') \
  --dates $(seq -s, $WEEK_START $WEEK_END) \
  --vendors polygon,iex,finnhub \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/weekly_audit_$(date +%Y_W%V).json

# Guardar en S3/cloud para compliance
aws s3 cp reports/weekly_audit_$(date +%Y_W%V).json s3://audits/
```

---

## üìö Referencias

- [8.2_Script_Verificacion_oficial.md](8.2_Script_Verificacion_oficial.md) - Auditor√≠a single-vendor
- [8.4_propuesta_trabajo_independent_audit.md](8.4_propuesta_trabajo_independent_audit.md) - Gu√≠a de trabajo
- [Polygon.io Docs](https://polygon.io/docs) - API documentation
- [IEX Cloud Docs](https://iexcloud.io/docs) - API reference
- [Finnhub Docs](https://finnhub.io/docs/api) - API guide

---

## üöÄ Pr√≥ximos Pasos

### **1. Ejecutar Primera Auditor√≠a Multi-Vendor (HOY)**

```bash
cd D:/04_TRADING_SMALLCAPS/01_DayBook/fase_02/F_auditoria_data/independent_audit_multi/independent_audit_multi

# Test con 1 ticker, 2 vendors
python verify_against_references.py \
  --symbols WOLF \
  --dates 2025-10-21 \
  --vendors polygon,iex \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/first_multi_test.json

python make_report_md.py \
  --input reports/first_multi_test.json \
  --output reports/FIRST_MULTI_TEST.md \
  --title "First Multi-Vendor Test"
```

### **2. Auditar Muestra Representativa (ESTA SEMANA)**

```bash
# 5 tickers, 3 d√≠as, 3 vendors
python verify_against_references.py \
  --symbols WOLF,SINT,SGD,STSS,PRFX \
  --dates 2025-10-21,2025-10-22,2025-10-23 \
  --vendors polygon,iex,finnhub \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/weekly_multi_audit.json
```

### **3. Integrar con Certification Suite (PR√ìXIMO MES)**

Crear `a12_external_multi_vendor.py` que ejecute auditor√≠a multi-vendor autom√°ticamente.

---

**√öltima actualizaci√≥n:** 2025-10-22
**Autor:** Multi-vendor audit system
**Next steps:** Ejecutar primera auditor√≠a multi-vendor y documentar resultados
