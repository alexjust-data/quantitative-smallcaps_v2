# 8.4 Propuesta de Trabajo con Independent Audit

**Sistema:** `independent_audit/`
**Ubicaci√≥n:** `D:\04_TRADING_SMALLCAPS\01_DayBook\fase_02\F_auditoria_data\independent_audit`
**Prop√≥sito:** Auditor√≠a externa independiente que valida tus datos contra fuentes externas (Polygon.io)

---

## üéØ Propuesta de Trabajo con `independent_audit`

### **¬øQu√© puedes hacer con este sistema?**

El sistema `independent_audit` es una **auditor√≠a externa independiente** que:
- Descarga datos de referencia desde vendors externos (Polygon.io, IEX, Tiingo)
- Compara tus barras DIB (agregadas a minuto) o minute bars contra esos datos
- Calcula diferencias relativas en OHLCV
- Genera reportes de match-rate y discrepancias
- Es completamente independiente de tu certification suite interna

---

## üí° Opciones de Trabajo

### **1. Ejecutar la Auditor√≠a Ahora**

Correr verificaci√≥n contra Polygon para validar tus datos:

**Actividades:**
- Configurar API key de Polygon.io
- Seleccionar muestras de tickers/fechas para auditar
- Ejecutar verificaci√≥n y analizar resultados
- Generar reporte markdown publicable

**Tiempo estimado:** 30-45 minutos

---

### **2. Mejorar/Extender el Sistema**

Agregar funcionalidades o vendors adicionales:

**Posibles extensiones:**
- ‚úÖ Agregar m√°s vendors (IEX, Tiingo, Yahoo Finance)
- ‚úÖ Crear comparaci√≥n contra ticks (no solo minute bars)
- ‚úÖ Integrar con certification suite (auto-run en CI/CD)
- ‚úÖ Agregar visualizaciones (gr√°ficos de discrepancias)
- ‚úÖ Exportar resultados a dashboard interactivo

**Tiempo estimado:** 2-4 horas por feature

---

### **3. Crear Documentaci√≥n Adicional**

Mejorar gu√≠as de uso y casos pr√°cticos:

**Documentos a crear:**
- Tutorial paso a paso con screenshots
- FAQ de troubleshooting
- Casos de uso con ejemplos reales
- Interpretaci√≥n de resultados (¬øqu√© hacer si match_rate < 0.95?)
- Gu√≠a de integraci√≥n con CI/CD

**Tiempo estimado:** 1-2 horas

---

### **4. Integrar con Suite de Certificaci√≥n**

Conectar con los checks A01-A11 para auditor√≠a completa:

**Integraci√≥n propuesta:**
- Nuevo check A12: External Vendor Verification
- Auto-run despu√©s de checks A01-A08
- Umbral GO/NO-GO: match_rate ‚â• 0.95
- Guardar resultados en `reports/audits/a12_external_vendor.json`

**Tiempo estimado:** 2-3 horas

---

### **5. Otro Objetivo**

Define tu necesidad espec√≠fica y te ayudo a implementarla.

---

## üöÄ Recomendaci√≥n Inmediata

**Ejecutar una auditor√≠a de prueba** en 2-3 tickers para validar que todo funciona:

### **Paso 1: Setup**

```bash
cd D:/04_TRADING_SMALLCAPS/01_DayBook/fase_02/F_auditoria_data/independent_audit

# Crear entorno virtual (opcional pero recomendado)
python -m venv .venv
.venv\Scripts\activate  # Windows
# source .venv/bin/activate  # Linux/Mac
```

### **Paso 2: Instalar Dependencias**

```bash
pip install -r requirements.txt
```

**Dependencias incluidas:**
- `polars>=1.6.0` - DataFrame library
- `pyarrow` - Parquet support
- `pandas` - Data manipulation
- `requests` - API calls
- `numpy` - Numerical operations
- `python-dateutil` - Date parsing

### **Paso 3: Configurar API Key de Polygon**

```powershell
# Windows PowerShell
$env:POLYGON_API_KEY="TU_POLYGON_KEY"

# Linux/Mac Bash
export POLYGON_API_KEY="TU_POLYGON_KEY"
```

**Obtener API Key:**
1. Crea cuenta en [Polygon.io](https://polygon.io/)
2. Free tier incluye: 5 API calls/minuto, datos hasta 2 a√±os atr√°s
3. Copia tu API key desde el dashboard

### **Paso 4: Ejecutar Auditor√≠a de Prueba**

**Opci√≥n A: Verificar 3 tickers en 1 d√≠a**

```bash
python verify_against_reference.py \
  --symbols WOLF,SINT,SGD \
  --dates 2025-05-13 \
  --vendor polygon \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/test_audit_2025-05-13.json
```

**Opci√≥n B: Verificar 1 ticker en m√∫ltiples d√≠as**

```bash
python verify_against_reference.py \
  --symbols WOLF \
  --dates 2025-05-13,2025-05-14,2025-05-15 \
  --vendor polygon \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/test_audit_wolf_may.json
```

**Opci√≥n C: Verificar m√∫ltiples tickers en m√∫ltiples d√≠as**

```bash
python verify_against_reference.py \
  --symbols WOLF,SINT,SGD,STSS,PRFX \
  --dates 2025-05-13,2025-05-14 \
  --vendor polygon \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/test_audit_5tickers_2days.json
```

### **Paso 5: Generar Reporte Markdown**

```bash
python make_report_md.py \
  --input reports/test_audit_2025-05-13.json \
  --output reports/TEST_AUDIT_REPORT.md \
  --title "Test Audit - 3 Tickers vs Polygon"
```

**Output esperado:**

```
Wrote reports/TEST_AUDIT_REPORT.md
```

### **Paso 6: Analizar Resultados**

Abre `reports/TEST_AUDIT_REPORT.md` y revisa:

**M√©tricas clave:**
- **Overall match rate:** % de barras que coinciden dentro de tolerancias
- **Per-ticker match rate:** Desglose por s√≠mbolo
- **Stats:** Media y percentil 95 de diferencias

**Interpretaci√≥n:**

| Match Rate | Interpretaci√≥n | Acci√≥n |
|-----------|----------------|--------|
| **‚â• 0.95** | ‚úÖ Datos validados | Pipeline certificado |
| **0.90 - 0.95** | ‚ö†Ô∏è Revisar breaks | Investigar discrepancias espec√≠ficas |
| **< 0.90** | ‚ùå Problemas severos | Auditar pipeline completo |

---

## üìä Qu√© Verifica el Sistema

### **1. Alineaci√≥n Temporal**

Alinea ambos datasets por **minuto (UTC)**:
- Tu dataset: Agrega barras DIB a minutos completos
- Polygon: Barras de 1 minuto desde API

### **2. Diferencias Relativas**

Calcula diferencias relativas para cada barra:

**Precio:**
```
d_price_max = max(|Œîopen|, |Œîhigh|, |Œîlow|, |Œîclose|)
donde Œî = (ours - ref) / ref
```

**Volumen:**
```
d_vol = |volume_ours - volume_ref| / volume_ref
```

### **3. Criterios de Validaci√≥n**

Eval√∫a si cada barra pasa el test:
- **Precio:** `d_price_max ‚â§ 0.2%` (default)
- **Volumen:** `d_vol ‚â§ 5%` (default)

Puedes ajustar tolerancias con flags:
```bash
--price-tol 0.001  # 0.1% m√°s estricto
--vol-tol 0.10     # 10% m√°s permisivo
```

### **4. Outputs Generados**

**JSON Report (`reports/*.json`):**
```json
{
  "vendor": "polygon",
  "symbols": ["WOLF", "SINT", "SGD"],
  "dates": ["2025-05-13"],
  "price_tol": 0.002,
  "vol_tol": 0.05,
  "overall_match_rate": 0.9856,
  "items": [
    {
      "symbol": "WOLF",
      "date": "2025-05-13",
      "rows_compared": 390,
      "match_rate": 0.9872,
      "stats": {
        "mean_d_price": 0.0008,
        "mean_d_vol": 0.0234,
        "p95_d_price": 0.0015,
        "p95_d_vol": 0.0456
      },
      "breaks": [
        {
          "t_min": "2025-05-13T13:45:00Z",
          "open_ref": 12.45,
          "open_ours": 12.48,
          "d_price_max": 0.0241,
          "d_vol": 0.0823
        }
      ]
    }
  ]
}
```

**Markdown Report (`reports/*.md`):**
```markdown
# Test Audit - 3 Tickers vs Polygon

Date: 2025-10-22
Vendor: polygon
Symbols: WOLF, SINT, SGD
Dates: 2025-05-13

## Summary
Overall match rate: 98.56%
Price tolerance: 0.20% | Volume tolerance: 5.00%

## Details by symbol/date
- WOLF 2025-05-13 -> rows=390, match_rate=98.72%
- SINT 2025-05-13 -> rows=385, match_rate=97.92%
- SGD 2025-05-13 -> rows=378, match_rate=99.21%

## Notes
- Times aligned at minute granularity in UTC.
- Differences may arise from vendor-specific filtering (odd lots, late corrections) and rounding.
- This audit is independent from the production pipeline and can be reproduced with the provided JSON and scripts.
```

---

## üß† Casos de Uso Comunes

### **Caso 1: Smoke Test Post-Pipeline**

Despu√©s de ejecutar pipeline DIB, validar muestra aleatoria:

```bash
# Seleccionar 10 tickers aleatorios del √∫ltimo d√≠a procesado
python verify_against_reference.py \
  --symbols $(ls processed/bars/ | shuf -n 10 | tr '\n' ',') \
  --dates 2025-10-21 \
  --vendor polygon \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/smoke_test_$(date +%Y%m%d).json
```

### **Caso 2: Auditor√≠a Profunda de Ticker Sospechoso**

Si un ticker falla certification checks, auditar contra vendor externo:

```bash
# WOLF fall√≥ check A03 (conservaci√≥n)
python verify_against_reference.py \
  --symbols WOLF \
  --dates 2025-05-13,2025-05-14,2025-05-15,2025-05-16,2025-05-17 \
  --vendor polygon \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/deep_audit_WOLF.json

python make_report_md.py \
  --input reports/deep_audit_WOLF.json \
  --output reports/WOLF_DEEP_AUDIT.md \
  --title "Deep Audit: WOLF (5 days vs Polygon)"
```

### **Caso 3: Validaci√≥n Pre-Producci√≥n**

Antes de usar datos en trading real, certificar muestra representativa:

```bash
# Top 20 tickers por volumen, √∫ltimos 5 d√≠as
python verify_against_reference.py \
  --symbols WOLF,SINT,SGD,STSS,PRFX,TDOC,SI,WOLF,MAXN,LIMN,KSS,LOBO,MB,MBRX,LMFA,LRHC,KIDZ,KTTA,KBSX,LB \
  --dates 2025-10-17,2025-10-18,2025-10-21,2025-10-22,2025-10-23 \
  --vendor polygon \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/pre_production_audit.json \
  --price-tol 0.001 \
  --vol-tol 0.03

python make_report_md.py \
  --input reports/pre_production_audit.json \
  --output reports/PRE_PRODUCTION_AUDIT.md \
  --title "Pre-Production Audit: 20 Tickers (5 days)"
```

---

## üîß Troubleshooting

### **Error: "POLYGON_API_KEY not set"**

**Causa:** Variable de entorno no configurada

**Soluci√≥n:**
```powershell
# PowerShell - verificar
echo $env:POLYGON_API_KEY

# Si est√° vac√≠o, configurar
$env:POLYGON_API_KEY="tu_key_aqui"
```

---

### **Error: "HTTPError: 403 Forbidden"**

**Causa:** API key inv√°lida o l√≠mite de rate excedido

**Soluci√≥n:**
1. Verifica que tu API key sea correcta en Polygon.io dashboard
2. Free tier: m√°ximo 5 calls/minuto
3. Agrega delay entre requests si auditas muchos tickers:

```bash
# Procesar en lotes
python verify_against_reference.py --symbols WOLF,SINT \
  && sleep 15 \
  && python verify_against_reference.py --symbols SGD,STSS
```

---

### **Error: "no data" en resultados**

**Causa:** Ticker/fecha no disponible en Polygon o en tu dataset

**Soluci√≥n:**
1. Verifica que el ticker exista en ambos datasets
2. Polygon free tier: solo √∫ltimos 2 a√±os
3. Revisa que la fecha sea d√≠a de mercado (no weekend/holiday)

---

### **Match rate bajo (<0.90) pero datos correctos**

**Causas posibles:**

| Causa | Explicaci√≥n | Soluci√≥n |
|-------|-------------|----------|
| **Odd-lots filtering** | Polygon puede filtrar trades < 100 shares | Normal, revisar breaks espec√≠ficos |
| **Late corrections** | Correcciones post-trade en feeds | Aceptable si < 5% de barras |
| **DIB agregaci√≥n** | Barras DIB no alinean perfectamente con minutos | Esperable, focus en p95 no mean |
| **Timezone issues** | Timestamps mal convertidos | Verificar que ambos est√©n en UTC |

**Acci√≥n:**
```bash
# Revisar breaks espec√≠ficos en JSON
cat reports/audit.json | jq '.items[].breaks | .[]'

# Si breaks son en horarios espec√≠ficos (open/close), puede ser normal
# Si breaks son aleatorios, investigar pipeline
```

---

## üìà Extensiones Futuras

### **1. Agregar Vendor IEX Cloud**

Crear `vendors/iex_client.py`:

```python
import os, requests, pandas as pd

BASE = "https://cloud.iexapis.com/stable"

def fetch_iex_1min(symbol: str, date: str, api_key: str=None):
    if api_key is None:
        api_key = os.getenv("IEX_API_KEY")
    if not api_key:
        raise RuntimeError("IEX_API_KEY not set")

    url = f"{BASE}/stock/{symbol}/chart/date/{date.replace('-', '')}"
    params = {"token": api_key, "chartByDay": "true"}

    r = requests.get(url, params=params, timeout=60)
    r.raise_for_status()
    js = r.json()

    if not js:
        return pd.DataFrame(columns=["t","open","high","low","close","volume"])

    df = pd.DataFrame(js)
    df["t"] = pd.to_datetime(df["date"] + " " + df["minute"], utc=True)
    df = df[["t","open","high","low","close","volume"]].sort_values("t")
    return df
```

Luego modificar `verify_against_reference.py` para soportar `--vendor iex`.

---

### **2. Integrar con Certification Suite**

Crear nuevo check `a12_external_vendor.py`:

```python
import subprocess, json, pathlib
from _utils import fail_or_pass

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--root", required=True)
    ap.add_argument("--out", required=True)
    ap.add_argument("--sample-tickers", default="WOLF,SINT,SGD")
    ap.add_argument("--sample-date", default="2025-10-21")
    args = ap.parse_args()

    # Run independent audit
    audit_out = "/tmp/a12_audit.json"
    cmd = f"""
    python independent_audit/verify_against_reference.py \
      --symbols {args.sample_tickers} \
      --dates {args.sample_date} \
      --vendor polygon \
      --our-dib-root {args.root}/processed/bars \
      --out {audit_out}
    """

    result = subprocess.run(cmd, shell=True, capture_output=True)

    # Load results
    with open(audit_out) as f:
        data = json.load(f)

    match_rate = data.get("overall_match_rate", 0.0)
    ok = match_rate >= 0.95

    fail_or_pass(args.out, {
        "match_rate": match_rate,
        "vendor": data.get("vendor"),
        "symbols_checked": data.get("symbols"),
        "dates_checked": data.get("dates")
    }, ok)

if __name__ == "__main__":
    main()
```

Agregar a `run_all_checks.py` como √∫ltimo check.

---

### **3. Dashboard Interactivo**

Crear `visualize_audit.py` con Plotly:

```python
import json, plotly.graph_objects as go
from plotly.subplots import make_subplots

def visualize_audit(json_path):
    with open(json_path) as f:
        data = json.load(f)

    # Crear subplots
    fig = make_subplots(
        rows=2, cols=2,
        subplot_titles=("Match Rate by Symbol", "Price Deviation",
                       "Volume Deviation", "Breaks Timeline")
    )

    # Plot 1: Match rate por s√≠mbolo
    symbols = [item['symbol'] for item in data['items']]
    match_rates = [item['match_rate'] for item in data['items']]

    fig.add_trace(
        go.Bar(x=symbols, y=match_rates, name="Match Rate"),
        row=1, col=1
    )

    # Plot 2: Distribuci√≥n de price deviation
    # ... [c√≥digo adicional]

    fig.write_html("reports/audit_dashboard.html")
    print("Dashboard: reports/audit_dashboard.html")
```

---

## ‚öñÔ∏è Interpretaci√≥n de Resultados

### **Match Rate ‚â• 0.95 (GO)**

‚úÖ **Significado:**
- 95%+ de las barras coinciden dentro de tolerancias
- Diferencias menores atribuibles a filtros de vendor o redondeo
- Pipeline validado contra fuente externa

‚úÖ **Acci√≥n:**
- Pipeline certificado para producci√≥n
- Documentar resultados en reporte
- Incluir en compliance/audit trail

---

### **0.90 ‚â§ Match Rate < 0.95 (WARNING)**

‚ö†Ô∏è **Significado:**
- 90-95% de barras coinciden
- Algunas discrepancias sistem√°ticas
- Requiere investigaci√≥n pero no cr√≠tico

‚ö†Ô∏è **Acci√≥n:**
1. Revisar `breaks` en JSON para identificar patrones
2. Verificar si breaks son en horarios espec√≠ficos (open/close)
3. Comparar con otro vendor (IEX, Tiingo) para triangular
4. Ajustar tolerancias si discrepancias son menores

---

### **Match Rate < 0.90 (NO-GO)**

‚ùå **Significado:**
- M√°s del 10% de barras tienen discrepancias significativas
- Posible problema en pipeline o feed
- No usar en producci√≥n hasta resolver

‚ùå **Acci√≥n:**
1. **Auditar pipeline completo:**
   - Verificar timestamp conversion (ns ‚Üí Œºs)
   - Revisar agregaci√≥n DIB ‚Üí minute
   - Validar que no hay data corruption

2. **Comparar contra m√∫ltiples vendors:**
   - Polygon vs IEX vs Tiingo
   - Si todos fallan, problema en tu pipeline
   - Si solo uno falla, problema del vendor

3. **Revisar breaks detalladamente:**
```bash
cat reports/audit.json | jq '.items[].breaks | .[] | select(.d_price_max > 0.05)'
```

4. **Re-ejecutar certification suite (A01-A08)**

---

## üéØ Pr√≥ximos Pasos Recomendados

### **Paso 1: Ejecutar Auditor√≠a de Prueba (HOY)**

```bash
cd D:/04_TRADING_SMALLCAPS/01_DayBook/fase_02/F_auditoria_data/independent_audit
python verify_against_reference.py --symbols WOLF --dates 2025-10-21 --vendor polygon --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" --out reports/test.json
python make_report_md.py --input reports/test.json --output reports/TEST.md --title "First Test"
```

### **Paso 2: Auditar Muestra Representativa (ESTA SEMANA)**

```bash
# 10 tickers aleatorios, √∫ltimos 3 d√≠as
python verify_against_reference.py \
  --symbols WOLF,SINT,SGD,STSS,PRFX,TDOC,SI,MAXN,LIMN,KSS \
  --dates 2025-10-21,2025-10-22,2025-10-23 \
  --vendor polygon \
  --our-dib-root "D:/04_TRADING_SMALLCAPS/processed/bars" \
  --out reports/weekly_audit_w43.json
```

### **Paso 3: Integrar con CI/CD (PR√ìXIMO MES)**

Agregar a workflow de GitHub Actions o script post-pipeline:
- Auto-run despu√©s de certification checks
- Generar reporte autom√°tico
- Enviar notificaci√≥n si match_rate < 0.95

---

## üìö Referencias

- [8.2_Script_Verificacion_oficial.md](8.2_Script_Verificacion_oficial.md) - Instrucciones detalladas de uso
- [independent_audit/README.md](independent_audit/README.md) - Documentaci√≥n t√©cnica del sistema
- [Polygon.io Docs](https://polygon.io/docs) - API reference
- [7.5_data_summary.md](../E_data_analisys/7.5_data_summary.md) - Certification suite interna

---

**√öltima actualizaci√≥n:** 2025-10-22
**Autor:** Independent audit tools
**Next steps:** Ejecutar primera auditor√≠a de prueba y documentar resultados
