# 8.3 Estructura del Notebook de Auditor√≠a TradingView

**Notebook:** `verify_tradingview_interactive.ipynb`
**Ubicaci√≥n:** `scripts/fase_E_DataAnalysis/`
**Prop√≥sito:** Verificaci√≥n visual interactiva de barras DIB contra TradingView con an√°lisis profundo

---

## üìì Estructura Propuesta para el Jupyter Notebook

### **Nombre sugerido:** `verify_tradingview_interactive.ipynb`

---

## üóÇÔ∏è Estructura de Celdas

### **SECCI√ìN 1: Setup y Configuraci√≥n**

#### **Cell 1: Imports y Setup**
- Imports necesarios (polars, pytz, datetime, subprocess, IPython.display)
- Configurar rutas del proyecto
- Funci√≥n para cargar datos

#### **Cell 2: Funci√≥n para Generar URL de TradingView**
- Genera URL espec√≠fica con ticker, fecha, timeframe
- Embedible en iframe para mostrar gr√°fico

#### **Cell 3: Wrapper del Script CLI**
- Funci√≥n Python que llama al script verify_bar_tradingview.py
- Captura y formatea output

---

### **SECCI√ìN 2: Verificaci√≥n Visual Interactiva**

#### **Cell 4: Selector Interactivo (Widgets)**
- Widgets para elegir: ticker, fecha, bar_index
- Bot√≥n "Verificar"

#### **Cell 5: Mostrar Datos de la Barra + TradingView Side-by-Side**
```
[Panel Izquierdo]              [Panel Derecho]
- Datos de la barra            - TradingView embed
- OHLC, volumen, timestamps    - Gr√°fico en tiempo real
- Label info                   - Timeframe correcto
```

#### **Cell 6: Comparaci√≥n Manual con Checklist**
- Tabla interactiva con checkboxes
- ‚úì OHLC coincide
- ‚úì Volumen coincide
- ‚úì Timestamps correctos
- ‚úì Label validada

---

### **SECCI√ìN 3: An√°lisis de D√≠a Completo**

#### **Cell 7: Estad√≠sticas del D√≠a**
- Llamar script con --all-stats
- Visualizar distribuci√≥n de imbalances
- Histograma de rangos

#### **Cell 8: Timeline Visual del D√≠a**
- Gr√°fico de todas las barras DIB del d√≠a
- Color-coded por imbalance
- Hover para ver detalles

#### **Cell 9: Mapa de Calor de Labels**
- Heatmap WIN/LOSS/TIMEOUT por hora del d√≠a
- Identificar patrones temporales

---

### **SECCI√ìN 4: An√°lisis Multi-D√≠a**

#### **Cell 10: Comparaci√≥n Multi-Ticker**
- Tabla comparativa de varios tickers en la misma fecha
- M√©tricas: # barras, imbalance avg, match rate

#### **Cell 11: Serie Temporal**
- Evoluci√≥n de m√©tricas a trav√©s de varios d√≠as
- Detectar degradaci√≥n de calidad de datos

---

### **SECCI√ìN 5: Auditor√≠a Automatizada**

#### **Cell 12: Batch Verification**
- Loop para verificar m√∫ltiples eventos
- Progress bar
- Guardar resultados en DataFrame

#### **Cell 13: Reporte de Auditor√≠a**
- Generar reporte markdown autom√°tico
- Lista de discrepancias encontradas
- Guardar en `reports/audit_YYYY-MM-DD.md`

---

## üñºÔ∏è Opciones para Mostrar TradingView en el Notebook

Hay **3 opciones** para integrar TradingView:

---

### **Opci√≥n 1: TradingView Widget (Widget Oficial Embebido)**

Usa el widget oficial embebido:

```python
from IPython.display import IFrame, HTML

def show_tradingview_chart(ticker, date):
    """Muestra gr√°fico de TradingView embebido"""
    # Convertir fecha a timestamp
    import datetime
    dt = datetime.datetime.strptime(date, '%Y-%m-%d')
    timestamp = int(dt.timestamp())

    # Widget HTML de TradingView
    html = f"""
    <div class="tradingview-widget-container">
      <div id="tradingview_chart"></div>
      <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
      <script type="text/javascript">
        new TradingView.widget({{
          "width": 980,
          "height": 610,
          "symbol": "{ticker}",
          "interval": "1",
          "timezone": "America/New_York",
          "theme": "light",
          "style": "1",
          "locale": "en",
          "toolbar_bg": "#f1f3f6",
          "enable_publishing": false,
          "hide_side_toolbar": false,
          "allow_symbol_change": false,
          "save_image": false,
          "container_id": "tradingview_chart",
          "time_frames": [
            {{ "text": "1d", "resolution": "1", "description": "1 Day" }}
          ]
        }});
      </script>
    </div>
    """
    return HTML(html)

# Uso
show_tradingview_chart("WOLF", "2025-05-13")
```

**Ventajas:**
- Widget oficial de TradingView
- Gr√°fico interactivo en el notebook
- Actualizaci√≥n en tiempo real

**Desventajas:**
- Requiere conexi√≥n a internet
- No puedes controlar la ventana temporal espec√≠fica program√°ticamente
- El usuario debe navegar manualmente a la fecha/hora correcta

---

### **Opci√≥n 2: Screenshot Autom√°tico (M√°s Confiable)**

Usar Selenium para capturar screenshot de TradingView:

```python
from selenium import webdriver
from PIL import Image
from IPython.display import display
import time

def capture_tradingview_screenshot(ticker, date, t_open, t_close):
    """Captura screenshot de TradingView para la ventana espec√≠fica"""

    # URL de TradingView con par√°metros
    url = f"https://www.tradingview.com/chart/?symbol={ticker}&interval=1"

    # Setup Selenium
    options = webdriver.ChromeOptions()
    options.add_argument('--headless')
    driver = webdriver.Chrome(options=options)

    driver.get(url)
    time.sleep(5)  # Wait for chart load

    # TODO: Navigate to specific time window (requires interaction)
    # Esto requiere automatizar clicks en TradingView UI

    # Capture screenshot
    screenshot_path = f"temp/{ticker}_{date}.png"
    driver.save_screenshot(screenshot_path)
    driver.quit()

    # Display in notebook
    img = Image.open(screenshot_path)
    display(img)

    return screenshot_path
```

**Ventajas:**
- Captura exacta de lo que ver√≠as en TradingView
- Guardable para auditor√≠as posteriores
- Control program√°tico total

**Desventajas:**
- Requiere Selenium + ChromeDriver instalado
- M√°s complejo de configurar
- Navegaci√≥n a ventana temporal espec√≠fica requiere automatizar UI
- M√°s lento (5-10 segundos por captura)

**Instalaci√≥n requerida:**
```bash
pip install selenium pillow
# Descargar ChromeDriver: https://chromedriver.chromium.org/
```

---

### **Opci√≥n 3: Panel Side-by-Side (Manual + Auto) - RECOMENDADO**

Mostrar instrucciones + URL clicable:

```python
from IPython.display import display, Markdown, HTML

def show_verification_panel(ticker, date, bar_data):
    """Panel de verificaci√≥n con datos + link a TradingView"""

    t_open = bar_data['t_open_et']  # Ya convertido a ET
    t_close = bar_data['t_close_et']

    # Panel HTML
    html = f"""
    <div style="display: flex; gap: 20px;">
        <!-- Panel Izquierdo: Datos -->
        <div style="flex: 1; background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <h3>üìä Datos de tu Pipeline</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="border-bottom: 1px solid #ddd;">
                    <th style="text-align: left; padding: 8px;">M√©trica</th>
                    <th style="text-align: right; padding: 8px;">Valor</th>
                </tr>
                <tr><td style="padding: 8px;">Open</td><td style="text-align: right; padding: 8px;">${bar_data['open']:.2f}</td></tr>
                <tr><td style="padding: 8px;">High</td><td style="text-align: right; padding: 8px;">${bar_data['high']:.2f}</td></tr>
                <tr><td style="padding: 8px;">Low</td><td style="text-align: right; padding: 8px;">${bar_data['low']:.2f}</td></tr>
                <tr><td style="padding: 8px;">Close</td><td style="text-align: right; padding: 8px;">${bar_data['close']:.2f}</td></tr>
                <tr><td style="padding: 8px;">Volume</td><td style="text-align: right; padding: 8px;">{bar_data['volume']:,}</td></tr>
                <tr><td style="padding: 8px;">Time Window</td><td style="text-align: right; padding: 8px;">{t_open} - {t_close} ET</td></tr>
            </table>
        </div>

        <!-- Panel Derecho: TradingView -->
        <div style="flex: 1; background: #fff3cd; padding: 20px; border-radius: 8px;">
            <h3>üìà Verificar en TradingView</h3>
            <a href="https://www.tradingview.com/chart/?symbol={ticker}&interval=1"
               target="_blank"
               style="display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin-top: 10px;">
               üîó Abrir {ticker} en TradingView
            </a>
            <p style="margin-top: 15px; line-height: 1.6;">
                <strong>Instrucciones:</strong><br>
                1. Click en el link arriba<br>
                2. Navega a <strong>{date}</strong><br>
                3. Zoom a ventana <strong>{t_open} - {t_close}</strong><br>
                4. Verifica OHLC y volumen
            </p>
            <hr style="margin: 15px 0;">
            <p style="font-size: 0.9em; color: #666;">
                <strong>Criterios de validaci√≥n:</strong><br>
                ‚úì OHLC dentro de ¬±2%<br>
                ‚úì Volumen dentro de ¬±5%<br>
                ‚úì Timestamps ¬±100ms
            </p>
        </div>
    </div>
    """

    display(HTML(html))

# Ejemplo de uso
bar_data = {
    'open': 12.45,
    'high': 12.67,
    'low': 12.42,
    'close': 12.65,
    'volume': 16125,
    't_open_et': '09:30:00',
    't_close_et': '09:31:23'
}

show_verification_panel("WOLF", "2025-05-13", bar_data)
```

**Ventajas:**
- ‚úÖ No requiere API keys de TradingView
- ‚úÖ No requiere Selenium (m√°s simple)
- ‚úÖ El usuario tiene control total en TradingView
- ‚úÖ Instrucciones claras paso a paso
- ‚úÖ Link directo clicable
- ‚úÖ Funciona inmediatamente sin configuraci√≥n

**Desventajas:**
- Requiere intervenci√≥n manual del usuario
- No hay captura autom√°tica de screenshot

---

## üöÄ Recomendaci√≥n Final

**Opci√≥n 3 (Panel Side-by-Side)** porque:
- ‚úÖ No requiere API keys de TradingView
- ‚úÖ No requiere Selenium (m√°s simple)
- ‚úÖ El usuario tiene control total en TradingView
- ‚úÖ Instrucciones claras paso a paso
- ‚úÖ Link directo clicable
- ‚úÖ M√°s r√°pido de implementar
- ‚úÖ Sin dependencias adicionales

**Opcional:** Si quieres capturas autom√°ticas m√°s adelante, puedes agregar Opci√≥n 2 como feature avanzado.

---

## üìù Ejemplo de Celda Completa (Cell 5)

```python
# Cell 5: Mostrar Datos de la Barra + TradingView Side-by-Side

import polars as pl
from datetime import datetime
import pytz
from IPython.display import display, HTML
from pathlib import Path

PROJECT_ROOT = Path("D:/04_TRADING_SMALLCAPS")

def utc_to_et(utc_timestamp_us):
    """Convierte timestamp UTC (Œºs) a ET"""
    dt = datetime.fromtimestamp(utc_timestamp_us / 1_000_000, tz=pytz.UTC)
    et = dt.astimezone(pytz.timezone('US/Eastern'))
    return et

def load_bar_data(ticker, date, bar_index=0):
    """Carga datos de una barra espec√≠fica"""
    bars_path = PROJECT_ROOT / f"processed/bars/{ticker}/date={date}/dollar_imbalance.parquet"

    if not bars_path.exists():
        print(f"‚ùå No se encontr√≥: {bars_path}")
        return None

    bars = pl.read_parquet(bars_path)

    if len(bars) <= bar_index:
        print(f"‚ùå Solo hay {len(bars)} barras ese d√≠a")
        return None

    bar = bars[bar_index]

    # Convertir timestamps
    t_open = utc_to_et(bar['t_open'][0])
    t_close = utc_to_et(bar['t_close'][0])

    return {
        'open': bar['open'][0],
        'high': bar['high'][0],
        'low': bar['low'][0],
        'close': bar['close'][0],
        'volume': int(bar['cum_volume_buy'][0] + bar['cum_volume_sell'][0]),
        't_open_et': t_open.strftime('%H:%M:%S'),
        't_close_et': t_close.strftime('%H:%M:%S'),
        'date': date,
        'ticker': ticker
    }

def show_verification_panel(ticker, date, bar_data):
    """Panel de verificaci√≥n con datos + link a TradingView"""

    if bar_data is None:
        return

    t_open = bar_data['t_open_et']
    t_close = bar_data['t_close_et']

    html = f"""
    <div style="display: flex; gap: 20px; margin: 20px 0;">
        <!-- Panel Izquierdo: Datos -->
        <div style="flex: 1; background: #f8f9fa; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0;">üìä Datos de tu Pipeline</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="border-bottom: 2px solid #ddd;">
                    <th style="text-align: left; padding: 8px;">M√©trica</th>
                    <th style="text-align: right; padding: 8px;">Valor</th>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px; font-weight: 500;">Open</td>
                    <td style="text-align: right; padding: 8px; font-family: monospace;">${bar_data['open']:.2f}</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px; font-weight: 500;">High</td>
                    <td style="text-align: right; padding: 8px; font-family: monospace; color: #28a745;">${bar_data['high']:.2f}</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px; font-weight: 500;">Low</td>
                    <td style="text-align: right; padding: 8px; font-family: monospace; color: #dc3545;">${bar_data['low']:.2f}</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px; font-weight: 500;">Close</td>
                    <td style="text-align: right; padding: 8px; font-family: monospace;">${bar_data['close']:.2f}</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px; font-weight: 500;">Volume</td>
                    <td style="text-align: right; padding: 8px; font-family: monospace;">{bar_data['volume']:,}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; font-weight: 500;">Time Window</td>
                    <td style="text-align: right; padding: 8px; font-family: monospace; font-size: 0.9em;">{t_open}<br>‚Üí {t_close} ET</td>
                </tr>
            </table>
        </div>

        <!-- Panel Derecho: TradingView -->
        <div style="flex: 1; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0;">üìà Verificar en TradingView</h3>
            <a href="https://www.tradingview.com/chart/?symbol={ticker}&interval=1"
               target="_blank"
               style="display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin-top: 10px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,123,255,0.3);">
               üîó Abrir {ticker} en TradingView
            </a>
            <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 5px;">
                <p style="margin: 0 0 10px 0; font-weight: 600;">Instrucciones:</p>
                <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                    <li>Click en el link arriba</li>
                    <li>Navega a <strong>{date}</strong></li>
                    <li>Zoom a ventana <strong>{t_open} - {t_close}</strong></li>
                    <li>Verifica OHLC y volumen</li>
                </ol>
            </div>
            <hr style="margin: 15px 0; border: none; border-top: 1px solid rgba(0,0,0,0.1);">
            <div style="font-size: 0.9em; color: #666;">
                <p style="margin: 0 0 8px 0; font-weight: 600;">Criterios de validaci√≥n:</p>
                <div style="line-height: 1.6;">
                    ‚úì OHLC dentro de ¬±2%<br>
                    ‚úì Volumen dentro de ¬±5%<br>
                    ‚úì Timestamps ¬±100ms
                </div>
            </div>
        </div>
    </div>
    """

    display(HTML(html))

# Uso
ticker = "WOLF"
date = "2025-05-13"
bar_index = 0

bar_data = load_bar_data(ticker, date, bar_index)
show_verification_panel(ticker, date, bar_data)
```

---

## üéØ Pr√≥ximos Pasos

### ¬øQu√© prefieres?

1. **Crear el notebook completo** con esta estructura (13 celdas listas para usar)
2. **Te vaya dando c√≥digo celda por celda** para que lo vayas armando t√∫
3. **Modificar la estructura** antes de empezar

---

## üìö Referencias

- [8.1_Script_Verificacion_TradingView.md](8.1_Script_Verificacion_TradingView.md) - Documentaci√≥n del script CLI
- [verify_bar_tradingview.py](../../scripts/fase_E_DataAnalysis/verify_bar_tradingview.py) - Script source
- [TradingView Widgets](https://www.tradingview.com/widget/) - Documentaci√≥n oficial de widgets

---

**√öltima actualizaci√≥n:** 2025-10-22
**Autor:** Interactive audit tools
**Next steps:** Crear notebook completo con todas las celdas implementadas
