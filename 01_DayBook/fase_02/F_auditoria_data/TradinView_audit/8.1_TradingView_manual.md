# 8.1 Script de Verificaci√≥n Manual en TradingView

**Script:** `verify_bar_tradingview.py`
**Ubicaci√≥n:** `scripts/fase_E_DataAnalysis/verify_bar_tradingview.py`
**Prop√≥sito:** Auditar manualmente barras DIB, labels y pesos contra TradingView para validar la integridad del pipeline

---

## üéØ Funcionalidades del Script CLI

El script proporciona 5 modos de operaci√≥n para auditar diferentes aspectos de tus datos:

### 1. **Verificar Barra Espec√≠fica**

Audita una barra individual por su √≠ndice (0 = primera del d√≠a):

```bash
python verify_bar_tradingview.py WOLF 2025-05-13 0
python verify_bar_tradingview.py WOLF 2025-05-13 10
python verify_bar_tradingview.py SINT 2024-04-17 5
```

**Output:**
- ‚è∞ Ventana temporal (ET) con open/close timestamps
- üí∞ OHLC completo con rango y porcentaje
- üìà Volumen buy/sell/total con d√≥lares
- üéØ Dollar imbalance y theta acumulado
- üè∑Ô∏è Label asociada (si existe) con PT/SL/T1
- ‚úÖ Checklist paso a paso para verificar en TradingView

---

### 2. **Barra con Mayor Imbalance**

Encuentra y muestra la barra con el mayor dollar imbalance del d√≠a:

```bash
python verify_bar_tradingview.py WOLF 2025-05-13 --largest-imbalance
```

**Uso:**
- Verificar que las barras DIB se formaron en momentos de m√°ximo flujo de capital
- Auditar que el threshold de $300k se respeta
- Validar sign detection (tick rule) en eventos extremos

---

### 3. **Label con Mayor Retorno**

Encuentra la label con mayor retorno absoluto y muestra la barra que la gener√≥:

```bash
python verify_bar_tradingview.py WOLF 2025-05-13 --top-label
```

**Uso:**
- Verificar que labels WIN/LOSS coinciden con movimientos reales en TradingView
- Auditar que PT/SL se alcanzaron en el tiempo especificado (T1)
- Validar que retornos extremos no son errores de datos

---

### 4. **Encontrar Anomal√≠as (Rango > 5%)**

Detecta barras con rango de precio > 5% que pueden indicar:
- Gaps bruscos
- Halts/resumptions
- Errores de datos
- Eventos noticiosos

```bash
python verify_bar_tradingview.py WOLF 2025-05-13 --anomaly
```

**Output:**
- Lista de todas las barras con rango > 5%
- Detalles completos de cada anomal√≠a para verificaci√≥n manual
- √ötil para detectar corrupciones de datos o eventos especiales

---

### 5. **Estad√≠sticas Completas del D√≠a**

Muestra un resumen ejecutivo del d√≠a completo:

```bash
python verify_bar_tradingview.py WOLF 2025-05-13 --all-stats
```

**Output incluye:**

üìà **Resumen de Barras:**
- Total de barras DIB generadas
- Imbalance promedio y m√°ximo
- Rango promedio y m√°ximo
- Volumen total del d√≠a

üéØ **Top 5 Barras por Imbalance:**
- √çndice, timestamp, imbalance, rango

üìè **Top 5 Barras por Rango (volatilidad):**
- √çndice, timestamp, OHLC, rango %

üè∑Ô∏è **Resumen de Labels:**
- Total labels
- Distribuci√≥n WIN/LOSS/TIMEOUT con porcentajes
- Return promedio/m√°ximo/m√≠nimo
- Top 5 labels por retorno absoluto

---

## üìã Casos de Uso Comunes

### **Caso 1: Smoke Test R√°pido**

Verificar que el pipeline funciona correctamente en un d√≠a aleatorio:

```bash
# Verificar primera barra (apertura)
python verify_bar_tradingview.py WOLF 2025-05-13 0

# Ver estad√≠sticas generales
python verify_bar_tradingview.py WOLF 2025-05-13 --all-stats
```

---

### **Caso 2: Auditor√≠a Post-Pipeline**

Despu√©s de ejecutar el pipeline completo, auditar muestras aleatorias:

```bash
# Auditar 5 tickers aleatorios
python verify_bar_tradingview.py WOLF 2025-05-13 --top-label
python verify_bar_tradingview.py SINT 2024-04-17 --largest-imbalance
python verify_bar_tradingview.py SGD 2024-10-15 --anomaly
python verify_bar_tradingview.py STSS 2025-04-01 0
python verify_bar_tradingview.py PRFX 2024-08-20 --all-stats
```

---

### **Caso 3: Investigar Fallos de Certificaci√≥n**

Si alg√∫n check de certificaci√≥n falla (A03, A04, etc.), investigar:

```bash
# Si A03 (conservaci√≥n) falla
python verify_bar_tradingview.py <TICKER> <DATE> --all-stats

# Ver barras espec√≠ficas con problemas
python verify_bar_tradingview.py <TICKER> <DATE> 0
python verify_bar_tradingview.py <TICKER> <DATE> 10
python verify_bar_tradingview.py <TICKER> <DATE> 20
```

---

### **Caso 4: Validar Eventos Extremos**

Cuando encuentras retornos muy altos o imbalances sospechosos:

```bash
# Ver el evento extremo
python verify_bar_tradingview.py WOLF 2025-05-13 --top-label

# Buscar anomal√≠as de precio
python verify_bar_tradingview.py WOLF 2025-05-13 --anomaly

# Contexto completo del d√≠a
python verify_bar_tradingview.py WOLF 2025-05-13 --all-stats
```

---

## üîß Ejemplos de Output

### **Ejemplo 1: Verificar Barra Espec√≠fica**

```bash
$ python verify_bar_tradingview.py WOLF 2025-05-13 0
```

**Output:**
```
======================================================================
üìä VERIFICACI√ìN TRADINGVIEW: WOLF - Barra #0
======================================================================

üìÖ Fecha: 2025-05-13
‚è∞ Ventana temporal (ET):
   Open:  09:30:00.041 ET
   Close: 09:31:23.167 ET
   Duraci√≥n: 83.1 segundos

üí∞ OHLC:
   Open:  $12.45
   High:  $12.67
   Low:   $12.42
   Close: $12.65
   Range: $0.25 (2.01%)

üìà Volumen:
   Buy:   8,234 shares ($103,456.78)
   Sell:  7,891 shares ($98,912.34)
   Total: 16,125 shares

üéØ Dollar Imbalance:
   Theta (Œ£ sign): 343
   Target: $300,000
   Actual: $304,544.44
   Buy/Sell ratio: 1.05

======================================================================
C√ìMO VERIFICAR EN TRADINGVIEW:
======================================================================

1. Abre TradingView ‚Üí WOLF
2. Timeframe: 1 minuto (o tick chart si tienes premium)
3. Navega a: May 13, 2025
4. Zoom a la ventana: 09:30 - 09:31 ET

5. VERIFICA:
   ‚úì Primer precio ~$12.45 en 09:30:00
   ‚úì M√°ximo lleg√≥ a ~$12.67
   ‚úì M√≠nimo toc√≥ ~$12.42
   ‚úì √öltimo precio ~$12.65 en 09:31:23
   ‚úì Volumen acumulado entre 09:30 - 09:31
     debe ser ~16,125 shares (¬±5% tolerancia)

üè∑Ô∏è  LABEL ASOCIADA:
   Label: 1 (WIN)
   Return: 4.82%
   PT: 4.50% (profit target)
   SL: -3.00% (stop loss)
   T1: 11:31:23 ET (expiry)

   ‚Üí Verifica que precio subi√≥ 4.82% antes de 11:31

======================================================================
```

---

### **Ejemplo 2: Estad√≠sticas del D√≠a**

```bash
$ python verify_bar_tradingview.py WOLF 2025-05-13 --all-stats
```

**Output:**
```
======================================================================
üìä ESTAD√çSTICAS DEL D√çA: WOLF - 2025-05-13
======================================================================

üìà Resumen de Barras:
   Total barras: 47
   Imbalance promedio: $312,456.78
   Imbalance m√°ximo: $425,891.23
   Rango promedio: 1.85%
   Rango m√°ximo: 6.34%
   Volumen total d√≠a: 1,234,567 shares

üéØ Top 5 Barras por Imbalance:
   # 12 | 10:45:23 | $425,891.23 | Range:  3.21%
   #  8 | 10:12:45 | $398,234.56 | Range:  2.87%
   # 23 | 11:56:12 | $387,654.32 | Range:  1.98%
   # 34 | 13:23:45 | $365,123.45 | Range:  2.45%
   #  3 | 09:45:34 | $352,987.65 | Range:  1.76%

üìè Top 5 Barras por Rango (volatilidad):
   # 27 | 12:34:56 | $14.23‚Üí$15.13‚Üí$14.18 |  6.34%
   # 12 | 10:45:23 | $13.45‚Üí$13.88‚Üí$13.42 |  3.21%
   #  8 | 10:12:45 | $12.98‚Üí$13.35‚Üí$12.94 |  2.87%
   # 34 | 13:23:45 | $14.56‚Üí$14.91‚Üí$14.52 |  2.45%
   # 23 | 11:56:12 | $13.78‚Üí$14.05‚Üí$13.75 |  1.98%

üè∑Ô∏è  Resumen de Labels:
   Total labels: 47
   LOSS    :    28 ( 59.6%)
   TIMEOUT :     3 (  6.4%)
   WIN     :    16 ( 34.0%)

   Return promedio: -1.23%
   Return m√°ximo: 8.76%
   Return m√≠nimo: -5.43%

üèÜ Top 5 Labels por Retorno Absoluto:
   10:45:23 | WIN      |   8.76%
   12:34:56 | LOSS     |  -5.43%
   13:23:45 | WIN      |   4.82%
   09:45:34 | LOSS     |  -4.21%
   11:56:12 | WIN      |   3.98%

======================================================================
```

---

## üöÄ Workflow Recomendado

### **1. Verificaci√≥n Post-Pipeline (Daily)**

Despu√©s de ejecutar el pipeline cada d√≠a:

```bash
# Script de auditor√≠a diaria
#!/bin/bash

# Seleccionar 5 tickers aleatorios del d√≠a
TICKERS=($(ls processed/bars/ | shuf -n 5))
DATE=$(date -d "yesterday" +%Y-%m-%d)

for TICKER in "${TICKERS[@]}"; do
    echo "=== Auditando $TICKER ==="
    python verify_bar_tradingview.py $TICKER $DATE --all-stats
    python verify_bar_tradingview.py $TICKER $DATE --anomaly
done
```

---

### **2. Auditor√≠a Profunda (Weekly)**

Una vez por semana, auditar tickers espec√≠ficos con alta actividad:

```bash
# Lista de tickers m√°s activos (top 10 por volumen)
python verify_bar_tradingview.py WOLF 2025-05-13 --all-stats
python verify_bar_tradingview.py WOLF 2025-05-13 --top-label
python verify_bar_tradingview.py WOLF 2025-05-13 --largest-imbalance
python verify_bar_tradingview.py WOLF 2025-05-13 --anomaly
```

---

### **3. Investigaci√≥n de Incidentes**

Cuando certification checks fallan o encuentras datos sospechosos:

```bash
# 1. Ver contexto completo
python verify_bar_tradingview.py <TICKER> <DATE> --all-stats

# 2. Identificar anomal√≠as
python verify_bar_tradingview.py <TICKER> <DATE> --anomaly

# 3. Verificar barras espec√≠ficas manualmente
python verify_bar_tradingview.py <TICKER> <DATE> 0
python verify_bar_tradingview.py <TICKER> <DATE> 10
python verify_bar_tradingview.py <TICKER> <DATE> 20
```

---

## üìä Integraci√≥n con Jupyter Notebook

Para an√°lisis m√°s profundos, el script puede llamarse desde Jupyter:

```python
import subprocess
import json

def verify_bar(ticker, date, bar_index=0):
    """Llama al script CLI desde Jupyter"""
    cmd = f"python scripts/fase_E_DataAnalysis/verify_bar_tradingview.py {ticker} {date} {bar_index}"
    result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
    print(result.stdout)

# Uso
verify_bar("WOLF", "2025-05-13", 0)
verify_bar("WOLF", "2025-05-13", "--all-stats")
```

---

## üéØ Criterios de Validaci√≥n

Al verificar en TradingView, considera estos criterios:

| M√©trica | Tolerancia | Acci√≥n si excede |
|---------|-----------|------------------|
| **OHLC** | ¬±2% | Investigar feed source |
| **Timestamps** | ¬±100ms | Aceptable (latencia) |
| **Volumen** | ¬±5% | Investigar odd-lots filtering |
| **Labels** | Direcci√≥n correcta | Investigar volatilidad estimada |

‚úÖ **Criterio GO:**
- OHLC dentro de ¬±2%
- Volumen dentro de ¬±5%
- Label coincide con direcci√≥n del movimiento

‚ùå **Criterio NO-GO:**
- Diferencia > 10% en precio o volumen
- Label opuesta a movimiento real
- Timestamps desfasados > 1 segundo

---

## üîó Referencias

- [7.6_Verificacion_Manual_TradingView.md](../E_data_analisys/7.6_Verificacion_Manual_TradingView.md) - Documentaci√≥n completa del proceso
- [7.5_data_summary.md](../E_data_analisys/7.5_data_summary.md) - Suite de certificaci√≥n
- [verify_bar_tradingview.py](../../scripts/fase_E_DataAnalysis/verify_bar_tradingview.py) - Script source

---

## üìù Notas Importantes

### **Dependencias**

```bash
pip install polars pyarrow pytz
```

### **Timezones**

- **Pipeline:** UTC (microsegundos)
- **TradingView:** ET (Eastern Time)
- **Conversi√≥n:** Autom√°tica en el script

### **Market Hours**

```
Regular Trading Hours (ET):
  Pre-market:  04:00 - 09:30 ET
  Regular:     09:30 - 16:00 ET
  After-hours: 16:00 - 20:00 ET
```

### **Data Sources**

- **Pipeline:** Polygon.io (tick-level)
- **TradingView:** M√∫ltiples feeds (NYSE, NASDAQ, CQS/CTS)
- **Diferencias:** Peque√±as variaciones son normales

---

**√öltima actualizaci√≥n:** 2025-10-22
**Autor:** Data auditing tools
**Next steps:** Ejecutar auditor√≠a diaria y documentar resultados en 8.2_Resultados_Auditoria.md
