# 7.6 VerificaciÃ³n Manual de Eventos en TradingView

**Objetivo:** Comprobar que un evento (barra DIB, label, peso) en nuestro pipeline coincide con lo observable en TradingView.

---

## Por quÃ© es Importante

Cuando tienes un pipeline de datos automatizado, es crÃ­tico poder **auditar manualmente** eventos especÃ­ficos para:

1. **Validar timestamps:** Asegurar que las barras DIB se formaron en el momento correcto
2. **Verificar OHLC:** Confirmar que open/high/low/close coinciden con market data
3. **Auditar volumen:** Comprobar conservaciÃ³n de masa (trades â†’ bars)
4. **Validar labels:** Verificar que las predicciones triple barrier son correctas
5. **Debug:** Investigar anomalÃ­as o comportamientos inesperados

---

## Mapeo Temporal: Data Pipeline â†’ TradingView

### 1. **Identificar el Evento en tu Data**

Primero, lee el evento que quieres verificar:

```python
import polars as pl
from datetime import datetime

# Ejemplo: Verificar una barra DIB especÃ­fica
ticker = "WOLF"
date = "2025-05-13"

# Leer la barra
bars = pl.read_parquet(f"processed/bars/{ticker}/date={date}/dollar_imbalance.parquet")

# Ver la primera barra del dÃ­a
print(bars.head(1))

# Output ejemplo:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ t_open               â”‚ t_close              â”‚ open   â”‚ high   â”‚ low   â”‚ close  â”‚ cum_dollar_buy  â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ 2025-05-13 13:30:00  â”‚ 2025-05-13 13:31:23  â”‚ 12.45  â”‚ 12.67  â”‚ 12.42 â”‚ 12.65  â”‚ 315234.50       â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. **Convertir Timestamp a TradingView Time**

Las barras DIB tienen timestamps en **UTC** (microsegundos). TradingView usa tu zona horaria local (probablemente **ET - Eastern Time**).

```python
# Convertir timestamp a hora local ET (para NYSE/NASDAQ)
import pytz

def utc_to_et(utc_timestamp):
    """Convierte timestamp UTC (Î¼s) a ET para TradingView"""
    dt = datetime.fromtimestamp(utc_timestamp / 1_000_000, tz=pytz.UTC)
    et = dt.astimezone(pytz.timezone('US/Eastern'))
    return et.strftime('%Y-%m-%d %H:%M:%S %Z')

# Ejemplo con la barra anterior
t_open_us = 1715608200000000  # Microsegundos UTC
t_close_us = 1715608283000000

print(f"Open:  {utc_to_et(t_open_us)}")
print(f"Close: {utc_to_et(t_close_us)}")

# Output:
# Open:  2025-05-13 09:30:00 EDT  (mercado abre)
# Close: 2025-05-13 09:31:23 EDT  (barra DIB cerrÃ³)
```

---

### 3. **Verificar en TradingView**

Ahora ve a TradingView y verifica:

#### **A. Configurar el grÃ¡fico:**

1. Abre `WOLF` en TradingView
2. Selecciona **1 minuto** de timeframe (o tick-by-tick si tienes premium)
3. Ve a la fecha: **May 13, 2025**
4. Navega al horario: **9:30-9:32 AM ET**

#### **B. Comprobar OHLC:**

```
Tu data:    open=12.45, high=12.67, low=12.42, close=12.65
TradingView: Verifica que entre 9:30:00 y 9:31:23 ET:
  - El primer tick estÃ¡ cerca de $12.45
  - El mÃ¡ximo llegÃ³ a ~$12.67
  - El mÃ­nimo tocÃ³ ~$12.42
  - El Ãºltimo tick antes de 9:31:23 estÃ¡ en ~$12.65
```

#### **C. Comprobar Volumen:**

```python
# Tu barra tiene:
cum_volume_buy = 8234   # shares compradas
cum_volume_sell = 7891  # shares vendidas
total_volume = 16125    # shares totales

# En TradingView:
# Suma el volumen de todas las barras de 1min entre 9:30-9:31:23
# Debe ser ~16,125 shares (Â±2% de tolerancia por agregaciÃ³n)
```

---

## Script Completo de VerificaciÃ³n

AquÃ­ tienes un script que te genera el comando exacto para verificar:

```python
import polars as pl
from datetime import datetime
import pytz

def verify_bar_in_tradingview(ticker, date, bar_index=0):
    """
    Genera instrucciones para verificar una barra DIB en TradingView

    Args:
        ticker: sÃ­mbolo (ej: "WOLF")
        date: fecha YYYY-MM-DD (ej: "2025-05-13")
        bar_index: Ã­ndice de la barra a verificar (0 = primera del dÃ­a)
    """
    # Leer barra
    bars_path = f"processed/bars/{ticker}/date={date}/dollar_imbalance.parquet"
    bars = pl.read_parquet(bars_path)

    if len(bars) <= bar_index:
        print(f"âŒ Solo hay {len(bars)} barras ese dÃ­a")
        return

    bar = bars[bar_index]

    # Convertir timestamps
    et_tz = pytz.timezone('US/Eastern')
    t_open = datetime.fromtimestamp(bar['t_open'][0] / 1_000_000, tz=pytz.UTC).astimezone(et_tz)
    t_close = datetime.fromtimestamp(bar['t_close'][0] / 1_000_000, tz=pytz.UTC).astimezone(et_tz)

    # Calcular volumen total
    vol_buy = bar['cum_volume_buy'][0]
    vol_sell = bar['cum_volume_sell'][0]
    vol_total = vol_buy + vol_sell

    # Calcular dollar imbalance
    dol_buy = bar['cum_dollar_buy'][0]
    dol_sell = bar['cum_dollar_sell'][0]
    theta = bar['cum_theta'][0]

    print(f"\n{'='*70}")
    print(f"ğŸ“Š VERIFICACIÃ“N TRADINGVIEW: {ticker} - Barra #{bar_index}")
    print(f"{'='*70}\n")

    print(f"ğŸ“… Fecha: {date}")
    print(f"â° Ventana temporal (ET):")
    print(f"   Open:  {t_open.strftime('%H:%M:%S.%f')[:-3]} ET")
    print(f"   Close: {t_close.strftime('%H:%M:%S.%f')[:-3]} ET")
    print(f"   DuraciÃ³n: {(t_close - t_open).total_seconds():.1f} segundos\n")

    print(f"ğŸ’° OHLC:")
    print(f"   Open:  ${bar['open'][0]:.2f}")
    print(f"   High:  ${bar['high'][0]:.2f}")
    print(f"   Low:   ${bar['low'][0]:.2f}")
    print(f"   Close: ${bar['close'][0]:.2f}")
    print(f"   Range: ${bar['high'][0] - bar['low'][0]:.2f}\n")

    print(f"ğŸ“ˆ Volumen:")
    print(f"   Buy:   {vol_buy:,} shares (${dol_buy:,.2f})")
    print(f"   Sell:  {vol_sell:,} shares (${dol_sell:,.2f})")
    print(f"   Total: {vol_total:,} shares\n")

    print(f"ğŸ¯ Dollar Imbalance:")
    print(f"   Theta (Î£ sign): {theta:,.0f}")
    print(f"   Target: $300,000")
    print(f"   Actual: ${abs(dol_buy - dol_sell):,.2f}\n")

    print(f"{'='*70}")
    print(f"CÃ“MO VERIFICAR EN TRADINGVIEW:")
    print(f"{'='*70}\n")

    print(f"1. Abre TradingView â†’ {ticker}")
    print(f"2. Timeframe: 1 minuto (o tick chart si tienes premium)")
    print(f"3. Navega a: {t_open.strftime('%b %d, %Y')}")
    print(f"4. Zoom a la ventana: {t_open.strftime('%H:%M')} - {t_close.strftime('%H:%M')} ET\n")

    print(f"5. VERIFICA:")
    print(f"   âœ“ Primer precio ~${bar['open'][0]:.2f} en {t_open.strftime('%H:%M:%S')}")
    print(f"   âœ“ MÃ¡ximo llegÃ³ a ~${bar['high'][0]:.2f}")
    print(f"   âœ“ MÃ­nimo tocÃ³ ~${bar['low'][0]:.2f}")
    print(f"   âœ“ Ãšltimo precio ~${bar['close'][0]:.2f} en {t_close.strftime('%H:%M:%S')}")
    print(f"   âœ“ Volumen acumulado entre {t_open.strftime('%H:%M')} - {t_close.strftime('%H:%M')}")
    print(f"     debe ser ~{vol_total:,} shares (Â±5% tolerancia)\n")

    # Si hay label, mostrarla tambiÃ©n
    try:
        labels_path = f"processed/labels/{ticker}/date={date}/labels.parquet"
        labels = pl.read_parquet(labels_path)

        # Buscar label que coincida con t_close de esta barra
        matching = labels.filter(pl.col('anchor_ts') == bar['t_close'][0])

        if len(matching) > 0:
            lbl = matching[0]
            t1 = datetime.fromtimestamp(lbl['t1'][0] / 1_000_000, tz=pytz.UTC).astimezone(et_tz)

            print(f"ğŸ·ï¸  LABEL ASOCIADA:")
            print(f"   Label: {lbl['label'][0]} ({'WIN' if lbl['label'][0] == 1 else 'LOSS' if lbl['label'][0] == -1 else 'TIMEOUT'})")
            print(f"   Return: {lbl['ret'][0]:.2%}")
            print(f"   PT: {lbl['pt'][0]:.2%} (target)")
            print(f"   SL: {lbl['sl'][0]:.2%} (stop)")
            print(f"   T1: {t1.strftime('%H:%M:%S')} ET (expiry)\n")

            if lbl['label'][0] == 1:
                print(f"   â†’ Verifica que precio subiÃ³ {lbl['ret'][0]:.2%} antes de {t1.strftime('%H:%M')}")
            elif lbl['label'][0] == -1:
                print(f"   â†’ Verifica que precio bajÃ³ {abs(lbl['ret'][0]):.2%} antes de {t1.strftime('%H:%M')}")
    except:
        pass

    print(f"\n{'='*70}\n")

# USO
verify_bar_in_tradingview("WOLF", "2025-05-13", bar_index=0)
verify_bar_in_tradingview("WOLF", "2025-05-13", bar_index=10)  # Barra #10
```

---

## Output Ejemplo

```
======================================================================
ğŸ“Š VERIFICACIÃ“N TRADINGVIEW: WOLF - Barra #0
======================================================================

ğŸ“… Fecha: 2025-05-13
â° Ventana temporal (ET):
   Open:  09:30:00.041 ET
   Close: 09:31:23.167 ET
   DuraciÃ³n: 83.1 segundos

ğŸ’° OHLC:
   Open:  $12.45
   High:  $12.67
   Low:   $12.42
   Close: $12.65
   Range: $0.25

ğŸ“ˆ Volumen:
   Buy:   8,234 shares ($103,456.78)
   Sell:  7,891 shares ($98,912.34)
   Total: 16,125 shares

ğŸ¯ Dollar Imbalance:
   Theta (Î£ sign): 343
   Target: $300,000
   Actual: $304,544.44

======================================================================
CÃ“MO VERIFICAR EN TRADINGVIEW:
======================================================================

1. Abre TradingView â†’ WOLF
2. Timeframe: 1 minuto (o tick chart si tienes premium)
3. Navega a: May 13, 2025
4. Zoom a la ventana: 09:30 - 09:31 ET

5. VERIFICA:
   âœ“ Primer precio ~$12.45 en 09:30:00
   âœ“ MÃ¡ximo llegÃ³ a ~$12.67
   âœ“ MÃ­nimo tocÃ³ ~$12.42
   âœ“ Ãšltimo precio ~$12.65 en 09:31:23
   âœ“ Volumen acumulado entre 09:30 - 09:31
     debe ser ~16,125 shares (Â±5% tolerancia)

ğŸ·ï¸  LABEL ASOCIADA:
   Label: 1 (WIN)
   Return: 4.82%
   PT: 4.50% (target)
   SL: -3.00% (stop)
   T1: 11:31:23 ET (expiry)

   â†’ Verifica que precio subiÃ³ 4.82% antes de 11:31

======================================================================
```

---

## Tolerancias Esperadas

### Por quÃ© puede haber diferencias:

| Fuente | Diferencia Esperada | RazÃ³n |
|--------|---------------------|-------|
| **OHLC** | Â±$0.01-0.02 | Polygon vs TradingView usan feeds diferentes |
| **Timestamps** | Â±100ms | Latencia de ingest |
| **Volumen** | Â±2-5% | TradingView puede filtrar odd-lots o trades especiales |
| **Labels** | Â±10-20 bars | Volatilidad estimada (EMA) vs realized |

### Criterio de validaciÃ³n:

- âœ… **OHLC dentro de Â±2%** â†’ OK
- âœ… **Volumen dentro de Â±5%** â†’ OK
- âœ… **Label coincide con direcciÃ³n del movimiento** â†’ OK
- âŒ **Diferencia > 10% en precio o volumen** â†’ Investigar

---

## Casos de Uso Comunes

### 1. **Verificar que una barra DIB se formÃ³ correctamente**

```python
# Encontrar la barra mÃ¡s grande del dÃ­a (mayor imbalance)
bars = pl.read_parquet("processed/bars/WOLF/date=2025-05-13/dollar_imbalance.parquet")
bars = bars.with_columns(
    (pl.col('cum_dollar_buy') - pl.col('cum_dollar_sell')).abs().alias('imbalance')
)
max_idx = bars['imbalance'].arg_max()

verify_bar_in_tradingview("WOLF", "2025-05-13", bar_index=max_idx)
```

### 2. **Auditar una label especÃ­fica (WIN/LOSS)**

```python
# Encontrar labels con mayor retorno absoluto
labels = pl.read_parquet("processed/labels/WOLF/date=2025-05-13/labels.parquet")
labels = labels.with_columns(pl.col('ret').abs().alias('abs_ret'))
top_label = labels.sort('abs_ret', descending=True).head(1)

# Encontrar la barra que generÃ³ esa label
bars = pl.read_parquet("processed/bars/WOLF/date=2025-05-13/dollar_imbalance.parquet")
bar_idx = bars.with_row_count('idx').filter(
    pl.col('t_close') == top_label['anchor_ts'][0]
)['idx'][0]

verify_bar_in_tradingview("WOLF", "2025-05-13", bar_index=bar_idx)
```

### 3. **Investigar anomalÃ­as (precio/volumen extraÃ±o)**

```python
# Encontrar barras con rango de precio > 5%
bars = pl.read_parquet("processed/bars/WOLF/date=2025-05-13/dollar_imbalance.parquet")
bars = bars.with_columns(
    ((pl.col('high') - pl.col('low')) / pl.col('open')).alias('range_pct')
)
anomalies = bars.filter(pl.col('range_pct') > 0.05)

for idx in anomalies.with_row_count('idx')['idx'].to_list():
    verify_bar_in_tradingview("WOLF", "2025-05-13", bar_index=idx)
```

---

## Notas Importantes

### **Timestamps UTC vs ET**

- **Pipeline:** Todos los timestamps estÃ¡n en **UTC (microsegundos)**
- **TradingView:** Muestra en **ET (Eastern Time)** para NYSE/NASDAQ
- **ConversiÃ³n:** UTC - 4 horas (EDT) o UTC - 5 horas (EST)

### **Market Hours**

```
Regular Trading Hours (ET):
  Pre-market:  04:00 - 09:30 ET
  Regular:     09:30 - 16:00 ET
  After-hours: 16:00 - 20:00 ET

En UTC (EDT):
  Pre-market:  08:00 - 13:30 UTC
  Regular:     13:30 - 20:00 UTC
  After-hours: 20:00 - 00:00 UTC
```

### **Fuentes de Datos**

- **Tu pipeline:** Polygon.io API (tick-level data)
- **TradingView:** MÃºltiples feeds (NYSE, NASDAQ, CQS/CTS tapes)
- **Diferencias:** Normal tener pequeÃ±as variaciones por feed source

---

## InstalaciÃ³n de Dependencias

```bash
pip install polars pyarrow pytz
```

---

## Script Ejecutable

Guarda esto como `verify_bar_tradingview.py`:

```python
#!/usr/bin/env python3
"""
Script para verificar barras DIB en TradingView
Uso: python verify_bar_tradingview.py WOLF 2025-05-13 0
"""
import sys
import polars as pl
from datetime import datetime
import pytz

def verify_bar_in_tradingview(ticker, date, bar_index=0):
    # [CÃ³digo completo del script anterior]
    pass

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("Uso: python verify_bar_tradingview.py TICKER DATE [BAR_INDEX]")
        print("Ejemplo: python verify_bar_tradingview.py WOLF 2025-05-13 0")
        sys.exit(1)

    ticker = sys.argv[1]
    date = sys.argv[2]
    bar_index = int(sys.argv[3]) if len(sys.argv) > 3 else 0

    verify_bar_in_tradingview(ticker, date, bar_index)
```

Ejecutar:

```bash
python verify_bar_tradingview.py WOLF 2025-05-13 0
python verify_bar_tradingview.py WOLF 2025-05-13 10
```

---

## ConclusiÃ³n

Este workflow te permite **auditar manualmente** cualquier evento del pipeline contra TradingView para:

1. Validar que las barras DIB se formaron correctamente
2. Confirmar que los timestamps son precisos
3. Verificar conservaciÃ³n de volumen/dollar
4. Auditar que las labels coinciden con movimientos reales del precio

**RecomendaciÃ³n:** Ejecuta este tipo de verificaciones sobre una muestra aleatoria de ~10-20 eventos cada vez que modifiques el pipeline, para detectar regresiones temprano.

---

**Ãšltima actualizaciÃ³n:** 2025-10-22
**Autor:** Pipeline verification tools
