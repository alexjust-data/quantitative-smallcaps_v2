# ANALISIS COMPLETO: DATOS FALTANTES DE POLYGON PARA BBDD SMALLCAPS

**Fecha de analisis:** 2025-10-23
**Auditor:** Claude (Sonnet 4.5)
**Alcance:** Identificacion de datos faltantes en BBDD para completar pipeline ML Small Caps

---

## RESUMEN EJECUTIVO

Hemos analizado la BBDD actual vs. la API completa de Polygon.io. **Tenemos excelente cobertura de trading data** (OHLCV, trades, quotes), pero **faltan datos fundamentales y contextuales criticos** para estrategias de small-caps pump & dump segun el Playbook.

**Conclusion rapida:**
- [OK] **Market microstructure:** COMPLETO (trades, bars, labels, weights)
- [CRITICO] **Fundamentals:** FALTA (cash flow, balance sheet, income statement)
- [CRITICO] **Corporate events:** PARCIAL (tenemos splits/dividends, faltan offerings/delistings)
- [ALTA] **Short data:** FALTA (FINRA external source)
- [MEDIA] **SEC filings:** FALTA (S-3, 424B5, 8-K parsing)

---

## DATOS QUE YA TENEMOS (Bien cubiertos)

### **Market Data - Trading**

| Categoria | Endpoint Polygon | Periodo | Cobertura | Notas |
|-----------|------------------|---------|-----------|-------|
| **OHLCV Diario** | `/v2/aggs/.../1/day` | 2004-2025 | [OK] COMPLETO | 3,110 tickers, 21 anos |
| **OHLCV 1-minuto** | `/v2/aggs/.../1/minute` | 2004-2025 | [OK] COMPLETO | 3,110 tickers, mensual |
| **Trades (ticks)** | `/v3/trades/{ticker}` | 2020-2025 | [OK] COMPLETO | 11,054 ticker-days info-rich |
| **Quotes (BBO)** | `/v3/quotes/{ticker}` | - | [PARCIAL] | Disponible pero no descargado |

**Storage actual:** ~2.6 GB (trades raw) + processed ~1.4 GB = **~4 GB total**

---

### **Reference Data - Corporate Actions**

| Categoria | Endpoint Polygon | Periodo | Cobertura | Notas |
|-----------|------------------|---------|-----------|-------|
| **Dividends** | `/v3/reference/dividends` | 2000-2025 | [OK] COMPLETO | Particionado por ano |
| **Splits** | `/v3/reference/splits` | Historico completo | [OK] COMPLETO | Incluye reverse splits |
| **Ticker Details** | `/v3/reference/tickers/{ticker}` | Snapshot actual | [PARCIAL] | Solo snapshot, falta historico |

**Ubicacion:** `raw/polygon/reference/`

---

## DATOS FALTANTES CRITICOS

---

## [CRITICO] **1. FUNDAMENTALS - Estados Financieros**

### Por que es critico para la estrategia?

Segun el Playbook y documentos del proyecto:

> **"Operating cash flow negativo"** -> predictor #1 de dilucion inminente
> **"S-3, 424B, ATM, PIPEs activos"** -> necesitamos detectar deficits que fuerzan financiamiento
> **"Dilution traps"** -> solo detectables con balance sheet + cash burn rate

**Del documento `01_influencia_MarcosLopezDePadro.md`:**
> "Senales negativas: operating cash flow negativo (riesgo de financiacion/dilucion)"

**Del documento `00_1er_acercamiento_a_los_datos.md`:**
> "Cash Flow Operativo (TTM): Negativo o marginal" -> filtro critico del universo

**Sin estos datos NO podemos:**
- Predecir cuando un ticker va a diluir
- Calcular "cash runway" (meses hasta quiebra)
- Detectar empresas zombie (quemar $5M/quarter sin revenue)
- Filtrar por "riesgo de financiamiento"

---

### Endpoints de Polygon disponibles

#### **A. Financials API** (El mas importante)

```
/vX/reference/financials?ticker={TICKER}&timeframe=quarterly&limit=40
/vX/reference/financials?ticker={TICKER}&timeframe=annual&limit=20
```

**Datos disponibles:**

| Statement | Campos clave | Uso estrategico |
|-----------|--------------|-----------------|
| **Cash Flow Statement** | | |
| `net_cash_flow_from_operating_activities` | Operating Cash Flow | [***] Indicador #1 de salud |
| `net_cash_flow_from_financing_activities` | Financing Cash Flow | Detectar cuando estan diluyendo |
| `net_cash_flow_from_investing_activities` | Investing Cash Flow | - |
| `free_cash_flow` | FCF | = Operating - CapEx |
| **Balance Sheet** | | |
| `cash_and_cash_equivalents` | Cash disponible | Countdown to offering |
| `total_debt` | Deuda total | Presion financiera |
| `current_assets` | Activos corrientes | Liquidez |
| `current_liabilities` | Pasivos corrientes | Riesgo corto plazo |
| `stockholders_equity` | Equity | Base de dilucion |
| **Income Statement** | | |
| `revenues` | Ingresos | Growth vs. burn |
| `net_income` | Profit/Loss | Sustainability |
| `operating_expenses` | OpEx | Burn rate |
| `research_and_development_expenses` | R&D | Typical biotech burn |
| **Comprehensive Income** | | |
| `basic_earnings_per_share` | EPS | Dilution tracking |
| `diluted_earnings_per_share` | Diluted EPS | Post-dilution impact |
| `weighted_average_shares_outstanding` | Shares count | Dilucion historica |
| `weighted_average_shares_outstanding_diluted` | Diluted shares | Warrants/options impact |

---

### Features derivados para ML

Una vez descargados los fundamentals, podemos calcular:

```python
# 1. Cash Runway (meses hasta quedarse sin cash)
quarterly_burn = abs(operating_cash_flow)  # Si negativo
cash_runway_months = cash_and_equivalents / (quarterly_burn / 3)

# 2. Debt Ratios
debt_to_equity = total_debt / stockholders_equity
debt_to_assets = total_debt / total_assets

# 3. Dilution Rate
dilution_rate_yoy = (shares_outstanding_now - shares_outstanding_1y_ago) / shares_outstanding_1y_ago
dilution_rate_qoq = (shares_outstanding_now - shares_outstanding_1q_ago) / shares_outstanding_1q_ago

# 4. Burn Multiple (para biotechs/tech)
burn_multiple = cash_and_equivalents / abs(quarterly_operating_cash_flow)
# < 4 quarters = PELIGRO INMINENTE

# 5. Revenue Growth vs. Cash Burn
revenue_growth_rate = (revenue_now - revenue_4q_ago) / revenue_4q_ago
burn_to_revenue_ratio = abs(operating_cash_flow) / revenues
# Si burn crece mas rapido que revenue -> dilution incoming

# 6. Financing Activity Spikes
financing_flow_spike = financing_cash_flow_now > (3 * avg_financing_flow_4q)
# True = acaban de hacer offering
```

---

### Accion requerida

**Script a crear:** `scripts/download_polygon_financials.py`

```python
# Pseudocodigo
for ticker in info_rich_tickers:  # 1,906 tickers
    # Quarterly data (ultimos 5 anos = 20 quarters)
    response = polygon.get(f"/vX/reference/financials?ticker={ticker}&timeframe=quarterly&limit=20")
    save_parquet(f"raw/polygon/financials/{ticker}/quarterly/financials.parquet")

    # Annual data (ultimos 10 anos)
    response = polygon.get(f"/vX/reference/financials?ticker={ticker}&timeframe=annual&limit=10")
    save_parquet(f"raw/polygon/financials/{ticker}/annual/financials.parquet")
```

**Estimacion:**
- **Tickers:** 1,906
- **API calls:** 1,906 x 2 (quarterly + annual) = **3,812 calls**
- **Rate limit Polygon:** ~50-100 calls/min
- **Tiempo estimado:** 40-80 minutos
- **Storage:** ~500 MB (comprimido parquet)

**Output structure:**
```
raw/polygon/financials/
├── WOLF/
│   ├── quarterly/
│   │   └── financials.parquet  (20 rows, 1 row per quarter)
│   └── annual/
│       └── financials.parquet  (10 rows, 1 row per year)
├── AMC/
├── BTBT/
└── ... (1,906 tickers)
```

---

## [CRITICO] **2. TICKER EVENTS (Ofertas, Delistings, Name Changes)**

### Por que es critico?

Del Playbook:
> **"S-3, 424B activados"** -> Polygon los captura en `ticker_events`
> **"Reverse mergers y SPACs"** -> eventos de cambio de ticker/estructura
> **"Warrants"** -> dilution triggers
> **"OTC delisted"** -> muchas *supernovas* nacen en OTC y migran a NASDAQ antes del *pump*

**Del documento `01_fase1.md`:**
> "Reverse mergers y SPACs: cambian de ticker o estructura; si no descargas todo, los pierdes."

---

### Endpoint de Polygon

```
/v3/reference/tickers/{ticker}/events?types=offering,delisting,name_change,ticker_change
```

**Tipos de eventos disponibles:**

| Event Type | Descripcion | Relevancia para strategy |
|------------|-------------|-------------------------|
| `offering` | Ofertas publicas/privadas | [***] ATM, S-3, PIPE detection |
| `stock_split` | Splits/reverse splits | Ya tenemos en `/reference/splits` |
| `dividend` | Dividendos | Ya tenemos en `/reference/dividends` |
| `delisting` | Suspension del ticker | [**] Tracking quiebras |
| `name_change` | Cambio de nombre corporativo | [*] Mergers, rebranding |
| `ticker_change` | Cambio de simbolo | [**] Continuity tracking (CEI->VKIN) |
| `merger_acquisition` | M&A | [*] SPAC combinations |

---

### Features derivados para ML

```python
# Feature engineering desde events:

# 1. Tiempo desde ultimo offering
days_since_offering = (today - last_offering_date).days
# < 90 dias = periodo post-dilution (tipicamente bearish)

# 2. Frecuencia de offerings (proxy de "dilution machine")
offerings_last_12m = count(events where type='offering' and date > today - 365)
# > 3 offerings/ano = serial diluter

# 3. Ticker stability
ticker_changes_total = count(events where type='ticker_change')
# > 2 cambios = red flag (shell company, reverse merger)

# 4. Delisting risk
is_delisted = any(event.type == 'delisting' and event.date < today)
was_delisted_before = any(event.type == 'delisting' and event.date < today - 730)

# 5. Name change frequency (rebranding after disasters)
name_changes_5y = count(events where type='name_change' and date > today - 1825)
```

---

### Accion requerida

**Script a crear:** `scripts/download_polygon_ticker_events.py`

**Estimacion:**
- **Tickers:** 1,906
- **API calls:** 1,906 calls (1 por ticker)
- **Tiempo estimado:** 20-40 minutos
- **Storage:** ~50-100 MB

---

## [ALTA] **3. SHORT INTEREST & SHORT VOLUME**

### Por que es importante?

Del Playbook:
> **"SSR activations"** -> restricciones de short selling
> **"Short squeeze setups"** -> necesitamos % float short
> **"Frontside exhaustion"** -> medir covering vs. nuevos shorts entrando

---

### Limitacion de Polygon

[ADVERTENCIA] **Polygon NO tiene short interest directo en su API**

Los endpoints de agregados (`/v2/aggs`) incluyen:
- `volume` - Volumen total [OK]
- `open`, `high`, `low`, `close` [OK]
- Pero **NO** `short_volume` [FALTA]

---

### Fuente alternativa: FINRA (OBLIGATORIA)

**FINRA Short Sale Volume Data** (Gratuita, publica)

- **URL:** https://www.finra.org/finra-data/browse-catalog/short-sale-volume-data
- **Formato:** CSV files por dia
- **Cobertura:** 2004-presente
- **Frecuencia:** Diaria (T+1)

**Campos:**

| Campo | Tipo | Descripcion |
|-------|------|-------------|
| `Date` | Date | Trading day |
| `Symbol` | String | Ticker symbol |
| `ShortVolume` | Int64 | Total short sale volume |
| `ShortExemptVolume` | Int64 | Market maker exempt shorts |
| `TotalVolume` | Int64 | Total reported volume |
| `Market` | String | Exchange code (B=NASDAQ, Q=NYSE, etc.) |

---

### Features derivados

```python
# 1. Short Ratio (% del volumen que es short)
short_ratio = short_volume / total_volume
# Valores tipicos: 0.20-0.40 (20-40%)
# > 0.60 = heavily shorted (squeeze setup)

# 2. Short Intensity (vs. historico)
short_ratio_z_score = (short_ratio - mean(short_ratio_30d)) / std(short_ratio_30d)
# > 2.0 = anormalmente alto -> squeeze risk

# 3. Short Trend
short_ratio_ema5 = EMA(short_ratio, 5)
short_ratio_ema20 = EMA(short_ratio, 20)
short_trend = 'increasing' if short_ratio_ema5 > short_ratio_ema20 else 'decreasing'
# 'increasing' = mas shorts entrando (building pressure)
# 'decreasing' = covering (squeeze en progreso)
```

---

### Accion requerida

**Script a crear:** `scripts/download_finra_short_volume.py`

**Estimacion:**
- **Periodo:** 2020-01-01 to 2025-10-21 (~1,500 trading days)
- **Storage total:** 1,500 days x 0.5 MB = **~750 MB**
- **Tiempo estimado:** 3-5 horas (rate limiting manual, no API oficial)

---

## [MEDIA] **4. SEC EDGAR FILINGS**

### Por que es necesario?

**Polygon `ticker_events` te dice CUANDO hubo un offering**
**SEC EDGAR te dice QUE TIPO, CUANTAS SHARES, PRECIO, DILUTION %**

Del Playbook:
> **"S-3, 424B, ATM, PIPEs y warrants"** -> parsing de SEC necesario
> **"Presencia frecuente de S-3, 424B, ATM, PIPEs"** -> identificar antes del pump

---

### Filings criticos a parsear

| Filing Type | Descripcion | Timing | Uso estrategico |
|-------------|-------------|--------|-----------------|
| **S-3** | Shelf registration | Antes de offering | "Ability to dilute" (loaded gun) |
| **424B5** | Prospectus supplement | Day of offering | Offering executed (trigger pulled) |
| **8-K** | Material events | Same day | Halts, offerings, bad news |
| **10-Q** | Quarterly report | 45 days after quarter | Backup de Polygon financials |
| **10-K** | Annual report | 90 days after year end | Annual fundamentals |

---

### Desafio: Tickers vs. CIK

SEC usa **CIK numbers**, no tickers.

Ejemplo:
- Ticker: `WOLF`
- CIK: `0001566610`

**Necesitamos mapping:** `ticker -> CIK`

Polygon `ticker_details` incluye CIK:
```
/v3/reference/tickers/{ticker}
-> response includes: "cik": "0001566610"
```

---

### Estimacion

- **Tickers:** 1,906
- **Filings por ticker:** ~50-100 filings (ultimos 10 anos)
- **Total filings:** ~100,000-200,000 files
- **Storage HTML raw:** ~5-10 GB (completo)
- **Storage parsed:** ~100-200 MB (solo extracted fields)
- **Tiempo descarga:** 2-3 dias (rate limit 10 req/sec)
- **Tiempo parsing:** 4-6 horas

---

## RESUMEN DE PRIORIDADES

| # | Dataset | Prioridad | Fuente | Storage | Tiempo | Razon |
|---|---------|-----------|--------|---------|--------|-------|
| **1** | **Financials** | [CRITICO] | Polygon API | ~500 MB | 1-2h | Cash flow, dilution prediction |
| **2** | **Ticker Events** | [CRITICO] | Polygon API | ~100 MB | 30min | Offerings, delistings |
| **3** | **Short Volume** | [ALTA] | FINRA (external) | ~750 MB | 3-5h | Squeeze detection |
| **4** | **SEC Filings** | [MEDIA] | SEC EDGAR | ~2 GB | 2-3 dias | Offering details, 8-K |
| **5** | **Options** | [BAJA] | Polygon API | ~10 GB/year | - | Gamma squeezes (optional) |
| **6** | **Quotes (BBO)** | [BAJA] | Polygon API | ~1 TB | - | VPIN, microstructure (research) |

---

## PLAN DE ACCION (FASES)

### **FASE 1: FUNDAMENTALS & EVENTS (1 semana)** [CRITICO]

Completar analisis fundamental para prediccion de dilucion.

**Dia 1-2: Financials de Polygon**

Script: `scripts/download_polygon_financials.py`

```bash
python scripts/download_polygon_financials.py \
  --tickers processed/universe/info_rich/info_rich_tickers_20200101_20251021.csv \
  --outdir raw/polygon/financials \
  --timeframes quarterly annual \
  --lookback-years 10 \
  --workers 4 \
  --rate-limit 0.5
```

**Dia 3: Ticker Events**

Script: `scripts/download_polygon_ticker_events.py`

```bash
python scripts/download_polygon_ticker_events.py \
  --tickers processed/universe/info_rich/info_rich_tickers_20200101_20251021.csv \
  --outdir raw/polygon/events \
  --event-types offering delisting name_change ticker_change merger_acquisition \
  --workers 4 \
  --rate-limit 0.5
```

---

### **FASE 2: SHORT DATA (3-4 dias)** [ALTA]

Integrar short volume para deteccion de squeezes.

---

### **FASE 3: SEC FILINGS (2-3 semanas)** [MEDIA]

Parsing detallado de offerings para features avanzados.

---

## STORAGE FINAL ESTIMADO

| Dataset | Actual | Despues Fase 1-3 | Delta |
|---------|--------|------------------|-------|
| **Raw market data** | 2.6 GB | 2.6 GB | - |
| **Processed ML pipeline** | 1.4 GB | 1.6 GB | +200 MB |
| **Financials (Polygon)** | - | 500 MB | +500 MB |
| **Events (Polygon)** | - | 100 MB | +100 MB |
| **Short Volume (FINRA)** | - | 750 MB | +750 MB |
| **SEC EDGAR raw** | - | 2 GB | +2 GB |
| **SEC parsed** | - | 200 MB | +200 MB |
| **TOTAL** | **4.0 GB** | **7.65 GB** | **+3.65 GB** |

**Storage adicional requerido:** ~4 GB

---

## CONCLUSION

**TU BBDD ACTUAL (4 GB) ES EXCELENTE PARA:**
- [OK] Microestructura de mercado (trades, quotes, OHLCV 1m/1d)
- [OK] Dollar/Volume/Imbalance Bars construction
- [OK] Triple Barrier Labeling
- [OK] Sample Weights (uniqueness, time-decay)
- [OK] Patrones tecnicos (VWAP, gaps, momentum, RVOL)

**TE FALTA PARA COMPLETAR LA VISION DEL PLAYBOOK (~4 GB adicionales):**
- [CRITICO] **Fundamentals** (500 MB) -> cash burn, debt, shares outstanding
- [CRITICO] **Ticker Events** (100 MB) -> offerings, delistings, name changes
- [ALTA] **Short Volume** (750 MB) -> squeeze detection, SSR tracking
- [MEDIA] **SEC Filings** (2 GB raw + 200 MB parsed) -> offering details, 8-K events

**PRIORIDAD MAXIMA: FASE 1 (Fundamentals + Events)**

Razon: Sin operating cash flow y sin tracking de offerings, **no puedes predecir dilucion**, que es el core de tu estrategia small-caps segun el Playbook.

---

**Documento generado por:** Claude (Sonnet 4.5)
**Fecha:** 2025-10-23
**Version:** 1.0
**Proxima revision:** Despues de completar Fase 1
